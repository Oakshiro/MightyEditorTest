window.MT=createClass("MT"),MT.namespace("ui"),MT.extend("core.Emitter").extend("ui.DomElement")(MT.ui.ColorPalette=function(t){MT.ui.DomElement.call(this);var e=this;this.addClass("ui-colorpalette"),this.nodes=[],this.createPalette(),this.el.onclick=function(i){t&&i.target.color&&(t(i.target.color),e.emit("change",i.target.color))}},{createPalette:function(){for(var t=this.el,e=null,i=[16711680,16776960,65280,65535,255,16711935,16711680],s="",o=2,n=3,a=-n;n>a;a++)for(var h=0,a=(i.length-1)*o;a>h;h++)e=document.createElement("span"),e.className="ui-colorpalette-node",t.appendChild(e),s=this.mkColor(0,16777215,h/(a-1),0),e.color=s,e.style.backgroundColor=s;e=document.createElement("div"),t.appendChild(e),e.className="seperator";for(var h=0;h<i.length-1;h++)for(var l=0;o>l;l++)e=document.createElement("span"),e.className="ui-colorpalette-node",t.appendChild(e),s=this.mkColor(i[h],i[h+1],l/o,0),e.color=s,e.style.backgroundColor=s;e=document.createElement("div"),t.appendChild(e),e.className="seperator";for(var a=-n;n+1>a;a++)if(0!=a){for(var h=0;h<i.length-1;h++)for(var l=0;o>l;l++)e=document.createElement("span"),e.className="ui-colorpalette-node",t.appendChild(e),s=this.mkColor(i[h],i[h+1],l/(o+1),a/(1.8*n)),e.color=s,e.style.backgroundColor=s;e=document.createElement("div"),t.appendChild(e)}},mutate:function(t,e,i,s){var o=255,n=(t>>16)+o*s,a=(t>>8&255)+o*s,h=(255&t)+o*s,l=(e>>16)+o*s,r=(e>>8&255)+o*s,c=(255&e)+o*s,d=i*l+(1-i)*n|0,u=i*r+(1-i)*a|0,p=i*c+(1-i)*h|0,f=0;d>o&&(f=(d-o)/o,p=p+p*f|0,u=u+u*f|0,d=o),p>o&&(f=(p-o)/o,d=d+d*f|0,u=u+u*f|0,p=o),u>o&&(f=(u-o)/o,d=d+d*f|0,p=p+p*f|0,u=o),u>o&&(u=o),p>o&&(p=o),d>o&&(d=o),0>d&&(f=-d/o,p=p-p*f|0,u=u-u*f|0,d=0),0>p&&(f=-p/o,d=d-d*f|0,u=u-u*f|0,p=0),0>u&&(f=-u/o,d=d-d*f|0,p=p-p*f|0,u=0);var m=d.toString(16);m.length<2&&(m="0"+m);var g=u.toString(16);g.length<2&&(g="0"+g);var v=p.toString(16);return v.length<2&&(v="0"+v),"#"+m+g+v},mkColor:function(t,e,i,s){var o=this.mutate(t,e,i,s);return o}}),MT.namespace("core"),MT(MT.core.Color=function(t){this.setColor(t)},{_r:0,set r(t){this._r=r,this.calcHSL()},get r(){return this._r},_g:0,set g(t){this._g=t,this.calcHSL()},get g(){return this._g},_b:0,set b(t){this._b=t,this.calcHSL()},get b(){return this._b},_h:0,set h(t){this._h=t,this.calcRGB()},get h(){return this._h},_s:0,set s(t){this._s=t,this.calcRGB()},get s(){return this._s},_l:0,set l(t){this._l=t,this.calcRGB()},get l(){return this._l},a:0,hsl:function(){return"hsl("+this.h+","+this.s+","+this.l+")"},inherit:function(t){this._r=t.r,this._g=t.g,this._b=t.b,this.calcHSL()},setColor:function(t){t=t.trim();var e;"string"==typeof t&&("#"==t.substring(0,1)?4==t.length?(e=t.substring(1,2),this._r=parseInt(e+e,16),e=t.substring(2,3),this._g=parseInt(e+e,16),e=t.substring(3,4),this._b=parseInt(e+e,16),this.a=1):t.length>6&&(this._r=parseInt(t.substring(1,3),16),this._g=parseInt(t.substring(3,5),16),this._b=parseInt(t.substring(5,7),16),this.a=9===t.length?parseInt(t.substring(7,2),16):1):"rgba"==t.substring(0,4)?(e=t.substring(t.indexOf("(")+1,t.indexOf(")")).split(","),this._r=parseInt(e[0]),this._g=parseInt(e[1]),this._b=parseInt(e[2]),this.a=parseInt(e[3])):"rgb"==t.substring(0,3)&&(e=t.substring(t.indexOf("(")+1,t.indexOf(")")).split(","),this._r=parseInt(e[0]),this._g=parseInt(e[1]),this._b=parseInt(e[2]),this.a=1)),this.calcHSL()},setRGB:function(t,e,i){this._r=t,this._g=e,this._b=i,this.calcHSL()},setHSL:function(t,e,i){this._h=t,this._s=i,this._l=i,this.calcHSL()},_hue2rgb:function(t,e,i){return 0>i&&(i+=1),i>1&&(i-=1),1/6>i?t+6*(e-t)*i:.5>i?e:2/3>i?t+(e-t)*(2/3-i)*6:t},valueOf:function(){return this.a<1?this.rgba():this.hex()},hex:function(){var t=this.r.toString(16),e=this.g.toString(16),i=this.b.toString(16);return t.length<2&&(t="0"+t),e.length<2&&(e="0"+e),i.length<2&&(i="0"+i),"#"+t+e+i},rgba:function(){return"rgba("+this._r+","+this._g+","+this._b+","+this.a+")"},rgb:function(){return"rgb("+this._r+","+this._g+","+this._b+")"},calcRGB:function(){var t,e,i,s=this._h,o=this._s,n=this._l;if(0==this.s)t=e=i=n;else{var a=.5>n?n*(1+o):n+o-n*o,h=2*n-a;t=this._hue2rgb(h,a,s+1/3),e=this._hue2rgb(h,a,s),i=this._hue2rgb(h,a,s-1/3)}this._r=Math.floor(255*t),this._g=Math.floor(255*e),this._b=Math.floor(255*i)},calcHSL:function(){var t,e,i=this.r/255,s=this.g/255,o=this.b/255,n=Math.max(i,s,o),a=Math.min(i,s,o),h=(n+a)/2;if(n==a)t=e=0;else{var l=n-a;switch(e=h>.5?l/(2-n-a):l/(n+a),n){case i:t=(s-o)/l+(o>s?6:0);break;case s:t=(o-i)/l+2;break;case o:t=(i-s)/l+4}t/=6}this._h=t,this._s=e,this._l=h}}),MT.namespace("ui"),MT(MT.ui.SliderHelper=function(t,e,i){this.min=e||0,this.max=i||100,this.value=t,this._value=0},{change:function(t){this._value+=t,this._value>=this.min&&this._value<=this.max?this.value=this._value:this._value>this.max?this.value=this.max:this._value<this.min&&(this.value=this.min)},valueOf:function(){return this.value},reset:function(t){void 0!=t?(this._value=t,this.value=t):this._value=this.value}}),MT.namespace("core"),MT(MT.core.BasicTool=function(t){this.tools=t,this.project=t.project},{initUI:function(t){var e=this;this.ui=t,this.tooltip=this.getTooltip(),this.button=this.tools.panel.addButton("","tool."+this.name,function(){e.tools.setTool(e)},this.tooltip)},showInfoToolTip:function(t,e){t=t||0;var i=this.tools.project.plugins;i.notification.showToolTips(this,t,e)},getTooltip:function(t){var e=(this.name||t)+"Tool";return e},init:function(){console.log("TODO: init"),this.activate()},activate:function(){},select:function(t){console.log("TODO: select",t)},mouseDown:function(){console.log("TODO: mousedown")},mouseUp:function(){console.log("TODO: mouseup")},mouseMove:function(){console.log("TODO: mouse move")},deactivate:function(){console.log("TODO: deactivate"),this.deinit()},deinit:function(){}}),MT.namespace("ui"),MT.require("ui.Button"),MT.require("ui.Input"),MT.require("ui.ColorPalette"),MT.extend("core.Emitter").extend("ui.Panel")(MT.ui.TextColorPicker=function(t){var e=this;this.data={stroke:"#000000",fill:"#000000",shadow:"#000000"},MT.ui.Panel.call(this,"",t.events),this.ui=t,this.fill=new MT.ui.Button("Fill","ui-text-colorpicker-fill",null,function(){e.select("fill")}),this.fill.width="auto",this.stroke=new MT.ui.Button("Stroke","ui-text-colorpicker-stroke",null,function(){e.select("stroke")}),this.stroke.width="auto",this.shadow=new MT.ui.Button("Shadow","ui-text-colorpicker-shadow",null,function(){e.select("shadow")}),this.shadow.width="auto",this.addButton(this.fill),this.addButton(this.stroke),this.addButton(this.shadow),this.addClass("ui-text-colorpicker"),this.width=252,this.height=280,this.colorPalette=new MT.ui.ColorPalette(function(t){e.change(t)}),this.colorPalette.show(),this.colorPalette.on("hover",function(t){e.colorInput.setValue(t,!0)}),this.content.addChild(this.colorPalette),this.colorPalette.y=25,this.colorPalette.height=190,this.color="#000000",this.colorInput=new MT.ui.Input(t,{key:"color",type:"color"},this),this.colorInput.style.top="auto",this.colorInput.style.bottom="70px",this.colorInput.on("change",function(t){e.change(t)}),this.addChild(this.colorInput).show(),this.strokeThickness=0,this.strokeThicknessInput=new MT.ui.Input(t,{key:"strokeThickness",min:0,step:1},this),this.strokeThicknessInput.style.top="auto",this.strokeThicknessInput.style.bottom="50px",this.strokeThicknessInput.on("change",function(){e.change()}),this.shadowX=0,this.shadowXInput=new MT.ui.Input(t,{key:"shadowX",step:1},this),this.shadowXInput.style.top="auto",this.shadowXInput.style.bottom="50px",this.shadowXInput.on("change",function(){e.change()}),this.shadowY=0,this.shadowYInput=new MT.ui.Input(t,{key:"shadowY",step:1},this),this.shadowYInput.style.top="auto",this.shadowYInput.style.bottom="30px",this.shadowYInput.on("change",function(){e.change()}),this.shadowBlur=0,this.shadowBlurInput=new MT.ui.Input(t,{key:"shadowBlur",min:0,step:1},this),this.shadowBlurInput.style.top="auto",this.shadowBlurInput.style.bottom="10px",this.shadowBlurInput.on("change",function(){e.change()}),this.select("fill")},{setColors:function(t){this.colorInput.setValue(t[this.active],!0),this.data=t},change:function(t){t&&(this.colorInput.setValue(t),this.data[this.active]=t),this.color=this.data[this.active],this[this.active+"_change"]()},select:function(t){this.active&&(this[this.active].removeClass("active"),this[this.active+"_deselect"]()),this.active=t,this[t].addClass("active"),this[t+"_select"]()},fill_select:function(){this.colorInput.setValue(this.data.fill,!0)},fill_deselect:function(){},fill_change:function(){this.emit("fill",this.color)},stroke_select:function(){this.colorInput.setValue(this.data.stroke,!0),this.addChild(this.strokeThicknessInput).show()},stroke_deselect:function(){this.removeChild(this.strokeThicknessInput)},stroke_change:function(){this.emit("stroke",{color:this.color,strokeThickness:this.strokeThickness})},shadow_select:function(){this.colorInput.setValue(this.data.shadow,!0),this.addChild(this.shadowXInput).show(),this.addChild(this.shadowYInput).show(),this.addChild(this.shadowBlurInput).show()},shadow_deselect:function(){this.removeChild(this.shadowXInput),this.removeChild(this.shadowYInput),this.removeChild(this.shadowBlurInput)},shadow_change:function(){this.emit("shadow",{color:this.color,shadowBlur:this.shadowBlur,x:this.shadowX,y:this.shadowY})}}),MT.namespace("ui"),MT.require("ui.List"),MT.require("ui.Button"),MT.extend("core.Emitter")(MT.ui.Dropdown=function(t,e){this.options=t||{};var i=this,s=this.input=document.createElement("input");s.setAttribute("type","text"),s.className="ui-input ui-input-helper",s.onkeyup=function(e){if(e.which==MT.keys.ENTER){a.text=""!=this.value?this.value:this.oldValue;try{this.parentNode&&this.parentNode.removeChild(this)}catch(e){window.getSelection().removeAllRanges()}i.emit("change",a.text),t.onchange&&(i.hide(),t.onchange(a.text))}};var o=function(t){t.stopPropagation()};s.onmouseup=o,s.onmousedown=o,s.onclick=o;var n=null;t.list?(this.listSource="object"!=typeof t.list[0]?this.mkList(t.list):t.list,n=this.list=new MT.ui.List(this.listSource,e,!0),n.addClass("ui-dropdown-list"),n.panel.content.style.position="relative",n.on("show",function(){var e=a.el.getBoundingClientRect();n.style.top=e.top+e.height+"px",n.style.left=e.left+"px",n.el.offsetTop+n.panel.content.el.offsetHeight>window.innerHeight&&(n.style.top=e.top-n.panel.content.el.offsetHeight+"px"),t.listStyle&&(n.width=t.listStyle.width)}),n.on("hide",function(){i.hide()})):s.onblur=function(){i.hide()};var a=this.button=new MT.ui.Button(null,t.button.class,e.events,function(){document.body.appendChild(s),n&&n.show(document.body);var t=a.el.getBoundingClientRect();s.style.top=t.top+"px",s.style.left=t.left+"px",s.style.width=t.width+"px",s.oldValue=a.text,s.value=a.text,a.text="",s.focus(),i.emit("show")});t.button.width&&(a.width=t.button.width),t.value&&(a.text=t.value)},{mkList:function(t){for(var e=[],i=0;i<t.length;i++)e.push(this.mkListItem(t[i]));return e},mkListItem:function(t){var e=this;return{label:t,cb:function(){e.value=t,e.emit("change",t)}}},set value(t){this.list.isVisible||(this.button.text=t),this.input.value=t},get value(){return this.button.text},addItem:function(t){this.list.addItem(t)},show:function(){this.emit("show")},hide:function(){this.emit("hide"),this.list&&this.list.hide(),this.input.parentNode&&this.input.parentNode.removeChild(this.input),this.button.text=this.input.value||this.input.oldValue}}),MT.namespace("ui"),MT.require("ui.SliderHelper"),MT.require("core.Color"),MT.extend("core.Emitter")(MT.ui.ColorPicker=function(t){this.ui=t,this.canvas=document.createElement("canvas"),this.canvas.width=230,this.canvas.height=200,this.canvas.style.margin="5px",this.ctx=this.canvas.getContext("2d"),this.cache=document.createElement("canvas"),this.cache.width=1,this.cacheCtx=this.cache.getContext("2d"),this.updateCache(),this.pickOffset=30,this.isBase=!1;var e=this,i=!1;this.panel=t.createPanel("color"),this.panel.setFree(),this.panel.content.el.appendChild(this.canvas),this.preview=document.createElement("div"),this.preview.style.width="20%",this.preview.style.height="20px",this.preview.style.marginLeft="5px",this.preview.style.float="left",this.preview.style.border="solid 1px rgba(0,0,0,0.5)",this.panel.content.el.appendChild(this.preview),this.text=document.createElement("span"),this.text.style.width="20%",this.text.style.height="20px",this.text.style.lineHeight="19px",this.text.style.marginLeft="5px",this.text.style.float="left",this.panel.content.el.appendChild(this.text),this.color=new MT.core.Color("#f00"),this.baseColor=new MT.core.Color("#f00"),this.drawSide(),this.drawBase("#F00"),this.input=document.createElement("input"),this.panel.el.appendChild(this.input),this.panel.width=this.canvas.width+2+10,this.panel.on("resize",function(){e.resize()}),this.baseHandle=new MT.ui.SliderHelper(0,0,this.canvas.height-1),this.handleX=new MT.ui.SliderHelper(0,0,this.canvas.width-this.pickOffset-1),this.handleY=new MT.ui.SliderHelper(0,0,this.canvas.height-1),t.events.on(t.events.MOUSEDOWN,function(t){return e.panel.vsPoint(t)?void(t.target===e.canvas&&(t.offsetX>e.canvas.width-e.pickOffset?(e.isBase=!0,e.baseHandle.reset(t.offsetY)):(e.handleX.reset(t.offsetX),e.handleY.reset(t.offsetY)),i=!0,t.preventDefault(),t.stopPropagation(),e.input.focus(),e.getColor(t.offsetX,t.offsetY))):(e.emit("change",e.color.valueOf()),void e.hide())});t.events.on(t.events.MOUSEMOVE,function(s){i&&(s.preventDefault(),s.stopPropagation(),e.isBase?(e.baseHandle.change(t.events.mouse.my),e.getColor(e.canvas.width-.5*e.pickOffset,e.baseHandle.value)):(e.handleX.change(t.events.mouse.mx),e.handleY.change(t.events.mouse.my),e.getColor(e.handleX.value,e.handleY.value)),e.input.focus())}),t.events.on(t.events.MOUSEUP,function(){i=!1,e.isBase=!1,e.baseHandle.reset(),e.handleX.reset(),e.handleY.reset(),e.input.focus()}),e.input.onkeyup=function(t){return t.stopPropagation(),t.preventDefault(),t.which==MT.keys.ESC?(e.emit("change",e.startColor),e.setColor(e.startColor),void e.hide()):void(t.which==MT.keys.ENTER&&(e.emit("change",e.color.valueOf()),e.hide()))},this.panel.width=300,this.panel.height=200},{resize:function(){this.canvas.width=this.panel.width-12,this.canvas.height=this.panel.height-40-20,this.baseHandle.max=this.canvas.height-1,this.handleX.max=this.canvas.width-this.pickOffset-1,this.handleY.max=this.canvas.height-1,this._gradients.white=null,this._gradients.black=null,this.updateCache(),this.update()},getColor:function(){var t=null;this.isBase&&(t=this.cacheCtx.getImageData(0,this.baseHandle.value,1,1).data,this.baseColor.setRGB(t[0],t[1],t[2])),this.redraw(),t=this.ctx.getImageData(this.handleX.value,this.handleY.value,1,1).data,this.color.setRGB(t[0],t[1],t[2]),this.drawHandles(),this.preview.style.backgroundColor=this.color.valueOf(),this.text.innerHTML=this.color.valueOf(),this.emit("change",this.color.valueOf())},startColor:null,setColor:function(t){t=t||"#333",this.startColor=t,this.preview.style.backgroundColor=t,this.color.setColor(t),this.baseColor.inherit(this.color),this.baseColor.s=1,this.baseColor.l=.5,this.update()},update:function(){this.redraw(),this.baseHandle.reset(Math.floor((1-this.baseColor.h)*this.canvas.height));for(var t=2,e=this.ctx.getImageData(0,0,this.canvas.width-this.pickOffset,this.canvas.height).data,i=0;i<e.length;i+=4)if(Math.abs(e[i]-this.color.r)<t&&Math.abs(e[i+1]-this.color.g)<t&&Math.abs(e[i+2]-this.color.b)<t){if(Math.abs(e[i+4]-this.color.r)<t-1&&Math.abs(e[i+1+4]-this.color.g)<t-1&&Math.abs(e[i+2+4]-this.color.b)<t-1&&(t--,t>0))continue;this.handleX.reset(i/4%(this.canvas.width-this.pickOffset)),this.handleY.reset(Math.floor(i/4/(this.canvas.width-this.pickOffset)));break}this.drawHandles(),this.preview.style.backgroundColor=this.color.valueOf(),this.text.innerHTML=this.color.valueOf()},updateCache:function(){this.cache.height=this.canvas.height,this.drawSide(this.cacheCtx)},redraw:function(){this.drawSide(),this.drawBase(),this.drawGradient()},drawBase:function(){var t=this.canvas,e=this.ctx;e.fillStyle=this.baseColor.valueOf(),e.fillRect(0,0,t.width-this.pickOffset,t.height)},drawSide:function(t){t=t||this.ctx;var e=t.canvas;t.clearRect(0,0,e.width,e.height);var i=t.createLinearGradient(0,0,0,e.height);i.addColorStop(.01,"#F00"),i.addColorStop(.166,"#F0F"),i.addColorStop(.3333,"#00F"),i.addColorStop(.5,"#0FF"),i.addColorStop(.666,"#0F0"),i.addColorStop(.833,"#FF0"),i.addColorStop(1,"#F00"),t.fillStyle=i,t==this.ctx?t.fillRect(e.width-27,0,26,e.height):t.fillRect(0,0,e.width,e.height)},_gradients:{white:null,black:null},drawGradient:function(){var t=this.canvas,e=this.ctx;this._gradients.white||(this._gradients.white=e.createLinearGradient(0,0,t.width-30,0),this._gradients.white.addColorStop(.01,"rgba(255,255,255,1)"),this._gradients.white.addColorStop(.99,"rgba(255,255,255,0)"),this._gradients.black=e.createLinearGradient(0,0,0,t.height),this._gradients.black.addColorStop(.01,"rgba(0,0,0,0)"),this._gradients.black.addColorStop(.99,"rgba(0,0,0,1)")),e.fillStyle=this._gradients.white,e.fillRect(0,0,t.width-this.pickOffset,t.height),e.fillStyle=this._gradients.black,e.fillRect(0,0,t.width-this.pickOffset,t.height)},drawHandles:function(){this.ctx.strokeStyle="#000",this.ctx.strokeRect(this.canvas.width-29.5,this.baseHandle-2.5,29,4),this.ctx.beginPath(),this.ctx.arc(this.handleX+.5,this.handleY+.5,3,0,2*Math.PI),this.ctx.stroke(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.5)",this.ctx.strokeWidth=.5,this.ctx.beginPath(),this.ctx.arc(this.handleX+.5,this.handleY+.5,2,0,2*Math.PI),this.ctx.stroke()},show:function(){this.panel.style.zIndex=10*this.ui.zIndex+9999,this.panel.show(),this.input.focus()},hide:function(){this.panel.hide(),this.input.blur(),this.off()}}),MT.namespace("ui"),MT.require("core.keys"),MT.extend("core.Emitter")(MT.ui.InputHelper=function(){var t=document.createElement("input");t.style.position="absolute",t.type="text",t.className="ui-input",t.isVisible=!1,t.style.textAlign="right",t.style.paddingRight="10px";var e=this;t.onblur=function(){e.emit("blur",t.value);var i=t.parentElement;i&&i.removeChild(t),e.el.style.visibility=""},t.onkeyup=function(i){var s=i.which;return console.log(s),s==MT.keys.ESC?void t.blur():(s==MT.keys.ENTER&&(t.blur(),e.emit("enter",i)),e.emit("change",t.value),void e.inheritStyle())},t.onkeydown=function(t){var i=t.which;i==MT.keys.TAB&&(t.preventDefault(),t.stopPropagation(),e.emit("tab",t))},this.input=t},{show:function(t,e){this.el&&(this.el.style.visibility="",this.el=null),void 0==e&&(e=t.innerHTML),this.el=t,this.inheritStyle(),this.input.value=e,t.style.visibility="hidden",document.body.appendChild(this.input),this.input.focus(),this.input.setSelectionRange(0,this.input.value.length)},blur:function(){this.input.blur()},inheritStyle:function(){var t=this.el.getBoundingClientRect();console.log(t);var e=window.getComputedStyle(this.el);for(var i in e)this.input.style[i]=e[i];this.input.style.zIndex=1e4,this.input.style.position="absolute",this.input.style.visibility="visible",this.input.style.top=t.top+"px",this.input.style.left=t.left+"px",this.input.style.width=t.width+1+"px",this.input.style.height=t.height+1+"px",this.input.style.paddingBottom="1px",this.input.style.paddingRight="1px"}}),MT.namespace("plugins.tools"),MT.extend("core.BasicTool")(MT.plugins.tools.Physics=function(t){this.tools=t,this.enabled=!1,this.name="physics"},{initUI:function(){var t=this;this.button=this.tools.panel.addButton("","tool.physics",function(){t.enabled?(t.enabled=!1,t.button.removeClass("active"),t.tools.project.plugins.mapeditor.disablePhysics()):(t.button.addClass("active"),t.enabled=!0,t.tools.project.plugins.mapeditor.enablePhysics())},this.getTooltip())}}),MT.namespace("plugins.tools"),MT.extend("core.BasicTool").extend("core.Emitter")(MT.plugins.tools.TileTool=function(t){MT.core.BasicTool.call(this,t),this.name="tileTools",this.active=null,this.activePanel=null,window.tileTool=this,this.panels={}},{initUI:function(t){MT.core.BasicTool.initUI.call(this,t),this.panel=this.tools.project.plugins.assetmanager.preview,this.selection=new MT.core.Selector,this.start=0,this.stop=0;var e=this;this.tools.on(MT.OBJECT_SELECTED,function(t){t&&t.type==MT.objectTypes.TILE_LAYER&&e._select(t)}),this.tools.on(MT.OBJECT_UNSELECTED,function(){e.tools.activeTool==e&&e.unselect()}),this.tools.on(MT.ASSET_FRAME_CHANGED,function(t){e.tools.activeTool==e&&(e.panels[t.id]||e.update(),e.activePanel=e.panels[t.id],e.activePanel.show())}),this.tools.map.on(MT.MAP_OBECTS_ADDED,function(t){e.tools.activeTool==e&&t.activeObject&&(e.select(t.activeObject),e.update())})},getImageFn:function(t){return function(){return t}},createPanels:function(t){var e,i,s=(this.active.data,null);for(var o in t)if(this.panels[o]){if(!map)continue;s=t[o],e=this.panels[o]}else e=this.addPanel(t[o],o),i&&e.addJoint(i),i=e;i&&(this.activePanel=i,i.show(this.panel.content.el))},addPanel:function(t,e){var i=new MT.ui.Panel(t.name);i.fitIn(),i.addClass("borderless"),this.createImage(i,t),this.panels[e]=i;var s=this;return i.on("show",function(){s.stop=s.getTile(0,0,i.data.image,i.data.data),s.activePanel=i}),i},createImage:function(t,e){var i=this,s=new Image;s.onload=function(){i.addCanvas(t,this),i.drawImage(t,this)},s.src=this.tools.project.path+"/"+e.__image,t.data={data:e,id:e.id,image:s,canvas:null,ctx:null}},addImage:function(t){for(var e=this.active.tilemap,i=0;i<e.tilesets.length;i++)if(e.tilesets[i].name==t.id)return e.tilesets[i].firstgid;for(var s=0,i=0;i<e.tilesets.length;i++)s+=e.tilesets[i].total+1;{var o=""+t.data.id;e.addTilesetImage(o,o,t.data.frameWidth,t.data.frameHeight,0,0,s)}return this.active.data.images||(this.active.data.images=[]),this.active.data.images.push(t.id),s},addCanvas:function(t,e){{var i=document.createElement("canvas"),s=i.getContext("2d");this.active.tilemap}i.width=e.width,i.height=e.height,t.data.canvas=i,t.data.ctx=s;var o=t.data.data;t.data.widthInTiles=e.width/o.frameWidth|0,t.data.heightInTiles=e.height/o.frameHeight|0;var n=!1,a=this;i.onmousedown=function(e){n=!0;var i=a.getTile(e.offsetX,e.offsetY,t.data.image,t.data.data);a.start=i,a.stop=i,a.drawImage(t)},i.onmousemove=function(e){if(n){var i=a.getTile(e.offsetX,e.offsetY,t.data.image,t.data.data);a.stop=i,a.drawImage(t)}},i.onmouseup=function(e){n=!1,a.stop=a.getTile(e.offsetX,e.offsetY,t.data.image,t.data.data),a.activePanel=t},t.content.el.appendChild(i)},addSelection:function(t){this.selection.add(t)},selectAdditionalTiles:function(){this.selection.min,this.selection.max},drawImage:function(t){var e=this,i=t.data.image,s=t.data.ctx;if(null!=s){var o,n,a=t.data.data,h=t.data.widthInTiles;s.clearRect(0,0,i.width,i.height),s.drawImage(i,0,0,i.width,i.height);{this.active.tilemap}s.beginPath();for(var l=a.frameWidth;l<i.width;l+=a.frameWidth+a.spacing)s.moveTo(a.margin+l+.5,a.margin),s.lineTo(l+.5,i.height);for(var l=a.frameHeight;l<i.height;l+=a.frameHeight+a.spacing)s.moveTo(a.margin+0,a.margin+l+.5),s.lineTo(i.width,l+.5);if(s.stroke(),s.fillStyle="rgba(0,0,0,0.5)",o=e.getTileX(this.start,h),n=e.getTileY(this.start,h),this.selection.clear(),this.start==this.stop)s.fillRect(a.margin+a.frameWidth*o+o*a.spacing+.5,a.margin+a.frameHeight*n+n*a.spacing+.5,a.frameWidth+.5,a.frameHeight+.5),this.selection.add({x:o,y:n,dx:0,dy:0});else{var r=e.getTileX(this.stop,h),c=e.getTileY(this.stop,h),d=Math.min(o,r),u=Math.min(n,c);r=Math.max(o,r),c=Math.max(n,c);for(var l=d;r>=l;l++)for(var p=u;c>=p;p++)s.fillRect(a.margin+a.frameWidth*l+l*a.spacing+.5,a.frameHeight*p+p*a.spacing+.5,a.frameWidth+.5,a.frameHeight+.5),this.selection.add({x:l,y:p,dx:l-d,dy:p-u})}}},getTileX:function(t,e){return t%e},getTileY:function(t,e){return t/e|0},getSelection:function(t,e){var i=t.data.image;return this.getTile(e.offsetX,e.offsetY,i,t.data.data)},getTile:function(t,e,i,s){var o=(t+s.margin-s.spacing)/(s.frameWidth+s.spacing)|0,n=(e+s.margin-s.spacing)/(s.frameHeight+s.spacing)|0;return this.getId(o,n,i,s)},getId:function(t,e,i,s){var o=e*((i.width+s.spacing)/(s.frameWidth+s.spacing)),n=t+o|0;return n},mouseUp:function(t){t.target==this.tools.map.game.canvas&&(this.mDown=!1)},mouseDown:function(t){this.mDown=!0,this.putTileFromMouse(t)},mouseMove:function(t){this.mDown&&this.putTileFromMouse(t)},putTileFromMouse:function(t){if(t.target==this.tools.map.game.canvas){var e=this,i=this.active,s=(this.active.tilemap,this.tools.map.game.camera.scale.x),o=0,n=0;if(this.active&&this.active.game){var a=this.active.getBounds();if(a.contains(t.x-this.tools.map.ox,t.y-this.tools.map.oy)){this.active.fixedToCamera?(o=(t.x-this.active.x+this.tools.map.game.camera.x-this.tools.map.ox)/s,n=(t.y-this.active.y+this.tools.map.game.camera.y-this.tools.map.oy)/s):(o=(t.x-this.active.x-this.tools.map.offsetX)/s,n=(t.y-this.active.y-this.tools.map.offsetY)/s);var h=this.active.getTileXY(o,n,{});if(t.ctrlKey)return void e.putTile(null,h.x,h.y,i);if(this.activePanel){var l=this.addImage(this.activePanel.data),r=0;this.selection.forEach(function(t){r=e.getId(t.x,t.y,e.activePanel.data.image,e.activePanel.data.data),e.putTile(l+r,h.x+t.dx,h.y+t.dy,i)})}}}}},putTile:function(t,e,i,s){s.data.tiles||(s.data.tiles={}),s.data.tiles[i]||(s.data.tiles[i]={}),s.data.tiles[i][e]=t,s.putTile(t,e,i)},oldSettings:{},init:function(){return this.active=this.tools.map.activeObject,this.active?(this.adjustSettings(this.active.data),this.panel.content.clear(),this.update(),this.panel.show(),void(this.activePanel&&(this.activePanel.hide(),this.activePanel.show()))):(this.tools.setTool(this.tools.tools.select,!0),this.showInfoToolTip(0,!0),void console.warn("not tilelayer selected!!!"))},restore:function(){this.oldSettings.gridX&&(this.tools.map.settings.gridX=this.oldSettings.gridX,this.tools.map.settings.gridY=this.oldSettings.gridY,this.tools.map.settings.gridOffsetX=0,this.tools.map.settings.gridOffsetY=0)},adjustSettings:function(t){this.restore(),this.tools.activeTool!=this&&(this.oldSettings.activeTool=this.tools.activeTool),this.oldSettings.gridX=this.tools.map.settings.gridX,this.oldSettings.gridY=this.tools.map.settings.gridY,this.tools.map.settings.gridX=t.tileWidth,this.tools.map.settings.gridY=t.tileHeight,this.tools.map.settings.gridOffsetX=t.x,this.tools.map.settings.gridOffsetY=t.y},unselect:function(){this.panel.content.clear(),this.restore(),this.tools.activeTool==this&&this.oldSettings.activeTool&&this.tools.activeTool!=this.oldSettings.activeTool?this.tools.setTool(this.oldSettings.activeTool,!0):this.tools.setTool(this.tools.tools.select,!0)},deactivate:function(){this.restore()},select:function(t){this._select(t)},_select:function(t){return t.type!=MT.objectTypes.TILE_LAYER?void this.restore():(this.active=this.tools.map.getById(t.id),this.tools.map.activeObject!=this.active?void this.restore():(this.tools.setTool(this),void(this.active&&(this.panel.show(),this.update()))))},update:function(){var t=this.tools.project.plugins.assetmanager.list;this.active&&this.createPanels(t),this.activePanel&&this.drawImage(this.activePanel)},updateLayer:function(t){var e=t.object,i=t.data;if(i.images&&0!=i.images.length){for(var s=e.map,o=0,n=null,a=this.tools.project.plugins.assetmanager.list,h=null,l=0;l<i.images.length;l++)h=a[i.images[l]],h?(n=s.addTilesetImage(h.id,h.id,h.frameWidth,h.frameHeight,h.margin,h.spacing,o),o+=n.total):(i.images.splice(l,1),l--);var r=i.tiles;for(var c in r)for(var d in r[c])r[c][d]>=s.tiles.length?(delete r[c][d],console.warn("tile out of range: ",r[c][d])):e.map.putTile(r[c][d],d,c,e);void 0!=i.alpha&&(e.alpha=i.alpha)}}}),MT.namespace("plugins.tools"),MT.require("ui.Dropdown"),MT.require("ui.TextColorPicker"),MT.extend("core.BasicTool").extend("core.Emitter")(MT.plugins.tools.Text=function(t){MT.core.BasicTool.call(this,t),this.name="text",this.isInitialized=!1;{var e=this;t.ui}this.tools=t,this.tester=document.createElement("span"),this.fonts=["Arial","Comic Sans MS","Courier New","Georgia","Impact","Times New Roman","Trebuchet MS","Verdana"],this.tools.on(MT.OBJECT_SELECTED,function(i){return t.map.selector.count>1?void e.panel.hide():void e.select(i)}),this.tools.on(MT.OBJECT_UNSELECTED,function(){e.panel.hide()});var i=this.tools.ui.events;i.on(i.KEYUP,function(t){var i=t.which;i==MT.keys.ESC&&e.textPopup.hide(!0)}),this.manager=this.tools.project.plugins.fontmanager;var s=function(){e.checkFonts(),e.tools.map.off(s)};this.tools.map.on(MT.MAP_OBECTS_ADDED,s),this.createPanel()},{createPanel:function(){var t=this,e=this.tools.ui;this.panel=e.createPanel("Text"),this.panel.style.height=this.project.panel.height+"px",this.panel.style.top=this.tools.map.panel.content.bounds.top+"px",this.panel.style.left=this.project.panel.width+"px",this.panel.addClass("text-tools"),this.panel.removeHeader(),this.panel.hide();for(var i=this.fonts,s=[],o=0;o<i.length;o++)s.push(this._mk_setFontSelect(i[o]));this.fontFace=new MT.ui.Dropdown({list:s,button:{"class":"text-font",width:"auto"},listStyle:{width:200},onchange:function(e){t.setFontFamily(e)}},e);for(var n=[10,11,12,14,18,24,26,28,30,32,36,48,60,72,96],a=[],o=0;o<n.length;o++)a.push(this._mk_setFontSizeSelect(n[o]));this.fontSize=new MT.ui.Dropdown({list:a,button:{"class":"text-size",width:"auto"},listStyle:{width:50},onchange:function(e){t.setFontSize(e)}},e),this.panel.addButton(this.fontFace.button),this.panel.addButton(this.fontSize.button),e.on(e.events.RESIZE,function(){t.panel.width=t.tools.map.panel.content.width,t.panel.height=30,t.panel.style.top=t.tools.map.panel.content.bounds.top+"px"}),this.bold=this.panel.addButton("B","text-bold",function(){t.toggleBold()}),this.bold.width="auto",this.italic=this.panel.addButton("I","text-italic",function(){t.toggleItalic()}),this.italic.width="auto",this.wordWrap=this.panel.addButton("Wx","text-wrap",function(){t.toggleWordWrap()}),this.wordWrap.width="auto",this.wordWrapWidth=new MT.ui.Dropdown({button:{"class":"word-wrap-width-size",width:"auto"},onchange:function(e){t.setWordWrapWidth(e)}},e),this.wordWrapWidth.on("show",function(){t.wordWrapWidth.button.el.removeAttribute("px")}),this.wordWrapWidth.on("hide",function(){t.wordWrapWidth.button.el.setAttribute("px","px")}),this.panel.addButton(this.wordWrapWidth.button),this.left=this.panel.addButton("L","text-left",function(){t.setAlign("left")}),this.left.width="auto",this.center=this.panel.addButton("C","text-center",function(){t.setAlign("center")}),this.center.width="auto",this.right=this.panel.addButton("R","text-right",function(){t.setAlign("right")}),this.right.width="auto",this.colorButton=this.panel.addButton("C","text-color",function(){t.showColorPicker()}),this.colorButton.width="auto",this.colorPicker=new MT.ui.TextColorPicker(this.tools.ui),this.colorPicker.el.style.zIndex=3,this.panel.on("hide",function(){t.colorPicker.hide()}),this.colorPicker.on("fill",function(e){t.setFill(e)}),this.colorPicker.on("stroke",function(e){t.setStroke(e)}),this.colorPicker.on("shadow",function(e){t.setShadow(e)}),this.textButton=this.panel.addButton("txt","text-edit",function(){t.showTextEdit()}),this.textButton.width="auto",this.textPopup=new MT.ui.Popup("Edit Text",""),this.textPopup.hide(),this.textPopup.showClose(),this.textArea=document.createElement("textarea"),this.textPopup.content.appendChild(this.textArea),this.textArea.style.width="100%",this.textArea.style.height="200px";var h=function(t){t.stopPropagation()};this.textArea.onkeydown=h,this.textArea.onkeyup=h,this.textArea.onfocus=h,this.textArea.onmousedown=h,this.textArea.onmouseup=h,this.textPopup.addButton("Done",function(){t.setText(t.textArea.value),t.textPopup.hide()})},showColorPicker:function(){if(this.colorPicker.isVisible)return void this.colorPicker.hide();this.colorPicker.show(document.body);var t=this.colorButton.el.getBoundingClientRect();this.colorPicker.y=t.top+t.height,this.colorPicker.x=t.left,this.colorPicker.style.zIndex=10*this.ui.zIndex+1},_mk_setFontSelect:function(t){var e=this;return{label:t,cb:function(){e.setFontFamily(t)},create:function(e){e.style.fontFamily=t}}},_mk_setFontSizeSelect:function(t){var e=this;
return{label:t,cb:function(){e.setFontSize(t)}}},showTextEdit:function(t){if(this.map=this.tools.map,this.map.activeObject){var e=this.tools.map.activeObject;if(this.textArea.value=e.text,this.textPopup.show(),t){var i=this.textPopup,s=this,o=function(t){i.off("close",o),t&&s.tools.om.deleteObj(e.id)};this.textPopup.on("close",o)}}},setText:function(t){this.map=this.tools.map,this.map.activeObject&&(this.map.activeObject.text=t)},change:function(){},setFill:function(t){this.map=this.tools.map,this.map.activeObject&&(this.map.activeObject.fill=t,this.tools.om.sync())},setStroke:function(t){this.map=this.tools.map,this.map.activeObject&&(this.map.activeObject.stroke=t.color,this.map.activeObject.strokeThickness=t.strokeThickness)},setShadow:function(t){this.map=this.tools.map,this.map.activeObject&&this.map.activeObject.setShadow(t.x,t.y,t.color,t.shadowBlur)},setAlign:function(t){this.map=this.tools.map,this.map.activeObject&&(this.map.activeObject.align=t,this.select(this.map.activeObject))},isUnknownFont:function(t){for(var e=0;e<this.fonts.length;e++)if(this.fonts[e]==t)return!1;return!0},addFont:function(t){this.isUnknownFont(t)&&(this.fonts.push(t),this.fontFace&&this.fontFace.addItem(this._mk_setFontSelect(t)))},checkFonts:function(){for(var t,e=this.tools.map.loadedObjects,i=null,s=this,o=0,n=0;n<e.length;n++)if(i=e[n],i.data.type==MT.objectTypes.TEXT){if(t=i.data.style.fontFamily,!t)continue;this.isUnknownFont(t)&&(this.addFont(t),o++,this.manager.loadFont(t,function(){o--,0==o&&window.setTimeout(function(){s.updateTextObjects()},500)}))}},updateTextObjects:function(t){var e=this.tools.map.loadedObjects;PIXI.Text.heightCache={};for(var i,s=0;s<e.length;s++)e[s].data.type==MT.objectTypes.TEXT&&(i=e[s].data.style.fontFamily,(void 0==t||i==t||i.indexOf(t)>-1)&&(e[s].object.dirty=!0))},setFontFamily:function(t){if(this.map=this.tools.map,this.map.activeObject){var e=this.map.activeObject;if(this.isUnknownFont(t)){var i=this;return this.addFont(t),void this.manager.loadFont(t,function(){i.setFontFamily(t),window.setTimeout(function(){i.updateTextObjects(t)},1e3)})}if(this.map=this.tools.map,e){return this._setFontFamily(e,t),e.object.dirty=!0,void this.select(e)}}},setFontSize:function(t){if(this.map=this.tools.map,this.map.activeObject){var e=this.map.activeObject;this.tester.style.font=e.font||e.style.font,this.tester.style.fontSize=t,e.fontSize=this.tester.style.fontSize,this.select(this.map.activeObject)}},toggleBold:function(){if(this.map=this.tools.map,this.map.activeObject){var t=this.map.activeObject,e=t.style.font,i=this.getFontAttribs(e),s="";i.bold||(s="bold"),i.italic&&(s+=" italic"),s=s.trim(),t.fontWeight=s,this.select(t)}},toggleItalic:function(){if(this.map=this.tools.map,this.map.activeObject){var t=this.map.activeObject,e=t.style.font,i=this.getFontAttribs(e),s="";i.bold&&(s+="bold"),i.italic||(s+=" italic"),s=s.trim(),t.fontWeight=s,this.select(t)}},toggleWordWrap:function(){if(this.map=this.tools.map,this.map.activeObject){var t=this.map.activeObject;t.wordWrap=!t.wordWrap;var e=t.object.getBounds();t.wordWrapWidth<e.width-10&&(t.wordWrapWidth=parseInt(e.width,10)),this.select(t)}},setWordWrapWidth:function(t){this.map=this.tools.map,this.map.activeObject&&(this.map.activeObject.wordWrapWidth=parseInt(t,10),this.select(this.map.activeObject))},_setFontFamily:function(t,e){t=t||this.map.activeObject,this.tester.style.font=t.style.font,this.tester.style.fontFamily=e,t.fontFamily=this.tester.style.fontFamily.replace(/'/gi,""),t.fontWeight=this.tester.style.fontWeight.replace(/normal/gi,""),"italic"==this.tester.style.fontStyle&&(t.fontWeight+=" "+this.tester.style.fontStyle.replace(/normal/gi,"")),t.fontSize=parseInt(this.tester.style.fontSize)},init:function(){if(this.map=this.tools.map,!this.isInitialized){var t=this;this.tools.ui.events.on("keypress",function(e){t.change(e)}),this.isInitialized=!0}},showTools:function(){},select:function(t){var e=t;if(!e||!e.data||e.data.type!=MT.objectTypes.TEXT)return void this.panel.hide();e.data.style=e.style,this.tools.om.sync(),this.tester.style.font=e.font?e.font:e.object.style.font,this.fontFace.value=this.tester.style.fontFamily.replace(/'/gi,""),this.fontFace.button.style.fontFamily=this.tester.style.fontFamily,this.fontSize.value=e.fontSize;var i=this.getFontAttribs(e.style.font);i.bold?(this.bold.style.fontWeight="bold",this.bold.addClass("active")):(this.bold.style.fontWeight="normal",this.bold.removeClass("active")),i.italic?(this.italic.style.fontStyle="italic",this.italic.addClass("active")):(this.italic.style.fontStyle="normal",this.italic.removeClass("active")),e.wordWrap?this.enableWordWrap(e):this.disableWordWrap(e),this.checkAlign(e),this.colorPicker.setColors({stroke:e.stroke,fill:e.fill,shadow:e.shadowColor}),this.colorPicker.shadowXInput.setValue(e.shadowOffsetX,!0),this.colorPicker.shadowYInput.setValue(e.shadowOffsetY,!0),this.colorPicker.shadowBlurInput.setValue(e.shadowBlur,!0),this.colorPicker.strokeThicknessInput.setValue(e.strokeThickness,!0),this.panel.hide(),this.panel.show(document.body),e.object.dirty=!0,this.tools.project.plugins.settings.update()},enableWordWrap:function(t){this.wordWrap.addClass("active"),this.wordWrapWidth.button.removeClass("hidden"),this.wordWrapWidth.button.text=t.wordWrapWidth,this.wordWrapWidth.button.el.setAttribute("px","px")},disableWordWrap:function(){this.wordWrap.removeClass("active"),this.wordWrapWidth.button.addClass("hidden")},checkAlign:function(t){var e=t;e.wordWrap||e.object.text.split("\n").length>1?(this.left.removeClass("hidden active"),this.center.removeClass("hidden active"),this.right.removeClass("hidden active"),"left"==e.align&&this.left.addClass("active"),"right"==e.align&&this.right.addClass("active"),"center"==e.align&&this.center.addClass("active")):(this.left.addClass("hidden"),this.center.addClass("hidden"),this.right.addClass("hidden"))},getFontAttribs:function(t){var e={bold:!1,italic:!1};if(!t)return e;for(var i=t.split(" "),s=0;s<i.length;s++)"bold"==i[s].trim()&&(e.bold=!0),"italic"==i[s].trim()&&(e.italic=!0);return e},mouseDown:function(){},mouseUp:function(t){if(t.target==this.map.game.canvas){var e=t.offsetX+this.map.offsetXCam-this.map.ox,i=t.offsetY+this.map.offsetYCam-this.map.oy,s=this.map.pickObject(t.x-this.map.offsetXCam,t.y-this.map.offsetYCam);if(s&&s.data.type==MT.objectTypes.TEXT)this.tools.tools.select.select(s),this.tools.select(s),this.tools.tools.text.showTextEdit();else{var o=this.tools.om.createTextObject(e,i);o.text=o.tmpName,this.tools.om.insertObject(o),s=this.map.getById(o.id),this.tools.select(s),this.tools.tools.text.showTextEdit(!0)}}},mouseMove:function(){}}),MT.namespace("plugins.tools"),MT.extend("core.BasicTool").extend("core.Emitter")(MT.plugins.tools.Brush=function(t){MT.core.BasicTool.call(this,t),this.name="brush"},{initUI:function(t){MT.core.BasicTool.initUI.call(this,t);var e=this;this.tools.on(MT.ASSET_SELECTED,function(t){e.tools.activeTool==e&&e.init(t)}),this.tools.on(MT.ASSET_FRAME_CHANGED,function(t){e.tools.activeTool==e&&(e.tools.initTmpObject(t),e.tools.tmpObject.frame=e.tools.activeFrame)})},lastX:0,lastY:0,init:function(t){this.map=this.tools.map,this.tools.unselectObjects(),t=t||this.tools.activeAsset;var e=this;this.tools.map.handleMouseMove=function(t){e.mouseMove(t)},t&&!t.contents&&(this.tools.initTmpObject(t),this.tools.tmpObject.frame=this.tools.activeFrame)},mouseDown:function(){if(!this.tools.tmpObject){if(!this.tools.map.activeObject)return;return this.tools.lastAsset||(this.tools.lastAsset=this.project.plugins.assetmanager.getById(this.tools.map.activeObject.data.assetId)),void this.init(this.tools.lastAsset)}this.insertObject()},mouseMove:function(t){if(t.target==this.tools.map.game.canvas&&this.tools.tmpObject){{this.tools.tmpObject.x,this.tools.tmpObject.y}this.tools.map._followMouse(t,!0),this.ui.events.mouse.down&&(this.tools.tmpObject.x!=this.lastX||this.tools.tmpObject.y!=this.lastY)&&this.insertObject()}},insertObject:function(){var t=this.project.plugins.objectmanager;this.tools.map.sync(this.tools.tmpObject,this.tools.tmpObject.data),this.tools.tmpObject.data.frame=this.tools.activeFrame,t.insertObject(JSON.parse(JSON.stringify(this.tools.tmpObject.data))),this.lastX=this.tools.tmpObject.x,this.lastY=this.tools.tmpObject.y,this.tools.initTmpObject(),this.tools.tmpObject.frame=this.tools.activeFrame,this.tools.tmpObject.x=this.lastX,this.tools.tmpObject.y=this.lastY,this.tools.tmpObject.object.bringToTop()},mouseUp:function(){},deactivate:function(){this.tools.removeTmpObject(),this.tools.map.handleMouseMove=this.tools.map.emptyFn,this.project.plugins.objectmanager.update()}}),MT.namespace("plugins.tools"),MT.extend("core.BasicTool").extend("core.Emitter")(MT.plugins.tools.Stamp=function(t){MT.core.BasicTool.call(this,t),this.name="stamp"},{initUI:function(t){MT.core.BasicTool.initUI.call(this,t);var e=this;this.tools.on(MT.ASSET_SELECTED,function(t){e.tools.activeTool==e&&e.init(t)}),this.tools.on(MT.ASSET_FRAME_CHANGED,function(t,i){e.tools.activeTool==e&&(e.tools.initTmpObject(e.tools.activeAsset),e.tools.tmpObject.frame=i)}),this.tools.on(MT.TOOL_SELECTED,function(){e.tools.activeTool!=e})},init:function(t){this.map=this.tools.map,this.tools.unselectObjects(),t=t||this.tools.activeAsset,this.map.handleMouseMove=this.map._followMouse,t&&!t.contents&&(this.tools.initTmpObject(t),this.tools.tmpObject.frame=this.tools.activeFrame)},mouseDown:function(){if(!this.tools.tmpObject)return this.map.activeObject?(this.tools.lastAsset||(this.tools.lastAsset=this.project.plugins.assetmanager.getById(this.map.activeObject.data.assetId)),void this.init(this.tools.lastAsset)):void(this.project.plugins.assetmanager.active&&(this.tools.lastAsset=this.project.plugins.assetmanager.active.data));var t=this.project.plugins.objectmanager;this.map.sync(this.tools.tmpObject),this.tools.tmpObject.data.frame=this.tools.activeFrame;var e=t.insertObject(JSON.parse(JSON.stringify(this.tools.tmpObject.data)));this.tools.initTmpObject(),this.tools.tmpObject.frame=this.tools.activeFrame,this.tools.tmpObject.x=e.x,this.tools.tmpObject.y=e.y,this.tools.tmpObject.object.bringToTop()},mouseUp:function(){},deactivate:function(){this.tools.removeTmpObject(),this.map.handleMouseMove=this.map.emptyFn,this.project.plugins.objectmanager.update()}}),MT.namespace("plugins.tools"),MT.extend("core.BasicTool").extend("core.Emitter")(MT.plugins.tools.Select=function(t){MT.core.BasicTool.call(this,t),this.name="select",this.activeState=this.states.NONE,this.startMove={x:0,y:0}},{states:{NONE:0,RW:1,RE:2,RN:3,RS:4,RNW:5,RNE:6,RSW:7,RSE:8},initUI:function(t){MT.core.BasicTool.initUI.call(this,t),this.map=this.tools.map},init:function(t){this.mDown=!1,this.map.handleMouseMove=this.mouseMoveFree,t||this.showInfoToolTip()},deactivate:function(){this.mDown=!1,this.map.handleMouseMove=this.mouseMoveFree},select:function(t){if(t!=map.activeObject){var e=this.ui.events.mouse.lastEvent&&this.ui.events.mouse.lastEvent.shiftKey?!0:!1;return e?this.map.selector.is(t)?void this.map.selector.remove(t):void this.map.selector.add(t):void this.tools.selectObject(t,!0)}},mouseMoveFree:function(t){if(this.activeObject){var e=this.project.plugins.tools.tools.select,i=this.activeObject,s=t.x-this.ox,o=t.y-this.oy;return void(e.checkAltKey(t)||i.mouseMove(s,o,t));var i,s,o}},altKeyReady:!1,checkAltKey:function(t){if(this.altKeyReady){this.altKeyReady=!1;var e=[],i=this.map.selector;i.forEach(function(t){e.push(t.data)});var s=null,o=this.map.game.camera.x,n=this.map.game.camera.y,a=this.tools.om.multiCopy(e);i.clear();for(var h,l=0;l<a.length;l++)h=this.map.getById(a[l].id),h.object.updateTransform(),s=h.object.getBounds(),a[l].x=s.x+o,a[l].y=s.y+n,i.add(h);a.length>0&&(this.map.activeObject=null,this.map.emit("select",this.map.settings),this.initMove(t))}},mouseMove:function(t){if(this.mDown){var e=t.x-this.map.offsetX,i=t.y-this.map.offsetY;e>this.map.selection.sx?this.map.selection.width=e-this.map.selection.x:(this.map.selection.width=this.map.selection.sx-e,this.map.selection.x=e),i>this.map.selection.sy?this.map.selection.height=i-this.map.selection.y:(this.map.selection.height=this.map.selection.sy-i,this.map.selection.y=i),this.map.selectRect(this.map.selection,!t.shiftKey),1!==this.map.selector.count?(this.map.emit("select",this.map.settings),this.map.activeObject=null):this.map.activeObject=this.map.selector.get(0)}},initMove:function(t){if(this.tools.activeTool==this){this.checkAltKey(t);var e=this;this.map.updateMouseInfo(t),this.map.handleMouseMove=function(){e.map.handleMouseMove=e.map._objectMove}}},_lastMD:0,doubleClick:function(){if(!this.map.activeObject)return!1;for(var t,e=this.map.activeObject.data,i=0;i<this.map.loadedObjects.length;i++)t=this.map.loadedObjects[i],t.data.assetId==e.assetId&&t.data.type==e.type&&t.isVisible&&!t.isLocked&&this.map.selector.add(t);return!0},mDown:!1,mouseUp:function(t){this.mDown=!1;var e=(t.x-this.map.offsetXCam,t.y-this.map.offsetYCam,this.tools.map);e.selectRect(e.selection),e.selection.width=0,e.selection.height=0,this.map.activeObject&&this.map.activeObject.mouseUp(t.x-this.map.ox,t.y-this.map.oy,t),e.handleMouseMove=this.mouseMoveFree},mouseDown:function(t){if(this.mDown=!0,!(Date.now()-this._lastMD<300&&this.doubleClick())){this._lastMD=Date.now();var e=t.x-this.map.ox,i=t.y-this.map.oy,s=t.x-this.map.offsetXCam,o=t.y-this.map.offsetYCam;if(t.altKey&&(this.altKeyReady=!0),this.map.activeObject&&-1!=this.map.activeObject.activeHandle)return void this.map.activeObject.mouseDown(e,i,t);var n=t.shiftKey?!0:!1,a=this.map.pickObject(s,o);if(!a){var h=this;return this.map.handleMouseMove=function(t){h.mouseMove(t)},this.map.selection.x=t.x-this.map.offsetX,this.map.selection.y=t.y-this.map.offsetY,this.map.selection.sx=t.x-this.map.offsetX,this.map.selection.sy=t.y-this.map.offsetY,this.map.selection.width=0,this.map.selection.height=0,void(n||(this.map.selector.clear(),this.map.activeObject=null,this.map.emit("select",this.map.settings)))}if(n){if(this.map.selector.is(a))return void this.map.selector.remove(a)}else this.map.selector.is(a)||this.map.selector.clear();this.map.selector.add(a),1==this.map.selector.count?(this.map.activeObject=a,a.mouseDown(e,i,t)):(console.log(this.map.selector.count),this.map.activeObject=null,this.map.emit("select",this.map.settings),this.altKeyReady=t.altKey,this.initMove(t))}}}),MT.namespace("ui"),MT.require("ui.Panel"),MT.extend("core.Emitter").extend("ui.DomElement")(MT.ui.List=function(t,e,i){MT.ui.DomElement.call(this),this._items=[],this.setAbsolute(),this.addClass("ui-list"),this.panel=new MT.ui.Panel("",e.events),this.panel.removeHeader(),this.panel.content.style.overflow="initial",this.panel.style.position="relative",this.panel.show(this.el),this.panel.content.style.position="relative";var s=this;e.events.on("mouseup",function(t){for(var e=0;e<s.panel.buttons.length;e++)if(s.panel.buttons[e].el==t.target)return;s.isVisible&&i&&s.hide()}),this.isVisible=!1,this.list=t,this.update(),this.addChild(this.panel).show()},{update:function(){for(;this._items.length;)this._items.pop().remove();for(var t=0;t<this.list.length;t++)this.addItem(this.list[t])},addItem:function(t){if(!t.check||t.check()){var e=this.panel.addButton(t.label,t.className,t.cb);e.style.position="relative",e.addClass("ui-list-button"),t.create&&t.create(e),this._items.push(e)}},show:function(t){this.isVisible||(this.update(),this.isVisible=!0,MT.ui.DomElement.show.call(this,t),this.emit("show"))},hide:function(){this.isVisible&&(this.isVisible=!1,MT.ui.DomElement.hide.call(this),this.emit("hide"))}}),MT.namespace("ui"),MT.require("ui.ColorPicker"),MT.extend("ui.DomElement").extend("core.Emitter")(MT.ui.Input=function(t,e,i){var s=t.events;MT.ui.DomElement.call(this),MT.core.Emitter.call(this),this.object=i,this.key="",this.step=1,this.min=-1/0,this.max=1/0,this.type="number","string"==typeof e?this.key=e:(this.key=e.key,this.step=e.step||this.step,void 0!=e.min&&(this.min=e.min),void 0!=e.max&&(this.max=e.max),void 0!=e.type&&(this.type=e.type)),"bool"==this.type&&(this.type="number",this.min=0,this.max=1,this.step=1),"number"==this.type&&this.addClass("ui-input-number"),this.label=new MT.ui.DomElement,this.addChild(this.label).show(),this.input=document.createElement("input"),this.addClass("ui-input"),this.label.el.innerHTML=this.key,this.label.style.bottom="initial",this.label.style.right="50%",this.value=new MT.ui.DomElement("a");var o=this;if("upload"==this.type)return this.input.type="file",this.addClass("upload"),e.accept&&this.input.setAttribute("accept",e.accept),this.input.onchange=function(t){o.emit("change",t,o.object)},this.label.style.right="0",this.label.el.onclick=function(){o.input.click()},void(void 0!==this.object[this.key]&&(this.setValue(this.object[this.key],!0),this.addChild(this.value).show(),this.value.style.bottom="initial",this.value.style.left="initial",this.value.style.right=0,this.value.addClass("ui-input-value")));if(this.addChild(this.value).show(),this.value.style.bottom="initial",this.value.style.left="initial",this.value.style.right=0,this.value.addClass("ui-input-value"),"color"==this.type){this.value.style.float="right",this.value.style.position="relative",this.span=document.createElement("span"),this.el.appendChild(this.span),this.span.className="ui-input-color-pick",this.span.style.backgroundColor=this.object[this.key];var o=this;this.span.onclick=function(){t.colorPicker.setColor(o.object[o.key]),t.colorPicker.show(),t.colorPicker.on("change",function(t){o.setValue(t)})}}this.setValue(this.object[this.key],!0),this.setTabIndex(),this.events=s;var n=document.createElement("input");n.type="text",n.className="ui-input",n.isVisible=!1,n.style.textAlign="right",n.style.paddingRight="10px",n.setAttribute("tabindex",parseInt(this.value.el.getAttribute("tabindex"))+1);var a=function(){var t=.5*o.value.el.parentNode.parentNode.offsetWidth;n.style.width=t+"px",n.style.top=o.value.calcOffsetY(o.value.el.offsetParent)-9+"px",n.style.left=o.value.calcOffsetX(o.value.el.offsetParent)-t+o.value.el.offsetWidth-25+"px",n.value=o.object[o.key],n.isVisible=!0,n.width=o.value.offsetWidth+"px",o.value.el.innerHTML="",o.value.el.offsetParent.appendChild(n),n.focus(),"color"!=n.type&&n.setSelectionRange(0,n.value.length)};this.value.el.onkeydown=function(){a()},this.value.el.setAttribute("draggable","false"),this.value.el.onmouseup=function(){o.needEnalbe&&a()},this.enableInput=function(){a()};var h=!1;this.value.el.onmousedown=function(){o.needEnalbe=!0,h=!0};var l;n.onfocus=function(){l=o.object[o.key]},n.onblur=function(){n.parentNode.removeChild(n),n.isVisible=!1;var t=o.evalValue(n.value);o.setValue(t),o.emit("change",t,t)},n.onkeydown=function(t){t.which==MT.keys.DELETE&&t.stopPropagation(),t.which==MT.keys.ESC&&(n.value=l,n.blur(),t.stopPropagation())},n.onkeyup=function(t){if(n.isVisible){var e=t.which,i=!0;if(e==MT.keys.ESC&&(i=!1,n.value=o.object[o.key],t.stopPropagation(),n.blur()),e==MT.keys.ENTER&&(i=!1,t.stopPropagation(),n.blur()),o.object[o.key]!=n.value){var s=o.evalValue(n.value);o.setValue(s,!0),i&&(o.value.el.innerHTML="")}}},"number"==this.type&&(this.onwheel=s.on("wheel",function(t){if(t.target===o.value.el){t.preventDefault();var e=(t.wheelDelta||-t.deltaY)>0?1:-1,i=o.object[o.key]+e*o.step;o.setValue(i)}}),this.mouseup=s.on("mouseup",function(){h=!1,o.needEnalbe=!1}),this.mousemove=s.on("mousemove",function(){if(h){var t=o.object[o.key]-s.mouse.my*o.step;o.setValue(t,!1)}}))},{remove:function(){this.events.off(this.mousemove),this.events.off(this.mouseup),this.events.off(this.keyup),this.events.off(this.onwheel),this.el.parentNode&&this.el.parentNode.removeChild(this.el)},update:function(){this.setValue(this.object[this.key],!0)},setObject:function(t,e){this.object=t,this.update(),e&&this.show()},setValue:function(t,e){if("upload"!=this.type){this.needEnalbe=!1;var i=this.object[this.key];if(t==i&&!e)return void(this.value.el.innerHTML=t);t<this.min&&(t=this.min),t>this.max&&(t=this.max),this.object[this.key]=t,this.value.el.innerHTML="number"==typeof t?parseFloat(t.toFixed(8)):t,"color"==this.type&&(this.span.style.backgroundColor=t),e||this.emit("change",t,i)}},evalValue:function(val){if("number"!=this.type)return val;var ret=null;try{ret=eval(val)}catch(e){ret=val}return ret},setTabIndex:function(){MT.ui.Input.tabindex+=1,this.value.el.setAttribute("tabindex",MT.ui.Input.tabindex),this.value.el.setAttribute("href","javascript:;")}}),MT.ui.Input.tabindex=0,MT.namespace("core"),MT(MT.core.MagicObject=function(t,e,i){this.data=t,this.parent=e,this.map=i,this.settings=this.map.project.plugins.settings,this.game=i.game,this.isRemoved=!1,this.activeHandle=-1,this.handles=[],this.mouseInfo={down:!1,x:0,y:0},this.rotator={x:0,y:0},this.create(),Object.seal(this)},{radius:3,activeRadius:5,create:function(){this.data.contents&&this.createGroup(),this.data.type==MT.objectTypes.SPRITE&&this.createSprite(),this.data.type==MT.objectTypes.TEXT&&this.createText(),this.data.type==MT.objectTypes.TILE_LAYER&&this.createTileLayer(),this.object.magic=this},createTileLayer:function(){{var t=this.game.width;this.game.height}this.game.width=99999,this.game.height=99999,this.createTileMap(),this.object=this.tilemap.createBlankLayer(this.data.name,this.data.widthInTiles,this.data.heightInTiles,this.data.tileWidth,this.data.tileHeight),this.object.fixedToCamera=this.data.isFixedToCamera,this.map.project.plugins.tools.tools.tiletool.updateLayer(this),this.map.tileLayers.push(this.object),this.map.resort(),this.game.width=t,this.game.height=t,this.data.isVisible||this.hide()},createTileMap:function(){var t=this.data.tileWidth||64,e=this.data.tileHeight||64;this.tilemap=this.game.add.tilemap(null,t,e,this.data.widthInTiles,this.data.heightInTiles)},createGroup:function(){this.object=this.game.add.group(),this.parent.add(this.object)},createSprite:function(){PIXI.BaseTextureCache[this.data.assetId]||(this.data.assetId="__missing"),this.object=this.parent.create(this.data.x,this.data.y,this.data.assetId),this.object.inputEnabled=!0,this.object.input.pixelPerfectOver=!0,this.createBox(),this.update()},createText:function(){this.object=this.game.add.text(this.data.x,this.data.y,this.data.text,this.data.style),this.parent.add(this.object),this.object.inputEnabled=!0,this.object.input.pixelPerfectOver=!1,this.createBox(),this.update()},updateText:function(){this.object.text=this.data.text,this.data.style?this.object.style=this.data.style:this.data.style={},this.wordWrap=this.data.wordWrap,this.wordWrapWidth=this.data.wordWrapWidth,this.object.fontSize=this.data.style.fontSize||32,this.object.font=this.data.style.fontFamily||"Arial",this.object.fontWeight=this.data.style.fontWeight||"",this.object.style.fill=this.fill,this.data.shadow||(this.data.shadow={}),this.object.anchor.x=this.data.anchorX,this.object.anchor.y=this.data.anchorY},updateSprite:function(){this.object.anchor.x=this.data.anchorX,this.object.anchor.y=this.data.anchorY,this.object.loadTexture(this.data.assetId),this.object.frame=this.data.frame},hide:function(){this.object.visible=!1},show:function(){this.object.visible=!0},remove:function(){this.type==MT.objectTypes.TILE_LAYER?this.removeLayer():this.object.destroy(),this.isRemoved=!0},createBox:function(){this.handles[0]={x:0,y:0,opx:1,opy:3},this.handles[1]={x:0,y:0,opx:0,opy:2},this.handles[2]={x:0,y:0,opx:3,opy:1},this.handles[3]={x:0,y:0,opx:2,opy:0},this.handles[4]={x:0,y:0,opx:6,opy:0},this.handles[5]={x:0,y:0,opx:7,opy:7},this.handles[6]={x:0,y:0,opx:4,opy:0},this.handles[7]={x:0,y:0,opx:2,opy:5},this.updateBox()},update:function(t,e){if(t)for(var i in t)this.data[i]=t[i];e&&(this.parent=e,this.parent.add(this.object)),this.updateBox(),this.map.activeObject==this&&this.settings.update(),this.data.isVisible?this.show():this.hide(),this.data.type==MT.objectTypes.TEXT&&this.updateText(),this.data.type==MT.objectTypes.SPRITE&&this.updateSprite(),this.data.type==MT.objectTypes.TILE_LAYER&&(this.removeLayer(),this.createTileLayer(),this.object.visible=this.isVisible),this.object.x=this.data.x,this.object.y=this.data.y,this.object.angle=this.data.angle,this.data.scaleX&&(this.object.scale.x=this.scaleX,this.object.scale.y=this.scaleY),this.map.resort()},updateBox:function(){if(!this.data.contents&&this.data.type!=MT.objectTypes.TILE_LAYER){var t=this.object;t.updateTransform();var e,i,s=t.worldTransform,o=s.tx,n=s.ty,a=this.getOffsetAngle();0!=this.activeHandle&&(e=s.tx-t.width*t.anchor.x*this.map.scale.x,i=s.ty-t.height*t.anchor.y*this.map.scale.x,this.rp(a,e,i,o,n,this.handles[0])),1!=this.activeHandle&&(e=s.tx+t.width*(1-t.anchor.x)*this.map.scale.x,i=s.ty-t.height*t.anchor.y*this.map.scale.x,this.rp(a,e,i,o,n,this.handles[1])),2!=this.activeHandle&&(e=s.tx+t.width*(1-t.anchor.x)*this.map.scale.x,i=s.ty+t.height*(1-t.anchor.y)*this.map.scale.x,this.rp(a,e,i,o,n,this.handles[2])),3!=this.activeHandle&&(e=s.tx-t.width*t.anchor.x*this.map.scale.x,i=s.ty+t.height*(1-t.anchor.y)*this.map.scale.x,this.rp(a,e,i,o,n,this.handles[3])),4!=this.activeHandle&&(e=s.tx-t.width*t.anchor.x*this.map.scale.x,i=s.ty-t.height*t.anchor.y*this.map.scale.x+.5*t.height*this.map.scale.x,this.rp(a,e,i,o,n,this.handles[4])),6!=this.activeHandle&&(e=s.tx+t.width*(1-t.anchor.x)*this.map.scale.x,i=s.ty-t.height*t.anchor.y*this.map.scale.x+.5*t.height*this.map.scale.x,this.rp(a,e,i,o,n,this.handles[6])),5!=this.activeHandle&&(e=s.tx-t.width*t.anchor.x*this.map.scale.x+.5*t.width*this.map.scale.x,i=s.ty-t.height*t.anchor.y*this.map.scale.x,this.rp(a,e,i,o,n,this.handles[5])),7!=this.activeHandle&&(e=s.tx-t.width*t.anchor.x*this.map.scale.x+.5*t.width*this.map.scale.x,i=s.ty+t.height*(1-t.anchor.y)*this.map.scale.x,this.rp(a,e,i,o,n,this.handles[7]));var h=o,l=n-this.object.height*this.map.scale.x*.6-20;if(-3!=this.activeHandle){this.rotator.x=this.rpx(this.object.rotation,h,l,o,n),this.rotator.y=this.rpy(this.object.rotation,h,l,o,n);for(var r=0;r<this.handles.length;r++);}}},highlight:function(t){if(!this.isRemoved){var e=this.object.worldTransform,i=e.tx,s=e.ty;if(t.save(),t.translate(.5,.5),t.strokeStyle="#ffaa00",this.data.contents){var o=this.object.getBounds();return t.strokeRect(o.left,o.top,o.width,o.height),this.drawGroupHandle(t,this.object),void t.restore()}if(this.data.type==MT.objectTypes.TILE_LAYER){var o=this.object.getBounds();return t.strokeRect(o.left,o.top,o.width,o.height),this.drawGroupHandle(t,this.parent),void t.restore()}this.drawGroupHandle(t,this.parent),this.updateBox();var n=this.handles[0];t.beginPath(),t.moveTo(n.x,n.y);for(var a,h,l=1;4>l;l++)a=this.handles[l],t.lineTo(a.x,a.y);if(t.lineTo(n.x,n.y),t.stroke(),this.map.activeObject==this){t.strokeStyle="#ff0000",t.fillStyle=h;for(var l=0;l<this.handles.length;l++)a=this.handles[l],t.beginPath(),this.activeHandle==l?t.arc(a.x,a.y,this.activeRadius,0,2*Math.PI):t.arc(a.x,a.y,this.radius,0,2*Math.PI),h=t.createRadialGradient(a.x,a.y,0,a.x,a.y,this.radius),h.addColorStop(0,"rgba(255, 255, 255, 0)"),h.addColorStop(1,"rgba(0, 70, 70, 1)"),t.fillStyle=h,t.fill(),t.stroke();t.strokeStyle="#ffee22",t.beginPath(),-3==this.activeHandle?t.arc(this.rotator.x,this.rotator.y,this.activeRadius,0,2*Math.PI):t.arc(this.rotator.x,this.rotator.y,this.radius,0,2*Math.PI),h=t.createRadialGradient(this.rotator.x,this.rotator.y,0,this.rotator.x,this.rotator.y,this.radius),h.addColorStop(0,"rgba(255, 255, 255, 0)"),h.addColorStop(1,"rgba(0, 70, 70, 1)"),t.fillStyle=h,t.fill(),t.stroke(),t.beginPath(),t.moveTo(this.rotator.x,this.rotator.y),t.lineTo(i,s),t.stroke(),t.strokeStyle="#000000",t.beginPath(),-2==this.activeHandle?t.arc(i,s,this.activeRadius,0,2*Math.PI):t.arc(i,s,this.radius,0,2*Math.PI),h=t.createRadialGradient(i,s,0,i,s,this.radius),h.addColorStop(0,"rgba(255, 255, 255, 0)"),h.addColorStop(1,"rgba(0, 70, 70, 1)"),t.fillStyle=h,t.fill(),t.stroke()}t.restore()}},drawGroupHandle:function(t,e){var i=e.worldTransform,s=i.tx,o=i.ty;t.save(),t.translate(s,o),t.rotate(e.rotation),t.strokeStyle="#ffffff",t.strokeRect(-this.radius,-this.radius,2*this.radius,2*this.radius),t.beginPath(),t.moveTo(0,0);var n=0,a=3*-this.radius;t.lineTo(n,a),t.stroke(),t.restore()},mouseDown:function(t,e){this.mouseInfo.down=!0,this.mouseInfo.x=t,this.mouseInfo.y=e,-1!=this.activeHandle},mouseUp:function(){this.mouseInfo.down=!1},mouseMove:function(t,e,i){var s=this.mouseInfo;if(this.type==MT.objectTypes.TILE_LAYER){var o=this.map.project.plugins.tools;if(o.activeTool==o.tools.tiletool)return void o.tools.tiletool.mouseMove(i)}if(this.mouseInfo.down)return void(-1!=this.activeHandle?this.moveHandle(t,e,i):this.moveObject(t,e,i));s.x=t,s.y=e,this.updateBox();var n,a,h,l=this.object.worldTransform,r=l.tx,c=l.ty;n=Math.abs(r-t),a=Math.abs(c-e);var d=this.radius;if(-2==this.activeHandle&&(d=this.activeRadius),d>n&&d>a)return void(this.activeHandle=-2);if(d=this.radius,n=Math.abs(this.rotator.x-t),a=Math.abs(this.rotator.y-e),-3==this.activeHandle&&(d=this.activeRadius),d>n&&d>a)return void(this.activeHandle=-3);for(var u=0;u<this.handles.length;u++)if(d=this.radius,h=this.handles[u],n=Math.abs(h.x-t),a=Math.abs(h.y-e),this.activeHandle==u&&(d=this.activeRadius),d>n&&d>a)return void(this.activeHandle=u);this.activeHandle=-1},moveObject:function(t,e,i){var s=this.mouseInfo,o=(s.x-t)/this.map.scale.x,n=(s.y-e)/this.map.scale.y,a=this.getParentAngle(),h=this.rpx(-a,o,n,0,0),l=this.rpy(-a,o,n,0,0);if(this.x-=h,s.x=t,this.y-=l,s.y=e,i.ctrlKey&&0==a){var r=this.map.settings.gridX,c=this.map.settings.gridY,d=Math.round(this.x/r)*r,u=Math.round(this.y/c)*c;s.x+=(d-this.x)*this.map.scale.x,s.y+=(u-this.y)*this.map.scale.x,this.x=d,this.y=u}this.update()},moveHandle:function(t,e,i){var s,o,n,a=this.mouseInfo,h=this.object,l=h.worldTransform,r=l.tx,c=l.ty,d=this.getOffsetAngle();if(-3==this.activeHandle){o=a.x-t,n=a.y-e,this.rotator.x-=o,this.rotator.y-=n;var u=Math.atan2(l.ty-this.rotator.y,l.tx-this.rotator.x)-.5*Math.PI;return a.x=t,a.y=e,this.object.rotation=u,this.data.angle=this.object.angle,i.ctrlKey&&(console.log(Math.abs(this.object.rotation-u)),this.object.angle=15*Math.round(this.object.angle/15),this.data.angle=this.object.angle),void this.update()}if(-2==this.activeHandle)return this.moveAnchor(t-a.x,e-a.y),a.x=t,void(a.y=e);o=a.x-t,n=a.y-e,s=this.handles[this.activeHandle];var p,f,m=this.handles[s.opx],g=this.handles[s.opy],v=this.rpx(-d,s.x,s.y,r,c),b=this.rpy(-d,s.x,s.y,r,c),y=this.rpx(-d,m.x,m.y,r,c),T=(this.rpy(-d,m.x,m.y,r,c),this.rpx(-d,g.x,g.y,r,c),this.rpy(-d,g.x,g.y,r,c));if(p=y-v>0?1:-1,f=T-b>0?1:-1,this.activeHandle<4){s.x-=o,s.y-=n;var w=(this.width,this.height,Math.sqrt(Math.pow(m.x-s.x,2)+Math.pow(m.y-s.y,2))/this.map.scale.x),j=Math.sqrt(Math.pow(g.x-s.x,2)+Math.pow(g.y-s.y,2))/this.map.scale.y;(1==this.activeHandle||2==this.activeHandle)&&(p*=-1),(2==this.activeHandle||3==this.activeHandle)&&(f*=-1),this.width=w,this.height=j,this.updateBox(),this.scaleX=this.object.scale.x*p,this.scaleY=this.object.scale.y*f,i.ctrlKey&&(this.scaleX=.1*Math.round(this.scaleX/.1),this.scaleY=.1*Math.round(this.scaleY/.1)),i.shiftKey&&(this.scaleX=this.scaleY),this.data.scaleX=this.object.scale.x,this.data.scaleY=this.object.scale.y}else if(this.activeHandle%2==0){6==this.activeHandle&&(p*=-1),s.x-=o,s.y-=n;var x=p*Math.sqrt(Math.pow(m.x-s.x,2)+Math.pow(m.y-s.y,2))/this.map.scale.x;this.data.type==MT.objectTypes.TEXT&&this.data.wordWrap?this.wordWrapWidth=Math.round(x):this.width=x,this.scaleX=this.object.scaleX,this.updateBox(),i.ctrlKey&&(this.scaleX=.1*Math.round(this.scaleX/.1)),i.shiftKey&&(this.scaleY=this.scaleX),this.data.scaleX=this.object.scale.x,this.updateBox()}else s.y-=n,s.x-=o,7==this.activeHandle&&(f*=-1),this.height=f*Math.sqrt(Math.pow(g.x-s.x,2)+Math.pow(g.y-s.y,2))/this.map.scale.y,this.scaleY=this.object.scaleY,this.updateBox(),i.ctrlKey&&(this.scaleY=.1*Math.round(this.scaleY/.1)),i.shiftKey&&(this.scaleX=this.scaleY),this.data.scaleY=this.object.scale.y,this.updateBox();a.x=t,a.y=e,this.update()},bringToTop:function(){this.parent.bringToTop(this.object)
},moveAnchor:function(t,e){var i=this.getOffsetAngle(),s=this.object.rotation,o=this.object.worldTransform,n=this.getParentAngle(),a=-t,h=-e;this.object.rotation-=i,this.updateBox();var l=this.handles[0],r=this.rpx(-n,a,h,0,0),c=this.rpy(-n,a,h,0,0),d=this.rpx(-s,r,c,0,0),u=this.rpy(-s,r,c,0,0),p=l.x,f=l.y,m=o.tx-d,g=(m-p)/(this.object.width*this.map.scale.x),v=o.ty-u,b=(v-f)/(this.object.height*this.map.scale.x),y=this.anchorX,T=this.anchorY;this.anchorX=g,this.anchorY=b;var w=(g-y)*this.object.width,j=(b-T)*this.object.height;this.x+=this.rpx(s,w,j,0,0),this.y+=this.rpy(s,w,j,0,0),this.object.rotation=s,this.update()},move:function(t,e){this.getParentAngle();this.x=t,this.y=e},rpx:function(t,e,i,s,o){var n=Math.sin(t),a=Math.cos(t);return(e-s)*a-(i-o)*n+s},rpy:function(t,e,i,s,o){var n=Math.sin(t),a=Math.cos(t);return(i-o)*a+(e-s)*n+o},rp:function(t,e,i,s,o,n){var a=Math.sin(t),h=Math.cos(t);n.x=(e-s)*h-(i-o)*a+s,n.y=(i-o)*h+(e-s)*a+o},getOffsetAngle:function(){return this.object.rotation+this.getParentAngle()},getParentAngle:function(){for(var t=this.object.parent,e=0;t;)e+=t.rotation,t=t.parent;return e},hasParent:function(t){for(var e=t.object,i=this.object.parent;i;){if(i==e)return!0;i=i.parent}return!1},putTile:function(t,e,i){this.object.map.putTile(t,e,i,this.object)},getTile:function(t,e){return this.object.map.getTileWorldXY(t,e,void 0,void 0,this.object)},get isHidden(){return this.object.visible},set x(t){if(void 0==t||isNaN(t))throw new Error("x = nan?");this.object.x=t,this.data.x=t,this.updateBox()},get x(){return this.data.x},set y(t){this.object.y=t,this.data.y=t,this.updateBox()},get y(){return this.data.y},set angle(t){this.object.angle=t,this.data.angle=t,this.updateBox()},get angle(){return this.data.angle},set anchorX(t){this.object.anchor.x=t||0,this.data.anchorX=this.object.anchor.x,this.data.width=this.object.width,this.updateBox()},get anchorX(){return this.data.anchorX||0},set anchorY(t){this.object.anchor.y=t||0,this.data.anchorY=t,this.data.height=this.object.height,this.updateBox()},get anchorY(){return this.data.anchorY||0},set width(t){isNaN(t)||(this.object.width=t,this.data.width=t,this.data.scaleX=this.object.scale.x,this.updateBox())},get width(){return this.data.width},set height(t){isNaN(t)||(this.object.height=t,this.data.height=t,this.data.scaleY=this.object.scale.y,this.updateBox())},get height(){return this.data.height},set scaleX(t){isNaN(t)||(this.object.scale.x=t,this.data.scaleX=t,this.updateBox(),this.data.width=this.object.width)},get scaleX(){return this.data.scaleX},set scaleY(t){isNaN(t)||(this.object.scale.y=t,this.data.scaleY=t,this.updateBox(),this.data.height=this.object.height)},get scaleY(){return this.data.scaleY},get assetId(){return this.data.assetId},set assetId(t){this.data.assetId=t,this.object.loadTexture(t)},set alpha(t){isNaN(t)||(this.object.alpha=t,this.data.alpha=t)},get alpha(){return void 0==this.data.alpha?1:this.data.alpha},set frame(t){this.data.frame=t,this.object.frame=t},get frame(){return this.data.frame},set isFixedToCamera(t){this.object.fixedToCamera=t,this.data.isFixedToCamera=t,this.updateBox()},get isFixedToCamera(){return this.data.isFixedToCamera},set wordWrapWidth(t){this.object.wordWrapWidth=t,this.data.wordWrapWidth=t,this.updateBox()},get wordWrapWidth(){return this.data.wordWrapWidth||100},set wordWrap(t){this.data.wordWrap=t,this.object.wordWrap=t},get wordWrap(){return this.data.wordWrap},set style(t){console.log("do not se style")},get style(){return this.data.style||{}},set font(t){this.object.font=t,this.data.style.font=this.object.font},get font(){return this.object.style.font},set fontFamily(t){this.object.font=t,this.data.style.fontFamily=t},get fontFamily(){return this.data.style.fontFamily},set fontWeight(t){this.object.fontWeight=t,this.data.style.fontWeight=t},get fontWeight(){return this.data.style.fontWeight},set fontSize(t){var e=this.object.scale.x,i=this.object.scale.y;this.object.fontSize=parseInt(t),this.data.style.fontSize=this.object.fontSize,this.scaleX=e,this.scaleY=i},get fontSize(){return this.data.style.fontSize||(this.data.style.fontSize=this.object.fontSize),this.data.style.fontSize},set align(t){this.data.align=t,this.object.align=t},get align(){return this.data.align},set fill(t){this.object.fill=t,this.data.fill=t},get fill(){return this.data.fill||"#000000"},set stroke(t){this.object.stroke=t,this.data.stroke=t},get stroke(){return this.data.stroke||"#000000"},set strokeThickness(t){this.object.strokeThickness=t,this.data.strokeThickness=t},get strokeThickness(){return this.data.strokeThickness||0},setShadow:function(t,e,i,s){this.data.shadow||(this.data.shadow={}),this.data.shadow.x=t,this.data.shadow.y=e,this.data.shadow.color=i,this.data.shadow.blur=s,this.object.setShadow(t,e,i,s)},get shadowColor(){return this.data.shadow.color||"#000000"},get shadowOffsetX(){return this.data.shadow.x||0},get shadowOffsetY(){return this.data.shadow.y||0},get shadowBlur(){return this.data.shadow.blur||0},set text(t){this.object.text=t,this.data.text=t},get text(){return this.data.text},set widthInTiles(t){this.data.widthInTiles=t,this.removeLayer(),this.createTileLayer()},get widthInTiles(){return this.data.widthInTiles},set heightInTiles(t){this.data.heightInTiles=t,this.removeLayer(),this.createTileLayer()},get heightInTiles(){return this.data.heightInTiles},set tileWidth(t){this.data.tileWidth=t,this.removeLayer(),this.createTileLayer()},get tileWidth(){return this.data.tileWidth},set tileHeight(t){this.data.tileHeight=t,this.removeLayer(),this.createTileLayer()},get tileHeight(){return this.data.tileHeight},getTileXY:function(t,e,i){return this.object.getTileXY(t,e,i)},removeLayer:function(){this.object.destroy();var t=this.map.tileLayers.indexOf(this.object);this.map.tileLayers.splice(t,1)},get isVisible(){for(var t=this;t.parent.magic;){if(!t.data.isVisible)return!1;t=t.parent.magic}return t.data.isVisible},get isLocked(){if(this.data.isLocked)return!0;for(var t=this.parent.magic;t;){if(t.data.isLocked)return!0;t=t.parent.magic}return!1},get id(){return this.data.id},get type(){return this.data.type},getBounds:function(){return this.object.getBounds()}}),MT.namespace("core"),MT.extend("core.Emitter")(MT.core.Selector=function(){this._selected=[]},{add:function(t,e){void 0!==t&&(this.is(t)||(this._selected.push(t),e||this.emit("select",t)))},get count(){return this._selected.length},remove:function(t){for(var e=0;e<this._selected.length;e++)if(this._selected[e]==t)return this.emit("unselect",t),void this._selected.splice(e,1)},is:function(t){for(var e=0;e<this._selected.length;e++)if(this._selected[e]==t)return!0;return!1},get min(){return Math.min.apply(Math,this._selected)},get max(){return Math.max.apply(Math,this._selected)},forEach:function(t,e){if(this._selected)for(var i=!1,s=0;s<this._selected.length;s++)s==this._selected.length-1&&(i=!0),e?t.call(e,this._selected[s],i):t(this._selected[s],i)},sortAsc:function(){this._selected.sort()},clear:function(){for(var t=0;t<this._selected.length;t++)this.emit("unselect",this._selected[t]);this._selected.length=0,this.emit("clear")},get:function(t){return this._selected[t]}}),MT.namespace("core"),MT(MT.core.Helper=function(){},{isImage:function(t){var e=t.split(".").pop();return"png"==e||"jpg"==e||"gif"==e||"jpeg"==e},isSource:function(t){return!this.isImage(t)}}),MT.namespace("ui"),MT.require("ui.DomElement"),MT.extend("core.Emitter")(MT.ui.TreeView=function(t,e){MT.core.Emitter.call(this),this.options={};for(var i in e)this.options[i]=e[i];this.tree=null,this.items=[],this.rootPath=e.root,void 0!=t&&this.create(t),this._onDrop=[]},{onDrop:function(t){this._onDrop.push(t)},create:function(t){this.tree=new MT.ui.DomElement,this.tree.style.position="relative",this.tree.addClass("ui-treeView"),this.updateFullPath(t),this.createObject(t,this.tree)},createObject:function(t,e){for(var i,s=0;s<t.length;s++)if(i=t[s],void 0===i.contents)this.addItem(i,e,s);else{var o=this.addItem(i,e,s);this.createObject(i.contents,o)}},getData:function(t,e){t=t||this.tree;for(var i=null,e=[],s=0;s<t.children.length;s++)i=t.children[s],i.data.contents&&(i.data.contents=this.getData(i)),e.push(i.data);return e},update:function(t){return t?void this.merge(t,this.tree):void this.merge(this.getData())},_nextId:1,mkid:function(){return++this._nextId},addItem:function(t,e,i,s){var o=this.checkExistingItem(t,e,i,s);if(o)return o;var n=this,a=t.contents?"folder":"item",h=new MT.ui.DomElement;h.options={},h.index=i,h.style.position="relative",h.addClass("ui-treeview-"+a),h.visible=!0,h.data=t,h.fullPath=t.fullPath;var l=new MT.ui.DomElement,r=new MT.ui.DomElement;if(l.label=r,l.addChild(r).show(),r.el.innerHTML=t.name,l.style.position="relative",r.addClass("ui-treeview-label"),r.style.position="relative",r.style.paddingLeft="30px",r.style.paddingRight="23px",l.show(h.el),h.head=l,l.parent=h,l.addClass("ui-treeview-item-head"),s)return h.show(e.el),h;if(e.addChild(h,h.index),e.data&&e.data.isClosed||h.show(),"folder"==a&&(l.addClass("ui-treeview-folder-head"),t.isClosed?(h.addClass("close"),h.visible=!1):h.addClass("open"),l.el.onclick=function(t){if(!(t.target!=h.head.el&&t.target!=h.head.label.el||h.isFolder&&t.offsetX>30))if(t.stopPropagation(),h.visible=!h.visible,h.visible){h.addClass("open"),h.removeClass("close");for(var e=0;e<h.children.length;e++)h.children[e].show();h.data.isClosed=!1,n.emit("open",h)}else{h.data.isClosed=!0,h.addClass("close"),h.removeClass("open");for(var e=0;e<h.children.length;e++)h.children[e].hide();n.emit("close",h)}},h.show(),h.isFolder=!0),"item"==a){if(h.isFolder=!1,!t.type){var c=document.createElement("img");t.__image&&(c.src=this.rootPath+"/"+t.__image),l.el.appendChild(c),c.style.pointerEvents="none",h.img=c}if("input"==t.type){var d=new MT.ui.DomElement("span");d.el.innerHTML="88",d.x=50,l.addChild(d),h.head=d}}if(this.options.showHide){h.addClass("show-hide-enabled");var u=this._mkShowHide(h);t.isVisible||u.addClass("hidden"),h.options.showHide=u}if(this.options.lock){h.addClass("lock-enabled");var u=this._mkLock(h);t.isLocked||u.addClass("locked"),h.options.lock=u}return r.el.ondblclick=function(t){h.isFolder&&t.offsetX<30||(n.enableRename(h,t),t.stopPropagation(),t.preventDefault())},h.el.onmouseover=function(t){n.emit("mouseover",t,h)},h.el.onmouseout=function(t){n.emit("mouseout",t,h)},this.items.push(h),h.needRemove=!1,h.tvItem=!0,e.hasClass("close")&&h.hide(),h},checkExistingItem:function(t,e,i){for(var s,o,n=0;n<this.items.length;n++)if(void 0==t.id&&(t.id=this.mkid()),this.items[n].data.id==t.id){this.items[n].needRemove=!1,s=this.items[n],o=s.parent,o&&(o.removeChild(s),o.addChild(s,i).show());for(var a in t)s.data[a]=t[a];return e.hasClass("close")&&s.hide(),s._parent!=e.el&&(s.el.parentNode&&s.el.parentNode.removeChild(s.el),s.parent.removeChild(s),e.addChild(s).show(),e.visible||s.hide()),s.options.showHide&&(t.isVisible?s.options.showHide.removeClass("hidden"):s.options.showHide.addClass("hidden")),s.options.lock&&(t.isLocked?s.options.lock.removeClass("locked"):s.options.lock.addClass("locked")),t.__image&&(s.img?s.img.src=this.rootPath+"/"+t.__image+"?"+Date.now():console.log("WHERE IS IMG?")),s}},addShowHide:function(){for(var t=0;t<this.items.length;t++)this._mkShowHide(this.items[t])},_mkShowHide:function(t){var e=this,i=new MT.ui.Button("","show-hide",null,function(i){t.data.isVisible=!t.data.isVisible,t.data.isVisible?i.target.ctrl.removeClass("hidden"):i.target.ctrl.addClass("hidden"),e.emit("show",t),i.stopPropagation(),i.preventDefault()});return t.head.el.appendChild(i.el),i.parent=t,i},addLock:function(){for(var t=0;t<this.items.length;t++)this._mkLock(this.items[t])},_mkLock:function(t){var e=this,i=new MT.ui.Button("","lock",null,function(i){t.data.isLocked=!t.data.isLocked,t.data.isLocked?i.target.ctrl.removeClass("locked"):i.target.ctrl.addClass("locked"),e.emit("lock",t),i.stopPropagation()});return t.head.el.appendChild(i.el),i.parent=t,i},enableInput:function(t){var e=this;t.on("click",function(t){if(t.target.ctrl&&t.target.ctrl.hasParent(e.tree)&&!e.dragged){var i=e.getOwnItem(t.target.parentNode.parentNode);i&&e.emit("click",i.data,i)}})},sortable:function(t){var e=this.addItem({name:"xxx",skip:!0},this.tree,0,!0);e.style.position="absolute",e.style.pointerEvents="none",e.style.bottom="auto",e.style.opacity=.6;var i=document.createElement("div");i.style.position="absolute",i.style.height="4px",i.style.border="solid 1px #000",i.style.left=0,i.style.right=0,i.style.pointerEvents="none",i.style.display="none";var s=e.el.parentNode;e.addClass("active ui-wrap"),s.appendChild(e.el),e.style.display="none",s.appendChild(i);var o=this,n=!1,a=0,h=null,l=0,r=!1,c=null,d=!1,u=!1,p=function(t,e){t.el.parentNode&&t.el.parentNode.removeChild(t.el),t.parent.removeChild(t),u?(e.addChild(t),e.visible||t.hide()):(d?e.parent.addChild(t,e.index):e.parent.addChild(t,e.index-1),t.parent.hasClass("close")&&t.hide())};this.enableInput(t),t.on("mousedown",function(i){if(i.target.parentNode&&(h=o.getOwnItem(i.target.parentNode.parentNode))){n=!0,l=o.tree.el.parentNode.scrollTop;var s=h.calcOffsetY(o.tree.el);e.y=s,a=s-t.mouse.y}}),t.on("mouseup",function(t){if(e.style.display="none",i.style.display="none",e.y=0,n){n=!1;for(var s=0;s<o._onDrop.length;s++)if(o._onDrop[s](t,h,c)===!1)return;if(r){if(r=!1,!c||c==h||c.parent==h)return void(c=null);if(p(h,c),h.hasClass("selected"))for(var s=0;s<o.items.length;s++){var a=o.items[s];a.hasClass("selected")&&h!=a&&c!=a&&c.parent!=a&&p(a,c)}o.updateFullPath(o.getData(),null,!0)}}}),t.on("mousemove",function(s){if(n){var p=(a-t.mouse.y,e.y+t.mouse.my-(l-o.tree.el.parentNode.scrollTop));l=o.tree.el.parentNode.scrollTop;var f=0,m=o.getOwnItem(s.target);e.y=p,m&&h&&m!=h&&!m.hasParent(h)&&(e.style.display="block",e.head.el.innerHTML=h.data.name,f=m.calcOffsetY(i.parentNode),Math.abs(p-f)>e.el.offsetHeight||(r=!0,d=!1,u=!1,i.style.display="block",i.style.height="4px",p>f&&(f+=e.el.offsetHeight,d=!0),i.style.top=f-2+"px",Math.abs(f-p)<16&&m.isFolder&&(i.style.height=e.el.offsetHeight+"px",u=!0),c=m))}})},enableRename:function(t){var e=this;this.emit("renameStart"),this.input||(this.input=document.createElement("input"),this.input.className="ui-input"),this.input.style.left=t.head.calcOffsetX(document.body)+"px",this.input.style.top=t.calcOffsetY(document.body)-2+"px",this.input.value=t.data.name;var i=t.data.name;this.input.type="text",t.head.label.el.innerHTML="&nbsp;",document.body.appendChild(this.input);var s=!0;this.input.onblur=function(){try{this.parentNode&&this.parentNode.removeChild(this)}catch(o){}if(s&&""!=this.value){var n="";t.parent.data&&(n=t.parent.data.fullPath);var a=t.data.name;t.data.fullPath=n+"/"+this.value,t.data.name=this.value,t.head.label.el.innerHTML=this.value;var h=n+"/"+a,l=n+"/"+this.value;h!==l&&e.emit("change",n+"/"+a,n+"/"+this.value)}else t.head.label.el.innerHTML=i},this.input.onkeyup=function(t){t.which==MT.keys.ESC&&(s=!1,this.blur()),t.which==MT.keys.ENTER&&this.blur()},this.input.focus();var o=t.data.name.split("."),n=0;n=1==o.length?o[0].length:-1;for(var a=0;a<o.length-1;a++)n+=o[a].length+1;this.input.setSelectionRange(0,n),this.inputEnabled=!0},remove:function(){this.tree.hide()},merge:function(t){this.data=t,this.tree.hide();this.tree.el.parentNode;this.updateFullPath(t);for(var e=0;e<this.items.length;e++)this.items[e].needRemove=!0;this.createObject(t,this.tree);for(var e=0;e<this.items.length;e++)this.items[e].needRemove&&(this.items[e].parent.removeChild(this.items[e]),this.items[e].hide(),this.items.splice(e,1),e--,this.emit("deleted",this.items[e]));0!==t.length&&this.tree.show()},getOwnItem:function(t){for(var e=t;e&&(!e.ctrl||!e.ctrl.tvItem);)e=e.parentElement;if(!e)return null;for(var i=0;i<this.items.length;i++)if(e==this.items[i].el)return this.items[i];return null},updateFullPath:function(t,e,i){e=e||"";for(var s=0;s<t.length;s++){var o=e+"/"+t[s].name,n=t[s].fullPath;t[s].fullPath=o,n!=o&&i&&this.emit("change",n,o),t[s].contents&&this.updateFullPath(t[s].contents,t[s].fullPath,i)}i&&this.emit("change",null,null)},select:function(t,e){for(var i=0;i<this.items.length;i++)if(t==this.items[i].data.id)return e?this.items[i]:void this.emit("select",this.items[i].data,this.items[i])},getById:function(t){for(var e=0;e<this.items.length;e++)if(t==this.items[e].data.id)return this.items[e]},show:function(t){this.tree.show(t)}}),MT.namespace("ui"),MT(MT.ui.DomElement=function(t){t=t||"div",this.el=document.createElement(t),this.style=this.el.style,this.el.ctrl=this,this.index=0,this.isVisible=!1,this.children=[]},{_parent:null,appendChild:function(t){return t.parent=this,t.show(this.el),t},hasParent:function(t){for(var e=this.parent;e;){if(e==t)return!0;e=e.parent}},isParentTo:function(t){for(var e=t;e;){if(e==this.el)return!0;e=e.parentNode}return!1},remove:function(){this.el.parentNode&&this.el.parentNode.removeChild(this.el)},show:function(t){void 0==t?(this.parent&&(this._parent=this.parent.el),this._parent||(this._parent=document.body)):this._parent=t,this._parent.appendChild(this.el),this.isVisible=!0},hide:function(){return this.el.parentNode?(this.el.parentNode.removeChild(this.el),this.isVisible=!1,this):this},hideToTop:function(){this.y=-this.height},addClass:function(t){var e=t.split(".");if(e.length>1)for(var i=0;i<e.length;i++)this.addClass(e[i]);else if(e=t.split(" "),e.length>1)for(var i=0;i<e.length;i++)this.addClass(e[i]);else this.hasClass(t)||(this.el.className=(this.el.className+" "+t).trim())},removeClass:function(t){var e=t.split(".");if(e.length>1)for(var i=0;i<e.length;i++)this.removeClass(e[i]);else if(e=t.split(" "),e.length>1)for(var i=0;i<e.length;i++)this.removeClass(e[i]);else{for(var s=this.el.className.split(" "),i=0;i<s.length;i++)t==s[i]&&(s[i]=s[s.length-1],s.length=s.length-1);this.el.className=s.join(" ")}},hasClass:function(t){for(var e=this.el.className.split(" "),i=0;i<e.length;i++)if(t==e[i])return!0;return!1},_x:0,set x(t){this.setX(t)},setX:function(t){this._x=t,this.style.left=t+"px"},get x(){return this.isFitted?this.calcOffsetX():this._x},_y:0,set y(t){this.setY(t)},setY:function(t){this._y=t,this.style.top=t},get y(){return this.isFitted?this.calcOffsetY():this._y},_height:0,get height(){return this.isFitted?this.el.offsetHeight:this._height?this._height:this.el.offsetHeight},set height(t){this.setHeight(t)},setHeight:function(t){this._height=t,this.style.height=0==t?"auto":t+"px"},_width:0,get width(){return this.isFitted?this.el.offsetWidth:this._width?this._width:this.el.offsetWidth},set width(t){this.setWidth(t)},setWidth:function(t){t&&(this._width=t,this.style.width=t+"px")},resize:function(t,e){this.width=t||this._width,this.height=e||this._height},calcOffsetY:function(t){t=t||document.body;var e=this.el.offsetTop;for(p=this.el.offsetParent;p&&p!=t;)e+=p.offsetTop-p.scrollTop,p=p.offsetParent;return e},calcOffsetX:function(t){t=t||document.body;var e=this.el.offsetLeft;for(p=this.el.offsetParent;p&&p!=t;)e+=p.offsetLeft-p.scrollLeft,p=p.offsetParent;return e},ox:0,oy:0,setAbsolute:function(t,e){this.style.position="absolute",t?this.style.bottom=0:this.style.top=0,e?this.style.right=0:this.style.left=0},isFitted:!1,fitIn:function(){this.style.position="absolute",this.style.top=0,this.style.right=0,this.style.bottom=0,this.style.left=0,this.style.height="auto",this.style.width="auto",this.isFitted=!0},unfit:function(){this.isFitted=!1},inheritSize:function(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height},getStyle:function(){return window.getComputedStyle(this.el)},sort:function(t,e){return t.index-e.index},addChild:function(t,e){if(t.index=e,this.children.push(t),this.children.sort(this.sort),void 0!==e)for(var i=null,s=0;s<this.children.length;s++)i=this.children[s],i.index=s,i.el.parentNode&&i.el.parentNode.removeChild(i.el),i.isVisible&&this.el.appendChild(i.el);else t.isVisible&&(t.el.parentNode&&t.el.parentNode!=this.el&&t.el.parentNode.removeChild(t.el),t.el.parentNode!==this.el&&this.el.appendChild(t.el));return t.parent=this,t},removeChild:function(t){t.el.parentNode==this.el&&this.el.removeChild(t.el);for(var e=0;e<this.children.length;e++)if(this.children[e]==t)return void this.children.splice(e,1)},_index:0,get index(){return this._index},set index(t){this._index=t},clear:function(){for(;this.el.children.length;)this.el.children[0].ctrl?this.el.children[0].ctrl.hide():this.el.removeChild(this.el.children[0])},get bounds(){return this.el.getBoundingClientRect()}}),MT.namespace("ui"),MT.extend("ui.DomElement")(MT.ui.PanelHead=function(t){MT.ui.DomElement.call(this),this.addClass("ui-panel-header"),this.panel=t,this.el.panel=t,this.tabs=[]},{addTab:function(t){var e=new MT.ui.DomElement("span");e.addClass("panel-head-tab"),e.title=document.createElement("span"),e.title.innerHTML=t,e.el.setAttribute("title",t),e.el.appendChild(e.title),e.panel=e.el.panel=this.panel;return e.el.data={panel:this.panel},0==this.tabs.length&&e.addClass("active"),this.tabs.push(e),this.appendChild(e),e},removeTab:function(t){for(var e=0;e<this.tabs.length;e++)if(this.tabs[e]==t)return void this.tabs.splice(e,1)},setTabs:function(t){for(var e=0;e<this.tabs.length;e++)this.tabs[e].remove();this.tabs=t;100/this.tabs.length;this.showTabs()},showTabs:function(){this.tabs.length||console.error("TABELEES");for(var t=100/this.tabs.length,e=0;e<this.tabs.length;e++)this.appendChild(this.tabs[e]),this.tabs[e].style.width=t+"%",this.tabs[e].panel==this.panel&&this.setActiveTab(this.tabs[e])},updateTabs:function(){for(var t=0;t<this.tabs.length;t++)this.tabs[t].remove(),this.appendChild(this.tabs[t])},setActiveTab:function(t){t=t||this.panel.mainTab;for(var e=null,i=0;i<this.tabs.length;i++)e=this.tabs[i],e!=t?e.removeClass("active"):e.addClass("active")},setActiveIndex:function(t){for(var e=null,i=0;i<this.tabs.length;i++)e=this.tabs[i],i!=t?e.removeClass("active"):e.addClass("active")}}),MT.namespace("ui"),MT.extend("ui.DomElement")(MT.ui.Button=function(t,e,i,s,o){MT.ui.DomElement.call(this),o&&this.el.setAttribute("data-tooltip",o),this.addClass("ui-button"),e&&this.addClass(e),void 0!=t&&(this.text=t),s&&(this.el.onclick=s)},{set text(t){this.el.innerHTML=t},get text(){return this.el.innerHTML}}),MT.namespace("misc"),MT.misc.tooltips={selectTool:{title:"Select tool",desc:"object selection, rectangle selection, object transformation",tips:["Hold down <i><b>ctrl</b></i> key - to snap objects to the grid while moving","You can easily clone object by holding <i>Alt</i> key before drag"]},stampTool:{title:"Stamp tool",desc:"put objects on the map one by one",tips:["Hold down <i><b>ctrl</b></i> key - to snap objects to the grid"]},brushTool:{title:"Brush tool",desc:"put multiple objects on the map like drawing tiles"},textTool:{title:"Text tool",desc:"create text object"},tileToolsTool:{title:"Tile tool",desc:"allows to put tiles on the tilemap",errors:["You must select <i><b>tileLayer</b></i> object - to use <b>Tile tool</b>"]},physicsTool:{title:"Physics tool",desc:"enable to highlight physics bodies"}},MT.namespace("ui"),MT.require("ui.InputHelper"),MT.extend("ui.DomElement").extend("core.Emitter")(MT.ui.TableView=function(t,e){MT.ui.DomElement.call(this),this.table=document.createElement("table"),this.el.appendChild(this.table);this.header=e,t&&this.setData(t,e);var i=this;this.input=new MT.ui.InputHelper,this.input.on("change",function(t){""==t&&console.log("should remove"),i.input.el.innerHTML=t}),this.input.on("blur",function(){i.updateData(i.input.el)}),this.input.on("tab",function(t){var e=i.input.el;i.input.blur(),i.jumpToNext(e,t.shiftKey)}),this.input.on("enter",function(t){var e=i.input.el;i.input.blur(),i.jumpToNext(e,t.shiftKey)}),this.table.onclick=function(t){t.preventDefault(),t.stopPropagation(),console.log(t.target.data),t.target.data&&i.input.show(t.target)}},{size:0,isKeyValue:!1,toKeyValue:function(){},setData:function(t,e){if(this.table.innerHTML="",this._created=!1,this._allowEmpty=!0,this.origData=t,this.data=JSON.parse(JSON.stringify(t)),this.header=this.header||e,!Array.isArray(this.data)){this.isKeyValue=!0,tmp=this.data,this.data=[];for(var i in tmp)this.data.push([i,tmp[i]])}this.createTable()},jumpToNext:function(t,e){e?t.previousSibling?this.input.show(t.previousSibling):t.parentNode.previousSibling&&t.parentNode.previousSibling.lastChild.data&&this.input.show(t.parentNode.previousSibling.lastChild):t.nextSibling?this.input.show(t.nextSibling):t.parentNode.nextSibling&&this.input.show(t.parentNode.nextSibling.firstChild)},updateData:function(t){var e=t.data.row,i=t.data.index,s=t.innerHTML;if(console.log(e,i,s),-1==e){if(this.isKeyValue&&(i>0||""==s))return void this.createTable();for(var o=[],n="",a=0;a<this.size;a++)o.push(a==i?s:n);e=this.data.length,this.data.push(o),this.allowEmpty=!0}if(this.data[e]){if(this.data[e][i]=s,this.isKeyValue){""==s&&0==i&&(this.data.splice(e,1),this.table.removeChild(this.header?this.table.children[e+1]:this.table.children[e]));for(var h in this.origData)delete this.origData[h];for(var a=0;a<this.data.length;a++)this.origData[this.data[a][0]]=this.data[a][1]}else{this.origData.length=0;for(var a=0;a<this.data.length;a++){this.origData[a]=[];for(var l=0;l<this.data[a].length;l++)this.origData[l]=this.data[a][l]}}this.createTable(),this.emit("change",this.origData)}},_allowEmpty:!0,set allowEmpty(t){this._allowEmpty=t},get allowEmpty(){return this._allowEmpty},_created:!1,createTable:function(){var t,e,i,s,o,n=this.table.firstChild;if(this.header){o=this.header.length,this._created?(t=n,n=t.nextSibling):(t=document.createElement("tr"),this.table.appendChild(t));for(var s=0;s<this.header.length;s++)e=t.children[s]||document.createElement("th"),e.innerHTML=this.header[s],e.parentNode||t.appendChild(e)}for(s=0;s<this.data.length;s++){if(this._created?(t=n,n=t.nextSibling):(t=document.createElement("tr"),this.table.appendChild(t)),!Array.isArray(this.data[s])){this.isKeyValue=!0,i=this.data[s],this.data[s]=[];for(var a in i)this.data[s].push(a),this.data[s].push(s)}for(i=this.data[s],o=0;o<i.length;o++)this.addCell(t,s,o,i[o])}if(this.size=o,this.allowEmpty){t=document.createElement("tr"),this.table.appendChild(t),i=this.data[s];for(var h=0;o>h;h++)this.addCell(t,-1,h,"")}this.allowEmpty=!1,this._created=!0},addCell:function(t,e,i,s){var o=t.children[i]||document.createElement("td");return o.parentNode||t.appendChild(o),o.data={row:e,index:i},o.innerHTML=s,o.setAttribute("width",100),o}}),MT.namespace("core"),MT(MT.core.BasicPlugin=function(t){this.channel=t,this.dealys={}},{initUI:function(t){this.ui=t},initSocket:function(t){if(void 0!=this.channel){var e=this;this.socket=t,this.socket.on(this.channel,function(t,i){var s="a_"+t;e[s]?e[s](i):console.warn("unknown action",e.channel+"["+s+"]",i)})}},send:function(t,e){this.socket.send(this.channel,t,e)},sendDelayed:function(t,e,i){var s=this;this.dealys[t]&&window.clearTimeout(this.dealys[t]),this.dealys[t]=window.setTimeout(function(){s.send(t,e),s.dealys[t]=0},i)}}),MT.namespace("core"),MT(MT.core.Emitter=function(){this.callbacks={}},{on:function(t,e,i){if(void 0==t)return void console.error("undefined action");if("function"!=typeof e)return void console.error("event",t,"not a function:",e);{if(!Array.isArray(t))return this.callbacks||(this.callbacks={}),this.callbacks[t]||(this.callbacks[t]=[]),this.callbacks[t].push(e),e.priority=i||this.callbacks[t].length,this.callbacks[t].sort(function(t,e){return t.priority-e.priority}),e;for(var s=0;s<t.length;s++)this.on(t[s],e)}},once:function(t,e){if("function"!=typeof e)return void console.error("event",t,"not a function:",e);if(Array.isArray(t))for(var i=0;i<t.length;i++)this.once(t[i],e);else{var s=this,o=function(i){e(i,e),s.off(t,o)};this.on(t,o)}},off:function(t,e){if(void 0===e&&(e=t,t=void 0),!t||this.callbacks[t]){if(t)return void this._off(e,t);for(var i in this.callbacks)void 0!=e?this._off(e,i):this.callbacks[i].length=0}},_off:function(t,e){var i=0,s=this.callbacks[e];for(i=0;i<s.length;i++)s[i]===t&&s.splice(i,1);return t},emit:function(t,e,i){if(this.callbacks&&this.callbacks[t])for(var s=this.callbacks[t],o=0;o<s.length;o++)s[o](e,i)},debug:function(t){try{throw new Error}catch(e){var i=e.stack.split("\n");i.splice(0,3),console.log("EMIT: ",t),console.log(i.join("\n"))}}}),MT.namespace("plugins"),MT.extend("core.BasicPlugin")(MT.plugins.Analytics=function(t){MT.core.BasicPlugin.call(this,"Analytics"),this.project=t},{installUI:function(){!function(t,e,i,s,o,n,a){t.GoogleAnalyticsObject=o,t[o]=t[o]||function(){(t[o].q=t[o].q||[]).push(arguments)},t[o].l=1*new Date,n=e.createElement(i),a=e.getElementsByTagName(i)[0],n.async=1,n.src=s,a.parentNode.insertBefore(n,a)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-23132569-11"),document.title+=" - "+this.project.id,ga("send","pageview");var t=Date.now(),e=this;this.project.plugins.tools.on("select",function(e){t=Date.now(),ga("send","event","tool-selected",e)}),this.project.plugins.assetmanager.on("added",function(e){t=Date.now(),ga("send","event","image-added",e)}),this.project.plugins.objectmanager.on("added",function(e){t=Date.now(),ga("send","event","object-added",e)}),this.project.plugins.objectmanager.on("changed",function(e){t=Date.now(),ga("send","event","object-changed",e)}),this.project.plugins.objectmanager.on("beforeSync",function(){t=Date.now(),ga("send","event","working-with-map","sync")});var i=6e4;window.setInterval(function(){t<Date.now()-i&&ga("send","event","idle",e.project.id)},i)}}),MT.namespace("plugins"),MT.extend("core.BasicPlugin")(MT.plugins.DataLink=function(t){MT.core.BasicPlugin.call(this,"DataLink"),this.project=t},{selectElementContents:function(t){var e=document.createRange();e.selectNodeContents(t);var i=window.getSelection();i.removeAllRanges(),i.addRange(e)},initUI:function(){var t=this,e=window.location.origin;e+="/"+this.project.path+"/phaser/js/lib/mt.data.js";var i=this.project.panel.addButton(e,"datalink",function(e){t.selectElementContents(i.el),e.preventDefault()});i.el.onmouseleave=function(){window.getSelection().removeAllRanges()},i.style.left="auto",i.style.right=0,i.style.position="absolute"}}),MT.namespace("plugins"),MT.extend("core.BasicPlugin")(MT.plugins.UndoRedo=function(t){this.project=t,this.buffer=[],this.name="UndoRedo",this._step=0,this.max=20,this.undos=0,window.ur=this,this.capacity=0,this.currentOffset=0;var e=this;this.onKeyDown=function(t){if(t.ctrlKey&&t.which==="Z".charCodeAt(0))if(t.shiftKey)if(e.step<e.buffer.length){var i=e.buffer[e.step];i?(e.om.a_receive(JSON.parse(i),!0),e.step++):console.log("nothing to redo - no data?")}else console.log("nothing to redo");else if(e.step>0){e.step--,console.log(e.step);var i=e.buffer[e.step-1];i?e.om.a_receive(JSON.parse(i),!0):e.step++}},this.checkLocalStorageCapacity()},{set step(t){this._step=t},get step(){return this._step},disable:function(){this.ui.events.off(this.ui.events.KEYDOWN,this.onKeyDown)},enable:function(){this.ui.events.on(this.ui.events.KEYDOWN,this.onKeyDown)},installUI:function(){var t=this,e=localStorage.getItem(this.name);this.data=e?JSON.parse(e):{},this.data[this.project.id]&&(this.buffer=this.data[this.project.id]),this.step=this.buffer.length,this.data[this.project.id]=this.buffer,this.om=this.project.plugins.objectmanager,this.om.on(MT.OBJECTS_SYNC,function(e){var i=JSON.stringify(e);t.buffer[t.step-1]!=i&&(t.step>t.max&&(t.buffer.shift(),t.step--),t.buffer[t.step]=i,t.step++,t.buffer.length=t.step,t.save())}),this.om.on(MT.OBJECTS_UPDATED,function(e){0==t.buffer.length&&(t.buffer.push(JSON.stringify(e)),t.step++)}),this.enable()},cleanUp:function(){for(var t in this.data)this.data[t].shift();this.checkLocalStorageCapacity(),this.currentOffset=0},save:function(){var t=JSON.stringify(this.buffer),e=this.currentOffset;for(this.step-e<=0&&(this.cleanUp(),e=this.currentOffset);t.length>this.capacity&&e<this.step;)e++,t=JSON.stringify(this.buffer.slice(e,this.step));this.currentOffset=e;try{localStorage.setItem(this.name,JSON.stringify(this.data))
}catch(i){e++,this.buffer.slice(this.step-e,this.step),this.save()}},checkLocalStorageCapacity:function(){for(var t="x",e=0,i=1;;){t+=t.substring(0,t.length*i|0);try{localStorage.setItem("test",t),e=t.length}catch(s){if(i-=.1,.1>i)break;t=t.substring(0,e)}}localStorage.removeItem("test"),this.capacity=e}}),MT.namespace("plugins"),MT.require("ui.List"),MT.require("plugins.tools.Select"),MT.require("plugins.tools.Stamp"),MT.require("plugins.tools.Brush"),MT.require("plugins.tools.Text"),MT.require("plugins.tools.TileTool"),MT.require("plugins.tools.Physics"),MT.TOOL_SELECTED="TOOL_SELECTED",MT.extend("core.BasicPlugin").extend("core.Emitter")(MT.plugins.Tools=function(t){MT.core.Emitter.call(this),this.project=t,this.tools={},this.toolsAvailable={select:MT.plugins.tools.Select,Stamp:MT.plugins.tools.Stamp,Brush:MT.plugins.tools.Brush,Text:MT.plugins.tools.Text,TileTool:MT.plugins.tools.TileTool,Physics:MT.plugins.tools.Physics},this.tmpObject=null,this.activeAsset=null,this.activeFrame=0},{initUI:function(t){this.ui=t,this.panel=t.createPanel("toolbox",this.ui.left),this.panel.addClass("toolbox"),this.panel.removeHeader(),this.panel.width=40,this.panel.isResizeable=!1,this.panel.isDockable=!0,t.dockToLeft(this.panel)},installUI:function(){var t=this,e=this.project.plugins.assetmanager,i=this.map=this.project.plugins.mapeditor,s=this.om=this.project.plugins.objectmanager;for(var o in this.toolsAvailable)this.tools[o.toLowerCase()]=new this.toolsAvailable[o](this);e.on(MT.ASSET_SELECTED,function(i){t.activeAsset=i,t.activeFrame=e.activeFrame,t.emit(MT.ASSET_SELECTED,i)}),e.on(MT.ASSET_UNSELECTED,function(e){t.activeAsset=null,t.emit(MT.ASSET_UNSELECTED,e)}),e.on(MT.ASSET_FRAME_CHANGED,function(e,i){t.activeAsset=e,t.activeFrame=i,t.emit(MT.ASSET_FRAME_CHANGED,e,i)});var n=function(e){return e?void t.select(e):void console.error("Failed to select an object")};i.on(MT.TOOL_SELECTED,n),s.on(MT.OBJECT_SELECTED,function(t){n(i.getById(t.id))}),i.selector.on("select",function(e){t.emit(MT.OBJECT_SELECTED,e)}),i.selector.on("unselect",function(e){t.emit(MT.OBJECT_UNSELECTED,e),1!==i.selector.count&&window.setTimeout(function(){if(1==i.selector.count){var t=i.selector.get(0);this.map.activeObject=null,i.selector.emit("select",t),this.map.activeObject=t}},0)}),s.on(MT.OBJECTS_UPDATED,function(){t.emit(MT.OBJECTS_UPDATED)});var a=0,h=[];this.ui.events.on(this.ui.events.KEYUP,function(e){if(a==MT.keys.ESC)return t.setTool(t.tools.select),window.getSelection().removeAllRanges(),void(a=0);if(e.which==MT.keys.DELETE){var o=s.tv.getData();return t.map.selector.forEach(function(t){s.deleteObj(t.id,!0,o),s.selector.clear()}),s.tv.merge(o),s.sync(),void s.update()}a=e.which,window.setTimeout(function(){a=0},500),e.which===MT.keys.ESC&&t.activeTool.deactivate();if(e.ctrlKey){if(e.which===MT.keys.C)return h.length=0,void i.selector.forEach(function(t){h.push(t)});if(e.which===MT.keys.V&&e.target==document.body){var n=t.ui.events.mouse.lastEvent.x,l=t.ui.events.mouse.lastEvent.y;t.map.selector.clear();for(var r=null,c=0,d=0,u=0;u<h.length;u++)r=h[u].getBounds(),c+=r.x,d+=r.y;d/=h.length,c/=h.length;for(var p=null,u=0;u<h.length;u++)r=h[u].getBounds(),p=t.copy(h[u].data,r.x-c+n-i.offsetX,r.y-d+l-i.offsetY),t.map.selector.add(p)}}});for(var o in this.tools)this.tools[o].initUI(this.ui);this.setTool(this.tools.select)},lastAsset:null,select:function(t){this.tools.select.select(t),this.activeTool!=this.tools.select&&this.activeTool.select(t)},copy:function(t,e,i){if(!Array.isArray(t)){var s=this.om.copy(t,e,i),o=this.map.getById(s.id);return this.om.sync(),o}for(var n=0;n<t.length;n++)this.copy(t[n],e,i)},setTool:function(t,e){if(this.activeTool!=t){var i=null;this.activeTool&&(i=this.activeTool,this.activeTool=null,i.button.removeClass("active")),this.activeTool=t,this.activeTool.button.addClass("active"),i&&i.deactivate(),this.activeTool.init(e),this.emit(MT.TOOL_SELECTED,t)}},mouseDown:function(t){return 2===t.button?(this.previousMouseMove=this.map.handleMouseMove,void this.mouseDown_hand(t)):void this.activeTool.mouseDown(t)},mouseUp:function(t){return 2==t.button?void(this.map.handleMouseMove=this.previousMouseMove):void this.activeTool.mouseUp(t)},mouseMove:function(t){this.activeTool.mouseMove(t)},lastSelected:null,selectObject:function(t,e){e&&this.map.selector.clear(),this.map.activeObject=t,this.map.selector.add(t)},initTmpObject:function(t){t=t||this.lastAsset,this.lastAsset=t;var e=this.ui.events.mouse.x,i=this.ui.events.mouse.y,s=this.project.plugins.objectmanager,o=0,n=0;this.tmpObject&&(o=this.tmpObject.x,n=this.tmpObject.y),this.tmpObject?this.tmpObject.update(s.createObject(t)):this.tmpObject=new MT.core.MagicObject(s.createObject(t),this.map.game.world,this.map),this.map.activeObject=this.tmpObject,this.tmpObject.x=o||e,this.tmpObject.y=n||i,this.tmpObject.bringToTop()},removeTmpObject:function(){this.tmpObject&&this.tmpObject.hide(),this.tmpObject=null},mouseDown_hand:function(){this.map.handleMouseMove=this.map._cameraMove},unselectObjects:function(){var t=[];this.map.selector.forEach(function(e){e.data.contents||t.push(e)});for(var e=0;e<t.length;e++)this.map.selector.remove(t[e]);this.map.activeObject=null},hide:function(){this.object.visible=!1}}),MT.namespace("plugins"),MT.extend("core.Emitter").extend("core.BasicPlugin")(MT.plugins.Export=function(t){MT.core.BasicPlugin.call(this,"Export"),this.project=t},{initUI:function(t){var e=this;this.list=new MT.ui.List([{label:"Phaser.io (.js)",className:"",cb:function(){e.export("phaser",function(t){window.location=e.project.path+"/"+t.file})}},{label:"Phaser.io (data only) js",className:"",cb:function(){e.export("phaserDataOnly",function(t){e.openDataLink(t,"js")})}},{label:"Phaser.io (data only) json",className:"",cb:function(){e.export("phaserDataOnly",function(t){e.openDataLink(t,"json")})}}],t,!0);this.button=this.project.panel.addButton("Export",null,function(){e.showList()});this.openGame=this.project.panel.addButton("Open Game",null,function(){e.openLink()})},"export":function(t,e,i){"function"==typeof e&&(i=e,e=null),this.send(t,e),this.once("done",i)},showList:function(){this.list.width=250,this.list.y=this.button.el.offsetHeight,this.list.x=this.button.el.offsetLeft-5,this.list.el.style.bottom="initial",this.list.show(document.body)},openDataLink:function(t,e){"json"==e&&(t.file+="on");var i=.5*window.innerWidth,s=.8*window.innerHeight,o=.5*(window.innerWidth-i),n=.5*(window.innerHeight-s);window.open(this.project.path+"/"+t.file,"","width="+i+",height="+s+",left="+o+",top="+n)},openLink:function(){var t=window.open("about:blank",Date.now());t.opener=null;var e=this.project.path;this.export("phaser",function(){t.location&&(t.location.href=e+"/phaser/index.html")})},a_complete:function(t){this.emit("done",t)}}),MT.namespace("plugins"),MT.require("ui.Input"),MT(MT.plugins.Settings=function(t){this.project=t,this.inputs=[],this.objects={},this.activeId=0},{initUI:function(t){this.panel=t.createPanel("Settings"),this.panel.setFree();this.panel.header.addClass("ui-wrap")},installUI:function(){var t=this;this.project.plugins.tools.on(MT.ASSET_FRAME_CHANGED,function(e){t.handleAssets(e)}),this.project.plugins.tools.on(MT.OBJECT_SELECTED,function(e){t.handleObjects(e),t.active=e.id}),this.project.plugins.tools.on(MT.OBJECT_UNSELECTED,function(){t.clear()});var e=this.project.plugins.mapeditor;e.on("select",function(){t.handleScene(e.settings)})},handleClick:function(){},clear:function(){var t=this.inputs[this.stack];for(var e in t)t[e].hide();return this.stack="",void(this.lastObj=null);var e},addInput:function(t,e,i,s){this.inputs[this.stack]||(this.inputs[this.stack]={});var o=this.inputs[this.stack],n=t;if("string"!=typeof t&&(n=t.key),o[n])return o[n].setObject(e),o[n].show(),o[n];var a=this.panel.content,h=new MT.ui.Input(this.project.ui,t,e);return h.show(a.el),h.style.position="relative",h.style.height="20px",o[n]=h,h.on("change",s),h},lastObj:null,handleAssets:function(t){if(this.ooo=t,void 0===t.contents&&this.lastObj!=t){this.lastObj=t,this.clear(),this.panel.title=t.name;var e=this,i=function(){e.project.am.updateData()};t.key||(t.key=t.fullPath),this.stack="assets",this.addInput({key:"key",type:"text"},t,!1,i),this.addInput({key:"frameWidth",step:1,min:1},t,!1,i),this.addInput({key:"frameHeight",step:1,min:1},t,!0,i),this.addInput("frameMax",t,!1,i),this.addInput({key:"margin",step:1,min:0},t,!0,i),this.addInput({key:"spacing",step:1,min:0},t,!1,i),this.addInput({key:"anchorX",step:.5},t,!0,i),this.addInput({key:"anchorY",step:.5},t,!0,i),this.addInput({key:"fps",step:1},t,!0,i),this.addInput({key:"atlas",value:t.atlas,accept:MT.const.DATA,type:"upload"},t,!0,function(t,i){0!==t.target.files.length&&e.project.am.addAtlas(i,t)}),this.addInput({key:"update",type:"upload",accept:MT.const.IMAGES},t,!0,function(t,i){e.project.am.updateImage(i,t)})}},handleObjects:function(t){if(this.lastObj!=t){this.lastObj=t,this.clear(),this.panel.title=t.name;var e=this,i=function(){e.project.om.update()};t.data.contents?(this.stack="group",this.objects.x=this.addInput("x",t,!0,i),this.objects.y=this.addInput("y",t,!0,i),this.objects.angle=this.addInput("angle",t,!0,i),void 0===t.isFixedToCamera&&(t.isFixedToCamera=0),this.objects.isFixedToCamera=this.addInput({key:"isFixedToCamera",min:0,max:1,step:1},t,!0,i)):t.data.type==MT.objectTypes.TILE_LAYER?(this.stack="layer",this.objects.x=this.addInput("x",t,!0,i),this.objects.y=this.addInput("y",t,!0,i),this.addInput("widthInTiles",t,!0,i),this.addInput("heightInTiles",t,!0,i),this.addInput("tileWidth",t,!0,i),this.addInput("tileHeight",t,!0,i),this.addInput({key:"isFixedToCamera",min:0,max:1,step:1},t,!0,i),this.addInput({key:"anchorX",step:.1},t,!0,i),this.addInput({key:"anchorY",step:.1},t,!0,i)):t.data.type==MT.objectTypes.TEXT?(this.stack="sprite",this.objects.x=this.addInput("x",t,!0,i),this.objects.y=this.addInput("y",t,!0,i),t._framesCount&&(this.objects.frame=this.addInput("frame",t,!0,function(){t.frame>=t._framesCount&&(t.frame=0),t.frame<0&&(t.frame=t._framesCount-1),e.objects.frame.setValue(t.frame,!0),i()})),this.objects.angle=this.addInput("angle",t,!0,i),this.objects.anchorX=this.addInput({key:"anchorX",step:.1},t,!0,i),this.objects.anchorY=this.addInput({key:"anchorY",step:.1},t,!0,i),this.objects.width=this.addInput({key:"width",step:1},t,!0,function(s,o){var n=o/t.scaleX,a=s/n;e.objects.scaleX.setValue(a),i(),e.objects.width.setValue(parseInt(s,10),!0)}),this.objects.wordWrapWidth=this.addInput({key:"wordWrapWidth",step:1},t,!0,i),this.objects.height=this.addInput({key:"height",step:1},t,!0,function(s,o){var n=o/t.scaleY,a=s/n;e.objects.scaleY.setValue(a),i(),e.objects.height.setValue(parseInt(s,10),!0)}),this.objects.scaleX=this.addInput({key:"scaleX",step:.1},t,!0,i),this.objects.scaleY=this.addInput({key:"scaleY",step:.1},t,!0,i)):(this.stack="sprite",this.objects.x=this.addInput("x",t,!0,i),this.objects.y=this.addInput("y",t,!0,i),t._framesCount&&(this.objects.frame=this.addInput("frame",t,!0,function(){t.frame>=t._framesCount&&(t.frame=0),t.frame<0&&(t.frame=t._framesCount-1),e.objects.frame.setValue(t.frame,!0),i()})),this.objects.angle=this.addInput("angle",t,!0,i),this.objects.anchorX=this.addInput({key:"anchorX",step:.1},t,!0,i),this.objects.anchorY=this.addInput({key:"anchorY",step:.1},t,!0,i),this.objects.width=this.addInput({key:"width",step:1},t,!0,function(s,o){var n=o/t.scaleX,a=s/n;e.objects.scaleX.setValue(a),i(),e.objects.width.setValue(parseInt(s,10),!0)}),this.objects.height=this.addInput({key:"height",step:1},t,!0,function(s,o){var n=o/t.scaleY,a=s/n;e.objects.scaleY.setValue(a),i(),e.objects.height.setValue(parseInt(s,10),!0)}),this.objects.scaleX=this.addInput({key:"scaleX",step:.1},t,!0,i),this.objects.scaleY=this.addInput({key:"scaleY",step:.1},t,!0,i)),this.objects.alpha=this.addInput({key:"alpha",min:0,max:1,step:.1},t,!0,i)}},update:function(){for(var t in this.objects)this.objects[t].update()},updateObjects:function(t){t.id!=this.activeId;for(var e in this.objects)this.objects[e].obj=t,this.objects[e].setValue(t[e],!0)},handleScene:function(t){this.clear(),this.stack="scene";var e=this,i=function(){e.project.plugins.mapeditor.updateScene(t)};this.scene={},this.scene.cameraX=this.addInput({key:"cameraX"},t,!0,i),this.scene.cameraY=this.addInput({key:"cameraY"},t,!0,i),this.scene.worldWidth=this.addInput({key:"worldWidth"},t,!0,i),this.scene.worldHeight=this.addInput({key:"worldHeight"},t,!0,i),this.scene.viewportWidth=this.addInput({key:"viewportWidth"},t,!0,i),this.scene.viewportHeight=this.addInput({key:"viewportHeight"},t,!0,i),this.scene.gridX=this.addInput({key:"gridX",min:2},t,!0,i),this.scene.gridY=this.addInput({key:"gridY",min:2},t,!0,i),this.scene.showGrid=this.addInput({key:"showGrid",min:0,max:1},t,!0,i),this.scene.backgroundColor=this.addInput({key:"backgroundColor",type:"color"},t,!0,i)},updateScene:function(t){for(var e in this.scene)this.scene[e].obj=t,this.scene[e].setValue(t[e])}}),MT.namespace("plugins"),function(){var t="js/";t+=window.release?"phaser.min.js":"phaser.js",MT.requireFile(t,function(){MT.requireFile("js/phaserHacks.js")})}(),MT.require("core.Helper"),MT.require("core.Selector"),MT.require("core.MagicObject"),MT.MAP_OBECTS_ADDED="MAP_OBECTS_ADDED",MT.SYNC="SYNC",MT.plugins.MapEditor=MT.extend("core.Emitter").extend("core.BasicPlugin")(function(t){MT.core.BasicPlugin.call(this,"map"),this.project=t,this.assets=[],this.objects=[],this.tmpObjects=[],this.oldObjects=[],this.groups=[],this.oldGroups=[],this.loadedObjects=[],this.tileLayers=[],this.dist={},this.selection=new Phaser.Rectangle,this.selector=new MT.core.Selector,this.helperBoxSize=6,this.settings={cameraX:0,cameraY:0,worldWidth:800,worldHeight:480,viewportWidth:800,viewportHeight:480,gridX:64,gridY:64,gridOffsetX:0,gridOffsetY:0,showGrid:1,backgroundColor:"#111111"},this.zoom=1,window.map=this},{_mousedown:!1,getTileMap:function(t){var e=t.tileWidth||64,i=t.tileHeight||64;return this.game.add.tilemap(null,e,i,t.widthInTiles,t.heightInTiles)},addTileLayer:function(t){var e=this.getTileMap(t),i=e.createBlankLayer(t.name,t.widthInTiles,t.heightInTiles,t.tileWidth,t.tileHeight);return i.fixedToCamera=t.isFixedToCamera,i},updateTileMap:function(t,e){return e.destroy(),this.addTileLayer(t)},setZoom:function(t){this.zoom=1/t,this.resize()},initUI:function(t){this.ui=t;var e=this;this.panel=t.createPanel("Map editor"),this.panel.on("show",function(){e.ui.refresh()}),t.setCenter(this.panel),this.ui.on(t.events.RESIZE,function(){e.resize()}),this.selector.on("unselect",function(t){e.emit(MT.OBJECT_UNSELECTED,t)}),this.createMap();var i=(this.project.plugins.tools,this.project.plugins.objectmanager),s=!1;t.events.on(t.events.MOUSEDOWN,function(t){t.target==game.canvas&&(s=!0,e.handleMouseDown(t))}),window.oncontextmenu=function(t){t.target==e.game.canvas&&t.preventDefault()},this.isCtrlDown=!1,t.events.on(t.events.MOUSEUP,function(t){e.handleMouseUp(t),s=!1});t.events.on(t.events.MOUSEMOVE,function(t){return t.target==game.canvas||2==t.button||s?void 0===e.handleMouseMove?void console.log("chrome bugging"):void e.handleMouseMove(t):void 0}),t.events.on(t.events.KEYDOWN,function(t){var i=t.which;return t.ctrlKey&&(e.isCtrlDown=!0),t.target==game.canvas||t.target==document.body?i==MT.keys.ESC?(e.activeObject=null,void e.selector.clear()):void e.selector.forEach(function(i){e.moveByKey(t,i)}):void 0}),t.events.on(t.events.KEYUP,function(){e.isCtrlDown=!1,i.sync()})},installUI:function(){var t=this;this.tools=this.project.plugins.tools,this.project.plugins.assetmanager.on(MT.ASSETS_UPDATED,function(e){t.addAssets(e)}),this.project.plugins.objectmanager.on(MT.OBJECTS_UPDATED,function(e){t.addObjects(e)}),this.project.plugins.objectmanager.on(MT.OBJECT_DELETED,function(e){for(var i,s=0;s<t.loadedObjects.length;s++)if(i=t.loadedObjects[s],i.id==e)return t.loadedObjects.splice(s,1),i.remove(),void(t.activeObject==i&&(t.activeObject=null))}),this.tools.on(MT.ASSET_FRAME_CHANGED,function(e,i){t.activeObject&&(t.activeObject.frame=i,t.sync())})},createMap:function(){this.game&&(this.game.canvas.parentNode.removeChild(this.game.canvas),this.game.destroy());var t=this;this.activeObject=null;var e=null,i=function(t){t.highlight(e)},s=this.game=window.game=new Phaser.Game(800,600,Phaser.CANVAS,"",{preload:function(){s.stage.disableVisibilityChange=!0;var e=s.canvas;e.parentNode.removeChild(e),t.panel.content.el.appendChild(e),e.style.position="relative",t.panel.content.style.overflow="hidden"},create:function(){t.resize(),t.scale=s.camera.scale,e||(e=s.canvas.getContext("2d")),t.setCameraBounds(),t.postUpdateSetting(),t.game.plugins.add({postUpdate:function(){for(var e=0;e<t.tileLayers.length;e++){var i=t.tileLayers[e];i.fixedToCamera||(i._mc.x||i._mc.y)&&(i._ox=i._mc.x,i._oy=i._mc.y,i.x+=i._mc.x,i.y+=i._mc.y)}},postRender:function(){for(var e=0;e<t.tileLayers.length;e++){var i=t.tileLayers[e];i.fixedToCamera||(void 0!==i._ox&&(i.x-=i._ox,i._ox=void 0),void 0!==i._oy&&(i.y-=i._oy,i._oy=void 0))}}});var i=window.graphics=new PIXI.Graphics;i.beginFill(16777215),i.drawRect(0,0,t.game.canvas.width,-t.game.camera.y),i.drawRect(t.settings.viewportWidth,-t.game.camera.y,t.game.canvas.width,t.settings.viewportHeight),i.drawRect(0,t.settings.viewportWidth,t.game.canvas.width,t.game.canvas.height),i.drawRect(0,-t.game.camera.y,-t.game.camera.x,t.settings.viewportHeight),i.endFill(),i.alpha=.05,i.postUpdate=i.preUpdate=function(){},i.update=function(){i.graphicsData[0].points[2]=t.game.canvas.width,i.graphicsData[0].points[3]=-t.game.camera.y,i.graphicsData[1].points[0]=t.settings.viewportWidth*t.game.camera.scale.x-t.game.camera.x,i.graphicsData[1].points[1]=-t.game.camera.y,i.graphicsData[1].points[2]=t.game.canvas.width+t.game.camera.x,i.graphicsData[1].points[3]=t.settings.viewportHeight*t.game.camera.scale.y,i.graphicsData[2].points[1]=t.settings.viewportHeight*t.game.camera.scale.y-t.game.camera.y,i.graphicsData[2].points[2]=t.game.canvas.width,i.graphicsData[2].points[3]=t.game.canvas.height+t.game.camera.y,i.graphicsData[3].points[1]=-t.game.camera.y,i.graphicsData[3].points[2]=-t.game.camera.x,i.graphicsData[3].points[3]=t.settings.viewportHeight*t.game.camera.scale.y},map.game.stage.children.unshift(i),i.parent=map.game.stage},render:function(){e.globalAlpha=1,t.drawGrid(e),t.selector.forEach(i),t.drawSelection(e),t.highlightDublicates(e),t.drawPhysics(e)}})},update:function(){return},resize:function(){this.game&&this.game.world&&(this.game.width=this.panel.content.el.offsetWidth,this.game.height=this.panel.content.el.offsetHeight,this.game.renderer.resize(this.game.width,this.game.height),this.setCameraBounds(),this.reloadObjectsDelayed())},_reloadDelay:0,reloadObjectsDelayed:function(){this._reloadDelay&&window.clearTimeout(this._reloadDelay);var t=this;this._reloadDelay=window.setTimeout(function(){t._reloadDelay=0,t.reloadObjects()},500)},setCameraBounds:function(){this.game.camera.bounds.x=-1/0,this.game.camera.bounds.y=-1/0,this.game.camera.bounds.width=1/0,this.game.camera.bounds.height=1/0,this.game.camera.view.width=this.game.canvas.width/this.game.camera.scale.x,this.game.camera.view.height=this.game.canvas.height/this.game.camera.scale.y},updateSettings:function(t){if(t){for(var e in t)this.settings[e]=t[e];this.game.isBooted&&this.game.width&&(this.postUpdateSetting(),this.project.plugins.settings.update())}},postUpdateSetting:function(){this.game.width=this.settings.worldWidth,this.game.height=this.settings.worldHeight,this.setCameraBounds(),this.game.camera.x=this.settings.cameraX,this.game.camera.y=this.settings.cameraY;var t=this.settings.backgroundColor.substring(1),e=parseInt(t,16);this.game.stage.backgroundColor!=e&&this.game.stage.setBackgroundColor(e),this.update()},drawGrid:function(t){if(this.settings.showGrid){var e=t.globalAlpha,i=0,s=this.game;t.save(),t.scale(this.game.camera.scale.x,this.game.camera.scale.y),t.beginPath();for(var o=s.stage.backgroundColor,n=parseInt("FFFFFF",16),a=(n-o).toString(16);a.length<6;)a="0"+a;parseInt(a,16)-o<10&&(a="#000000"),t.strokeStyle="#"+a;var h=this.settings.gridOffsetX%this.settings.gridX-this.settings.gridX,l=this.settings.gridOffsetY%this.settings.gridY-this.settings.gridY,r=s.camera.x/this.scale.x%this.settings.gridX-h,c=s.camera.y/this.scale.y%this.settings.gridY-l,d=s.canvas.width/s.camera.scale.x-h,u=s.canvas.height/s.camera.scale.y-l;i=this.settings.gridX,t.lineWidth=.2,t.globalAlpha=1,t.shadowColor="#000",t.shadowBlur=0,t.shadowOffsetX=.5,t.shadowOffsetY=0,t.beginPath();for(var p=-r;d>p;p+=i)0>p||(t.moveTo(p+.5,.5),t.lineTo(p+.5,u+.5));t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=.5,t.beginPath(),i=this.settings.gridY;for(var f=-c;u>f;f+=i)0>f||(t.moveTo(.5,f+.5),t.lineTo(d+.5,f+.5));t.stroke(),t.lineWidth=.5,t.globalAlpha=1,t.beginPath(),t.moveTo(0,-s.camera.y/this.scale.y),t.lineTo(d,-s.camera.y/this.scale.y),t.moveTo(-s.camera.x/this.scale.x,0),t.lineTo(-s.camera.x/this.scale.x,u),t.stroke(),t.globalAlpha=e,t.restore()}},highlightObject:function(t,e){if(e&&(e.game&&e.parent||(e=this.getById(e.id)))&&this.isVisible(e)){var i=t.globalAlpha,s=e.getBounds(),o=null;o=e.data.contents?e:e.parent||game.world;var n=this.getObjectOffsetX(o),a=this.getObjectOffsetY(o);if(t.save(),t.translate(.5,.5),this.activeObject==e){t.strokeStyle="rgb(255,0,0)",t.lineWidth=1;var h=this.helperBoxSize,l=s.x-.5*h|0,r=l+s.width|0,c=s.y-.5*h|0,d=c+s.height|0;if(e.data.type==MT.objectTypes.TEXT){var u=s.width;e.wordWrap&&(u=e.wordWrapWidth*this.game.camera.scale.x|0,t.strokeRect(s.x-h|0,c+.5*s.height|0,h,h),t.strokeRect(s.x+u|0,c+.5*s.height|0,h,h)),t.strokeRect(0|s.x,0|s.y,0|u,0|s.height)}else{if(e.type==Phaser.SPRITE){e.updateTransform();for(var p=e.worldTransform,f=p.tx,m=p.ty,g=e.rotation,v=e.parent;v;)g+=v.rotation,v=v.parent;var n,a,r,d;return t.strokeStyle="#ffee22",t.beginPath(),t.arc(f,m,5,0,2*Math.PI),t.stroke(),t.strokeStyle="#ff0000",n=p.tx-e.width*e.anchor.x,a=p.ty-e.height*e.anchor.y,r=this.rpx(g,n,a,f,m),d=this.rpy(g,n,a,f,m),t.beginPath(),t.arc(r,d,5,0,2*Math.PI),t.stroke(),n=p.tx+e.width*(1-e.anchor.x),a=p.ty-e.height*e.anchor.y,r=this.rpx(g,n,a,f,m),d=this.rpy(g,n,a,f,m),t.beginPath(),t.arc(r,d,5,0,2*Math.PI),t.stroke(),n=p.tx-e.width*e.anchor.x,a=p.ty+e.height*(1-e.anchor.y),r=this.rpx(g,n,a,f,m),d=this.rpy(g,n,a,f,m),t.beginPath(),t.arc(r,d,5,0,2*Math.PI),t.stroke(),n=p.tx+e.width*(1-e.anchor.x),a=p.ty+e.height*(1-e.anchor.y),r=this.rpx(g,n,a,f,m),d=this.rpy(g,n,a,f,m),t.beginPath(),t.arc(r,d,5,0,2*Math.PI),void t.stroke()}t.strokeRect(0|s.x,0|s.y,0|s.width,0|s.height),e.type!=Phaser.TILE_LAYER}}else t.strokeStyle="rgb(255,100,0)",t.strokeRect(0|s.x,0|s.y,s.width,s.height);t.strokeStyle="#ffffff",t.lineWidth=1;for(var v=o.parent,b=[];v;)b.push({x:v.x,y:v.y,r:v.rotation}),v=v.parent;for(;b.length;){var y=b.pop();t.translate(y.x,y.y),t.rotate(y.r),t.translate(-y.x,-y.y)}t.translate(n,a),t.rotate(o.rotation),t.translate(-n,-a),t.beginPath(),t.moveTo(n,a),t.lineTo(n,a-16),t.stroke(),t.strokeRect(n-4,a-4,8,8),t.globalAlpha=i,t.restore()}},drawPhysics:function(t){if(this.enabledPhysics)for(var e=0;e<this.loadedObjects.length;e++)this.drawPhysicsBody(t,this.loadedObjects[e])},drawPhysicsBody:function(t,e){if(e&&(e.game&&e.parent||(e=this.getById(e.id)))&&e.isVisible&&!e.data.contents){var i=e.data.physics;if(!i||!i.enable){var s=e.object.parent;if(s=e.parent==e.game.world?this.settings.physics:s.magic.data.physics,!s||!s.enable)return;i=s}{var o=(t.globalAlpha,e.object.worldTransform);o.tx,o.ty}t.save(),t.fillStyle="rgb(100,200,70)",t.globalAlpha=.2;var n=e.width,a=e.height;i.size.width>0&&(n=i.size.width),i.size.height>0&&(a=i.size.height),t.translate(o.tx,o.ty),t.rotate(e.object.rotation),t.scale(this.scale.x,this.scale.y),t.fillRect(-n*e.object.anchor.x+i.size.offsetX,-a*e.object.anchor.y+i.size.offsetY,n,a),t.restore()}},drawSelection:function(t){this.selection.empty||(t.save(),t.strokeStyle="rgba(0,70, 150, 0.8)",t.fillStyle="rgba(0,70, 150, 0.2)",t.strokeRect(this.selection.x-this.game.camera.x,this.selection.y-this.game.camera.y,this.selection.width,this.selection.height),t.fillRect(this.selection.x-this.game.camera.x,this.selection.y-this.game.camera.y,this.selection.width,this.selection.height),t.restore())},highlightDublicates:function(t){if(this.isCtrlDown){var e=null,i=null,s=null;t.save(),t.fillStyle="rgba(150, 70, 20, 0.3)";for(var o=0;o<this.loadedObjects.length;o++)if(e=this.loadedObjects[o],e.isVisible&&!e.data.contents)for(var n=o;n<this.loadedObjects.length;n++)i=this.loadedObjects[n],e!=i&&e.x==i.x&&e.y==i.y&&e.assetId==i.assetId&&e.width==i.width&&e.data.type==i.data.type&&(s=e.object.getBounds(),t.fillRect(0|s.x,0|s.y,0|s.width,0|s.height));t.restore()}},isAssetsAdded:!1,assetsTimeout:0,addAssets:function(t,e){if(!this.game.isBooted||!this.game.width){var i=this;return window.clearTimeout(this.assetsTimeout),void(this.assetsTimeout=window.setTimeout(function(){i.addAssets(t)},100))}window.clearTimeout(this.assetsTimeout);var i=(this.game,this);e||(this.isAssetsAdded=!t.length);for(var s=0;s<t.length;s++)this.addAsset(t[s],function(){i.assetsToLoad--,0==i.assetsToLoad&&(i.isAssetsAdded=!0,i.reloadObjects())})},assetsToLoad:0,addAsset:function(t,e){if(this.assetsToLoad++,t.contents)return this.addAssets(t.contents,!0),void("function"==typeof e&&window.setTimeout(e,0));var i=(this.game,this.project.path+"/"+t.__image);if(!MT.core.Helper.isImage(i))return void("function"==typeof e&&e());var s=this;if(t.atlas){var o=t.atlas.split(".").pop().toLowerCase();return void MT.loader.get(s.project.path+"/"+t.atlas+"?"+Date.now(),function(n){var a=null,h=Phaser.Loader.TEXTURE_ATLAS_XML_STARLING;"json"==o?(a=s.parseJSON(n),h=Array.isArray(a.frames)?Phaser.Loader.TEXTURE_ATLAS_JSON_ARRAY:Phaser.Loader.TEXTURE_ATLAS_JSON_HASH):a=s.parseXML(n),a?s.loadImage(i+"?"+Date.now(),function(){s.game.cache.addTextureAtlas(t.id,t.__image,this,a,h),s.findAtlasNames(t.id),e()}):console.error("failed to parse atlas")})}this.loadImage(i+"?"+Date.now(),function(){t.width!=t.frameWidth||t.width!=t.frameHeight?s.game.cache.addSpriteSheet(t.id,t.__image,this,t.frameWidth,t.frameHeight,t.frameMax,t.margin,t.spacing):s.game.cache.addImage(t.id,t.__image,this),e()})},parseXML:function(t){var e;try{if(window.DOMParser){var i=new DOMParser;e=i.parseFromString(t,"text/xml")}else e=new ActiveXObject("Microsoft.XMLDOM"),e.async="false",e.loadXML(t)}catch(s){e=void 0}if(!e||!e.documentElement||e.getElementsByTagName("parsererror").length)throw new Error("Phaser.Loader. Invalid Texture Atlas XML given");return e},parseJSON:function(t){var e=null;try{e=JSON.parse(t)}catch(i){console.error(i),e=null}return e},ajax:function(t,e){var i=new XMLHttpRequest;i.open("get",t),i.onreadystatechange=function(){4===i.readyState&&e(i.responseText)},i.onerror=function(){console.error("couldn't load asset",t),e()},i.setRequestHeader("X-Requested-With","XMLHttpRequest"),i.send(null)},loadImage:function(t,e){var i=new Image;i.onload=e,i.onerror=function(){console.error("couldn't load asset",t),e()},i.src=t},atlasNames:{},findAtlasNames:function(t){if(!this.game.cache._images[t]||!this.game.cache._images[t].frameData)return void console.error("Failed to parse atlas");for(var e=this.game.cache._images[t].frameData,i=Object.keys(e._frameNames),s="",o={},n="",a=0,h="",l=0;l<i.length;l++)s=i[l]||"unnamed",n=s.substring(0,s.indexOf(0)),n||(n=s),void 0===o[n]&&(o[n]={start:a,end:a}),h&&h!=n&&(o[h].end=a),h=n,a++;0==i.length?o.unnamed={start:0,end:0}:o[h].end=a,o.all_frames={start:0,end:e._frames.length},this.atlasNames[t]=o,this.project.plugins.assetmanager.selectActiveAsset(),this.atlasNames[t]=o,this.project.plugins.assetmanager.selectActiveAsset()},cleanImage:function(t){this.game.cache.removeImage(t)},checkId:function(){for(var t=null,e=0;e<this.objects.length;e++){t=this.objects[e];for(var i=0;i<this.objects.length;i++)t!=this.objects[i]&&t.id==this.objects[i].id&&console.error("dublicate id")}},_addTimeout:0,addObjects:function(t,e){if(!this.isAssetsAdded){var i=this;return this._addTimeout&&(window.clearTimeout(this._addTimeout),this._addTimeout=0),void(this._addTimeout=window.setTimeout(function(){i.addObjects(t,e),this._addTimeout=0},100))}for(var s,o=0;o<this.loadedObjects.length;o++)s=this.loadedObjects[o],s.isRemoved=!0;e=e||game.world,this._addObjects(t,e);for(var o=0;o<this.loadedObjects.length;o++)s=this.loadedObjects[o],s.isRemoved&&(this.loadedObjects.splice(o,1),s.remove(),o--);this.emit(this,MT.MAP_OBECTS_ADDED)},_destroyObject:function(t){t.destroy(!0)},_addObjects:function(t,e){for(var i,s=t.length-1;s>-1;s--)i=this.getById(t[s].id),i||(i=new MT.core.MagicObject(t[s],e,this),this.loadedObjects.push(i)),i.bringToTop(),i.isRemoved=!1,i.update(t[s],e),t[s].contents&&this._addObjects(t[s].contents,i.object)},resort:function(){for(var t,e=0;e<this.loadedObjects.length;e++)t=this.loadedObjects[e],t.bringToTop();this.tools.tmpObject&&this.tools.tmpObject.bringToTop()},addGroup:function(t){return void console.error("removed")},addObject:function(t,e){return void console.log("removed - addObject")},reloadObjects:function(){this.loadedObjects&&!this._addTimeout&&this.addObjects(this.loadedObjects)},_activeObject:null,_justSelected:null,get activeObject(){return this._activeObject?(this._activeObject.game||(this._activeObject=this.getById(this._activeObject.xxx.id)),this._activeObject):null},set activeObject(t){this._activeObject=t},get offsetX(){return this.panel.content.calcOffsetX()-this.game.camera.x},get offsetY(){return this.panel.content.calcOffsetY()-this.game.camera.y},get offsetXCam(){return this.panel.content.calcOffsetX()+this.game.camera.x},get offsetYCam(){return this.panel.content.calcOffsetY()+this.game.camera.y},get ox(){return this.panel.content.calcOffsetX()},get oy(){return this.panel.content.calcOffsetY()},handleMouseDown:function(t){if(0==t.button)for(var e in this.dist)this.dist[e].x=0,this.dist[e].y=0;this.tools.mouseDown(t)},handleMouseUp:function(t){this.tools.mouseUp(t)},emptyFn:function(){},_handleMouseMove:function(){},set handleMouseMove(t){this._handleMouseMove=t},get handleMouseMove(){return this._handleMouseMove},_cameraMove:function(){this.game.camera.x-=this.ui.events.mouse.mx,this.game.camera.y-=this.ui.events.mouse.my,this.settings.cameraX=this.game.camera.x,this.settings.cameraY=this.game.camera.y,this.project.plugins.settings.updateScene(this.settings),this.update()},dist:null,updateMouseInfo:function(t){this.selector.forEach(function(e){e.mouseInfo.x=t.x,e.mouseInfo.y=t.y})},_objectMove:function(t,e){if(!e){var i=this;return void this.selector.forEach(function(e){i._objectMove(t,e)})}var s=(this.ui.events.mouse.mx+this.ox,this.ui.events.mouse.my+this.oy,this.ui.events.mouse);e.moveObject(s.x+s.mx,s.y+s.my,t)},enabledPhysics:!1,enablePhysics:function(){this.enabledPhysics=!0},disablePhysics:function(){this.enabledPhysics=!1},moveByKey:function(t,e){var i=t.which,s=1;t.ctrlKey&&(s=37==i||39==i?this.settings.gridX:this.settings.gridY),i==MT.keys.LEFT&&(e.x-=s),i==MT.keys.UP&&(e.y-=s),i==MT.keys.RIGHT&&(e.x+=s),i==MT.keys.DOWN&&(e.y+=s)},_followMouse:function(t,e){this.activeObject&&(this.activeObject.x=(t.x-this.ox+this.game.camera.x)/this.scale.x,this.activeObject.y=(t.y-this.oy+this.game.camera.y)/this.scale.y,(t.ctrlKey||e)&&(this.activeObject.x=Math.round(this.activeObject.x/this.settings.gridX)*this.settings.gridX,this.activeObject.y=Math.round(this.activeObject.y/this.settings.gridY)*this.settings.gridY))},sync:function(){},createObject:function(t){var e=this.createSprite(t);return this.tmpObjects.push(e),e},removeObject:function(t){for(var e=0;e<this.tmpObjects.length;e++)this.tmpObjects[e]==t&&(this.tmpObjects.splice(e,1)[0].destroy(),e--)},updateScene:function(t){this.updateSettings(t),this.sendDelayed("updateData",this.settings,100)},received:!1,a_receive:function(t){this.received||(this.received=!0,this.updateSettings(t))},createActiveObject:function(t){return this.activeObject=this.addObject(t,this.game.world,!0),this.activeObject
},pickObject:function(t,e){t+=this.game.camera.x,e+=this.game.camera.y;var i;if(this.activeObject){if(this.activeObject.data.contents)return this.checkBounds(this.activeObject,t,e);if((this.activeObject.type==MT.objectTypes.SPRITE||this.activeObject.type==MT.objectTypes.TEXT)&&(i=this._pick(this.activeObject,t,e)))return i}for(var s=(new Phaser.Point(0,0),this.game.input.activePointer,this.loadedObjects.length-1);s>-1;s--){i=this.loadedObjects[s];var o=this._pick(i,t,e);if(o)return o}return null},_pick:function(t,e,i){return t.isVisible?t.data.contents?null:t.isLocked?null:t.object.input?t.object.input.checkPointerOver(this.game.input.activePointer)?(this.activeObject=t,t):null:this.checkBounds(t,e,i):null},checkBounds:function(t,e,i){var s=t.object.getBounds();return s.contains(e,i)?t.data.type==MT.objectTypes.TILE_LAYER?t.getTile(e+this.game.camera.x,i+this.game.camera.y)?t:null:t:null},selectRect:function(t,e){t.x-=this.game.camera.x,t.y-=this.game.camera.y;for(var i=null,s=null,o=0;o<this.loadedObjects.length;o++)if(s=this.loadedObjects[o],s.data.type!=MT.objectTypes.GROUP){var n=s.object;s.isVisible&&(s.isLocked||s.data.contents||(i=n.getBounds(),i.intersects(t)?this.selector.add(s):e&&this.selector.remove(s)))}t.x+=this.game.camera.x,t.y+=this.game.camera.y},isGroupHandle:function(t,e){return null},createSprite:function(t,e){var i=this.game;e=e||i.world;var s=null;i.cache.getImage(t.assetId)||(t.assetId="__missing"),s=e.create(t.x,t.y,t.assetId),this.inheritSprite(s,t);i.cache.getFrameData(t.assetId);return s},inheritSprite:function(t,e){console.log("removed")},isGroupSelected:function(){return!1},updateSelected:function(){console.log("removed")},getById:function(t){for(var e=0;e<this.loadedObjects.length;e++)if(this.loadedObjects[e].data.id==t)return this.loadedObjects[e]}}),MT.namespace("plugins"),MT.require("ui.TreeView"),MT.require("ui.List"),MT.require("core.Selector"),MT.objectTypes={SPRITE:0,GROUP:1,TEXT:2,TILE_LAYER:3,MOVIE_CLIP:4},MT.OBJECT_ADDED="OBJECT_ADDED",MT.OBJECT_SELECTED="OBJECT_SELECTED",MT.OBJECT_UNSELECTED="OBJECT_UNSELECTED",MT.OBJECT_DELETED="OBJECT_DELETED",MT.OBJECT_UPDATED="OBJECT_UPDATED",MT.OBJECTS_RECEIVED="OBJECTS_RECEIVED",MT.OBJECTS_UPDATED="OBJECTS_UPDATED",MT.OBJECTS_SYNC="OBJECTS_SYNC",MT.extend("core.BasicPlugin").extend("core.Emitter")(MT.plugins.ObjectManager=function(t){MT.core.Emitter.call(this),MT.core.BasicPlugin.call(this,"om"),this.project=t,this.selector=new MT.core.Selector,this.id=Date.now(),this.activeGroup=null},{initUI:function(t){this.ui=t,this.panel=t.createPanel("Objects"),this.panel.setFree();var e=this;this.panel.addOptions([{label:"Add Group",className:"",cb:function(){e.createGroup(),e.panel.options.list.hide()}},{label:"Add TileLayer",className:"",cb:function(){e.createTileLayer(),e.panel.options.list.hide()}},{label:"Group Selected Objects",className:"",cb:function(){e.groupSelected(),e.panel.options.list.hide()}},{label:"Delete Selected Objects",className:"",cb:function(){e.deleteSelected(),e.panel.options.list.hide()}}],t,!0),this.tv=new MT.ui.TreeView([],{root:this.project.path,showHide:!0,lock:!0}),this.tv.on("change",function(){e.update(),e.sync()}),this.tv.sortable(this.ui.events),this.tv.tree.show(this.panel.content.el),this.tv.on("show",function(){e.update()}),this.tv.on("lock",function(){e.update()}),this.tv.on("click",function(t){e.emit(MT.OBJECT_SELECTED,t)})},installUI:function(t){var e=this,i=this.project.plugins.tools;i.on(MT.OBJECT_SELECTED,function(t){var i=e.tv.getById(t.id);i&&(i.isFolder&&(e.activeGroup=i.data),i.addClass("selected.active"),e.selector.add(i))}),i.on(MT.OBJECT_UNSELECTED,function(t){if(t){var i=e.tv.getById(t.id);i&&(e.activeGroup&&e.activeGroup.id==t.id&&(e.activeGroup=null),i.removeClass("selected.active"),e.selector.remove(i))}}),t.events.on(t.events.MOUSEUP,function(){e.sync()}),this.tv.on("deleted",function(t){e.selector.remove(t)})},received:!1,a_receive:function(t,e){return this.received&&!e?void this.update():(this.received=!0,this.tv.merge(t),e||this.emit(MT.OBJECTS_UPDATED,this.tv.getData()),void this.update())},initSocket:function(t){MT.core.BasicPlugin.initSocket.call(this,t)},addObject:function(t,e){if(!e.contents){var i=this.createObject(e,t.offsetX,t.offsetY);this.insertObject(i)}},insertObject:function(t,e,i){i=i||this.tv.getData(),t.id="tmp"+this.mkid(),t.tmpName=t.tmpName||t.name;var s=i;return this.activeGroup&&(s=this.activeGroup.contents),t.name=t.tmpName+this.getNewNameId(t.tmpName,s,0),s.splice(0,-1,t),t.index=-1,e||(this.tv.rootPath=this.project.path,this.tv.merge(i),this.update(),this.sync(),this.emit(MT.OBJECT_ADDED,t)),console.log(t),t},createObject:function(t,e,i){e=e||0,i=i||0;var s=(this.tv.getData(),t.name.split("."));return s.pop(),s=s.join(""),{assetId:t.id,__image:t.__image,x:e,y:i,type:MT.objectTypes.SPRITE,anchorX:t.anchorX,anchorY:t.anchorY,userData:JSON.parse(JSON.stringify(t.userData||{})),physics:JSON.parse(JSON.stringify(t.physics||{})),scaleX:1,scaleY:1,angle:0,alpha:1,tmpName:s,frame:0,isVisible:1,isLocked:0}},createTextObject:function(t,e){t=t||0,e=e||0;var i="Text";return{x:t,y:e,type:MT.objectTypes.TEXT,anchorX:0,anchorY:0,scaleX:1,scaleY:1,angle:0,alpha:1,tmpName:i,wordWrapWidth:100,style:{fontFamily:"Arial",fontSize:32},align:"left",wordWrap:0,isVisible:1,isLocked:0}},createGroup:function(t){for(var e=this.tv.getData(),i="Group",s=i,o=0;o<e.length;o++)e[o].name==s&&(s=i+" "+o);var n={id:"tmp"+this.mkid(),name:s,x:0,y:0,type:MT.objectTypes.GROUP,angle:0,contents:[],isVisible:1,isLocked:0,isFixedToCamera:0,alpha:1};return e.unshift(n),this.tv.merge(e),t||(this.update(),this.sync()),n},createMovieClip:function(t){for(var e=this.tv.getData(),i="Movie",s=i,o=0;o<e.length;o++)e[o].name==s&&(s=i+" "+o);var n={id:"tmp"+this.mkid(),name:s,x:0,y:0,type:MT.objectTypes.MOVIE_CLIP,angle:0,contents:[],isVisible:1,isLocked:0,isFixedToCamera:0,alpha:1};return e.unshift(n),this.tv.merge(e),t||(this.update(),this.sync()),n},createTileLayer:function(t){for(var e=this.tv.getData(),i="Tile Layer",s=i,o=0;o<e.length;o++)e[o].name==s&&(s=i+" "+o);var n={id:"tmp"+this.mkid(),type:MT.objectTypes.TILE_LAYER,name:s,x:0,y:0,anchorX:0,anchorY:0,angle:0,data:[],isVisible:1,isLocked:0,isFixedToCamera:0,tileWidth:64,tileHeight:64,widthInTiles:10,heightInTiles:10,alpha:1};return e.unshift(n),this.tv.merge(e),t||(this.update(),this.sync()),n},copy:function(t,e,i,s,o){s=s||t.name+this.getNewNameId(t.name,this.tv.getData());var n=JSON.parse(JSON.stringify(t));return n.name=s,n.x=e,n.y=i,this.cleanUpClone(n),this.insertObject(n,o),n},multiCopy:function(t,e){for(var i,s,o,n=this.tv.getData(),a=[],h=0;h<t.length;h++)s=t[h],i=s.name+this.getNewNameId(s.name,n),o=JSON.parse(JSON.stringify(s)),o.name=i,this.cleanUpClone(o),e&&e(o),a.push(o),this.insertObject(o,!0,n);return this.tv.rootPath=this.project.path,this.tv.merge(n),this.update(),this.sync(),a},cleanUpClone:function(t,e){if(e=e||0,e++,t.contents)for(var i=0;i<t.contents.length;i++)this.cleanUpClone(t.contents[i],e);t.id="tmp"+this.mkid()},deleteSelected:function(){var t=this.tv.getData();this.selector.forEach(function(e){this.deleteObj(e.data.id,!0,t)},this),this.selector.clear(),this.tv.merge(t),this.ui.events.simulateKey(MT.keys.ESC),this.sync()},deleteObj:function(t,e,i){var s=i||this.tv.getData();this._delete(t,s),i||this.tv.merge(s),e||(this.ui.events.simulateKey(MT.keys.ESC),this.sync(),this.update()),this.emit(MT.OBJECT_DELETED,t)},_delete:function(t,e){for(var i=0;i<e.length;i++){if(e[i].id==t){e.splice(i,1)[0];break}e[i].contents&&this._delete(t,e[i].contents)}},getNewNameId:function(t,e,i){i=i||0;var s=t;i>0&&(s+=i);for(var o=0;o<e.length;o++)e[o].name==s&&(i++,i=this.getNewNameId(t,e,i));return i>0?i:""},buildObjectsTree:function(t){this.tv.rootPath=this.project.path,this.tv.merge(t),this.tv.tree.show(this.panel.content.el)},moveFile:function(t,e){this.send("moveFile",{a:t,b:e})},update:function(){this.emit(MT.OBJECTS_UPDATED,this.tv.getData())},select:function(t){this.tv.select(t)},cleanSelection:function(){},mkid:function(){return this.id++,this.id},groupSelected:function(){var t=this.createGroup(!0),e=this.tv.getData();this.selector.forEach(function(i){var s=i.data;this._delete(s.id,e),t.contents.push(s)},this),this.tv.merge(e),this.send("updateData",e)},_syncTm:0,sync:function(t){this._syncTm&&(window.clearTimeout(this._syncTm),this._syncTm=0);var e=this;this._syncTm=window.setTimeout(function(){var i=e.tv.getData(),s=JSON.stringify(i);return this._lastData==s?void(this._syncTm=0):(this._lastData=s,t||e.emit(MT.OBJECTS_SYNC,i),e.send("updateData",i),void(e._syncTm=0))},100)},getById:function(t){for(var e=this.tv.items,i=0;i<e.length;i++)if(e[i].data.id==t)return e[i].data;return null}}),MT.namespace("plugins"),MT.require("ui.TreeView"),MT.require("ui.List"),MT.ASSET_ADDED="ASSET_ADDED",MT.ASSET_SELECTED="ASSET_SELECTED",MT.ASSET_UNSELECTED="ASSET_UNSELECTED",MT.ASSET_UPDATED="ASSET_UPDATED",MT.ASSET_DELETED="ASSET_DELETED",MT.ASSET_FRAME_CHANGED="ASSET_FRAME_CHANGED",MT.ASSETS_RECEIVED="ASSETS_RECEIVED",MT.ASSETS_UPDATED="ASSETS_UPDATED",MT.extend("core.BasicPlugin").extend("core.Emitter")(MT.plugins.AssetManager=function(t){MT.core.Emitter.call(this),MT.core.BasicPlugin.call(this,"assets"),this.selector=new MT.core.Selector,this.project=t,this.active=null,this.knownFrames={},this.list={},this.__previewCache={},this.panels={},this.scale=0,this.pendingFrame=-1},{get activeFrame(){if(!this.active)return 0;var t=this.active.data.id;return void 0!=this.knownFrames[t]?this.knownFrames[t]:0},set activeFrame(t){if(this.active){var e=this.active.data.id;this.knownFrames[e]=t}},initUI:function(t){var e=this;this.ui=t,this.panel=t.createPanel("Assets"),this.panel.setFree(),this.panel.content.style.padding=0,this.panel.addOptions([{label:"new Folder",className:"",cb:function(){e.newFolder(),e.panel.options.list.hide()}},{label:"delete selected",className:"",cb:function(){e.deleteSelected(),e.panel.options.list.hide()}},{label:"upload file",className:"",cb:function(){e.upload()}},{label:"upload directory",className:"",cb:function(){e.uploadFolder()},check:function(){return window.navigator.userAgent.indexOf("WebKit")>-1?!0:void 0}}]),this.panel.content.el.setAttribute("hint","Drop assets here to upload"),this.tv=new MT.ui.TreeView([],this.project.path),this.tv.sortable(this.ui.events),this.tv.tree.show(this.panel.content.el);var i=function(t,i){t.contents||e.active!=i&&(e.active&&e.active.removeClass("selected"),e.active=i,e.pendingFrame>-1&&(e.activeFrame=e.pendingFrame,e.pendingFrame=-1),e.active.addClass("selected"),e.setPreviewAssets(e.active.data))},s=function(){e.updateData()};this.tv.on("click",function(t,i){var s=!1;if(e.ui.events.mouse.lastClick&&e.ui.events.mouse.lastClick.shiftKey&&(s=!0),s)e.selector.add(i),i.addClass("selected");else{if(t.contents)return;e.selector.forEach(function(t){t.removeClass("active.selected")}),e.selector.clear()}e.active&&!s&&(e.active.removeClass("active.selected"),e.selector.remove(i)),e.selector.add(i),e.active=i,e.active.addClass("active.selected"),e.emit(MT.ASSET_FRAME_CHANGED,e.active.data,e.activeFrame),e.setPreviewAssets(t)}),this.tv.on("select",i),this.tv.on("change",function(t,i){t&&i&&e.moveFile(t,i)}),this.tv.on("open",s),this.tv.on("close",s),this.preview=t.createPanel("assetPreview"),this.preview.setFree(),this.scale=1,this.preview.addOptions(this.mkScaleOptions());var o=window.pce=this.preview.content;t.events.on(t.events.WHEEL,function(t){o.isParentTo(t.target)&&t.shiftKey&&(t.preventDefault(),t.stopPropagation(),e.scale+=.1*(t.wheelDelta/Math.abs(t.wheelDelta)),e.scale>2&&(e.scale=0),e.scale<.1&&(e.scale=.1),e.setPreviewAssets())}),this.project.on(MT.DROP,function(t,i){if(MT.core.Helper.isImage(i.path)){var s=e.tv.getOwnItem(t.target);s&&s.data.contents&&(i.path=s.data.fullPath+i.path),e.createImage(i)}}),t.events.on(t.events.KEYDOWN,function(t){var i=t.which;i==MT.keys.ESC&&e.unselectAll()})},mkScaleOptions:function(){for(var t,e=[],i=100;i>0;i-=10)t={label:i,className:"",cb:this._mkZoomCB(i)},e.push(t);return e},_mkZoomCB:function(t){var e=this;return function(){e.scale=.01*t,e.preview.options.list.hide(),e.setPreviewAssets()}},unselectAll:function(){var t=this;this.selector.forEach(function(e){e.removeClass("active.selected"),t.emit(MT.ASSET_UNSELECTED,e)}),this.selector.clear(),this.preview.content.clear(),this.active&&(this.active.removeClass("active.selected"),t.emit(MT.ASSET_UNSELECTED,this.active),this.active=null)},_previewCache:null,setPreviewAssets:function(t){var e=this.project.plugins.tools;if(!(e&&e.activeTool&&e.activeTool==e.tools.tiletool||(void 0==t&&this.active&&(t=this.active.data),void 0==t||t.contents))){var i,s=this.project.plugins.mapeditor;i=void 0==this.panels[t.id]?[]:this.panels[t.id];var o;if(t.atlas){var n=s.atlasNames[t.id];if(!n)return;n.all_frames&&(o=this.createPreviewPanel("all_frames",i,t,n,!0),this.drawAtlasImage(o));for(var a in n)o=this.createPreviewPanel(a||"xxx",i,t,n,!0),this.drawAtlasImage(o)}else if(i.length>0)this.drawSpritesheet(i[0]),i.active=i[0],this.preview.content.clear();else{o=new MT.ui.Panel(t.name),i.push(o),o.fitIn(),o.addClass("borderless");var h=this.project.plugins.mapeditor.game.cache.getImage(t.id+"");if(!h)return;var l=document.createElement("canvas");l.width=h.width,l.height=h.height;var r=l.getContext("2d");o.data={asset:t,group:i,canvas:l,ctx:r,image:h},o.content.el.appendChild(o.data.canvas),this.drawSpritesheet(o),this.addSpriteEvents(o)}0!=i.length&&(i.active||(i.active=i[0]),i.active.hide(),i.active.show(this.preview.content.el),i.active.data.scrollLeft&&(i.active.content.el.scrollLeft=i.active.data.scrollLeft),i.active.data.scrollTop&&(i.active.content.el.scrollTop=i.active.data.scrollTop),this.panels[t.id]=i)}},createPreviewPanel:function(t,e,i,s,o){for(var n=null,a=0;a<e.length;a++)if(e[a].title==t)return n=e[a],n.data.frames=s[t],n;n=new MT.ui.Panel(t);var h=e[e.length-1];return e.push(n),n.fitIn(),n.addClass("borderless"),n.data={frames:s[t],asset:i,group:e,canvas:document.createElement("canvas"),ctx:null},n.data.ctx=n.data.canvas.getContext("2d"),h&&h.addJoint(n),o?this.addAtlasEvents(n):this.addSpriteEvents(n),n},drawAtlasImage:function(t){{var e=t.data.asset;-1!==e.atlas.split(".").pop().toLowerCase().indexOf("xml")}this.drawAtlasJSONImage(t),t.data.canvas.style.cssText="width: "+t.data.canvas.width*this.scale+"px"},drawAtlasJSONImage:function(t){var e=this.project.plugins.mapeditor,i=e.game,s=i.cache._images[t.data.asset.id],o=null;o=t.data.ctx;var n,a,h=s.frameData,l=s.data,r=0,c=0,d=0;t.data.rectangles=[];var u=t.data.group.active;if(u&&!u.data.frames){u.unjoin(),u.remove();var p=t.data.group.indexOf(u);t.data.group.splice(p,1)}if("all_frames"==t.title){var f=s.data;t.data.canvas.width=f.width,t.data.canvas.height=f.height,o.clearRect(0,0,f.width,f.height),o.drawImage(f,0,0),o.strokeStyle="rgba(0,0,0,0.5);";for(var m=0;m<h._frames.length;m++)n=h.getFrame(m),a=PIXI.TextureCache[n.uuid],t.data.rectangles.push(new Phaser.Rectangle(n.x,n.y,a.width,a.height)),this.activeFrame==m&&(o.fillStyle="rgba(0,0,0,0.5);",o.fillRect(n.x,n.y,a.width,a.height),(!u||!u.data.frames||m<u.data.frames.start||m>u.data.frames.end)&&(t.data.group.active=t)),o.strokeRect(n.x+.5,n.y+.5,a.width,a.height);return void t.content.el.appendChild(t.data.canvas)}for(var m=t.data.frames.start;m<t.data.frames.end;m++)n=h.getFrame(m),a=PIXI.TextureCache[n.uuid],c+=a.width,d<a.height&&(d=a.height);t.data.canvas.width!=c&&(t.data.canvas.width=c,t.data.canvas.height=d),o.clearRect(0,0,c,d);for(var m=t.data.frames.start;m<t.data.frames.end;m++){n=h.getFrame(m);{n.getRect()}a=PIXI.TextureCache[n.uuid],l=a.baseTexture.source;var g=0,v=0;a.trim&&(g=a.trim.x,v=a.trim.y),o.drawImage(l,n.x,n.y,a.width,a.height,r,0,a.width,a.height),t.data.rectangles.push(new Phaser.Rectangle(r,0,a.width,a.height)),this.activeFrame==m&&(o.fillStyle="rgba(0,0,0,0.5);",o.fillRect(r,0,a.width,d),(!u||m<u.data.frames.start||m>u.data.frames.end)&&(t.data.group.active=t)),r+=a.width,o.beginPath(),o.moveTo(r+.5,0),o.lineTo(r+.5,d),o.stroke()}t.content.el.appendChild(t.data.canvas)},drawSpritesheet:function(t){var e=this.project.plugins.mapeditor.game.cache.getImage(t.data.asset.id+""),i=t.data.ctx;if(!e){var s=this;return void window.setTimeout(function(){s.drawSpritesheet(t)},100)}var o=t.data.asset;i.canvas.width=e.width,i.canvas.height=e.height,i.clearRect(0,0,e.width,e.height),i.drawImage(e,0,0,e.width,e.height),i.beginPath();for(var n=o.frameWidth;n<e.width;n+=o.frameWidth+o.spacing)i.moveTo(o.margin+n+.5,o.margin),i.lineTo(n+.5,e.height);for(var n=o.frameHeight;n<e.height;n+=o.frameHeight+o.spacing)i.moveTo(o.margin+0,o.margin+n+.5),i.lineTo(e.width,n+.5);i.stroke();var a=o.margin+o.spacing*Math.floor(e.width/o.frameWidth-o.spacing),h=(e.width-a)/o.frameWidth,l=this.getTileX(this.activeFrame,h),r=this.getTileY(this.activeFrame,h);i.fillStyle="rgba(0,0,0,0.5)",i.fillRect(o.margin+o.frameWidth*l+l*o.spacing+.5,o.margin+o.frameHeight*r+r*o.spacing+.5,o.frameWidth+.5,o.frameHeight+.5)},getTileX:function(t,e){return t%e},getTileY:function(t,e){return t/e|0},addSpriteEvents:function(t){var e=this,i=t.data.canvas,s=!1,o=function(i){var s=e.getFrame(t.data.asset,i.offsetX,i.offsetY);if(s!=e.activeFrame){var o=t.data.asset,n=Math.floor(o.width/o.frameWidth*(o.height/o.frameHeight)-1);s>n||(t.data.scrollTop=t.content.el.scrollTop,t.data.scrollLeft=t.content.el.scrollLeft,e.activeFrame=s,e.emit(MT.ASSET_FRAME_CHANGED,e.active.data,e.activeFrame))}};i.onmousedown=function(t){s=!0,o(t)},i.onmousemove=function(t){s&&o(t)},this.ui.events.on(this.ui.events.MOUSEUP,function(t){s&&(s=!1,o(t))})},addAtlasEvents:function(t){var e=this,i=!1,s=function(i){for(var s=(t.data.frames.end-t.data.frames.start-1,t.data.canvas.width,i.offsetX/e.scale),o=i.offsetY/e.scale,n=t.data.frames.start,a=!1,h=0;h<t.data.rectangles.length;h++)if(t.data.rectangles[h].contains(s,o)){n+=h,a=!0;break}a&&n!=e.activeFrame&&(t.data.scrollTop=t.content.el.scrollTop,t.data.scrollLeft=t.content.el.scrollLeft,e.activeFrame=n,t.data.group.active=t,e.emit(MT.ASSET_FRAME_CHANGED,t.data.asset,n))};t.data.canvas.oncontextmenu=function(){return!1},t.data.canvas.onmousedown=function(t){t.preventDefault(),0==t.button&&(i=!0,s(t))},t.data.canvas.onmousemove=function(t){return 2==t.button?(this.parentNode.scrollTop-=e.ui.events.mouse.my,void(this.parentNode.scrollLeft-=e.ui.events.mouse.mx)):void(i&&s(t))},this.ui.events.on(this.ui.events.MOUSEUP,function(t){i&&0==t.button&&(i=!1,s(t))})},installUI:function(){var t=this;this.project.plugins.tools.on(MT.OBJECT_SELECTED,function(e){e&&(t.pendingFrame=e.frame,t.selectAssetById(e.data.assetId))}),this.project.plugins.tools.on(MT.OBJECT_UNSELECTED,function(e){if(!e)return void t.unselectAll();var i=t.tv.getById(e.assetId);t.emit(MT.ASSET_UNSELECTED,i),t.active&&(t.active.removeClass("selected.active"),t.active=null,t.unselectAll()),t.selector.is(i)&&(i.removeClass("selected.active"),t.selector.remove(i))}),this.on(MT.ASSET_FRAME_CHANGED,function(e,i){t.project.map.selector.forEach(function(s){s.data.assetId=e.id,s.data.__image=e.__image,s.frame=i,t.activeFrame=i,t.project.plugins.objectmanager.update(),t.project.plugins.objectmanager.sync()}),t.setPreviewAssets(e)})},selectAssetById:function(t,e){var i=this.tv.getById(t);return this.tv.select(t),this.selector.add(i),e&&this.setPreviewAssets(i),i},selectActiveAsset:function(t){(void 0!=t||this.active)&&(this.emit(MT.ASSET_FRAME_CHANGED,this.active.data,this.activeFrame),this.setPreviewAssets(this.active.data))},updateImage:function(t,e){var i=this;this.project.plugins.mapeditor.cleanImage(t.id);var s=new Image;this.readFile(e.target.files[0],function(e){s.onload=function(){t.frameWidth=s.width,t.frameHeight=s.height,t.width=s.width,t.height=s.height,t.updated=Date.now(),i.guessFrameWidth(t),i.send("updateImage",{asset:t,data:e.result})},s.src=i.toPng(e.result)})},addAtlas:function(t,e){var i=this,s=e.target.files[0],o=s.name.split(".").pop();if(-1===MT.const.DATA.indexOf(o)){var n=new MT.ui.Popup("Incorrect format","Atlas loading canceled<br /><br />");return n.showClose(),void n.addButton("OK",function(){n.hide()})}this.readFile(s,function(e){i.send("addAtlas",{id:t.id,ext:o,data:e.result})})},getFrame:function(t,e,i){var s=Math.floor(e/(t.frameWidth+t.spacing)),o=Math.floor(i/(t.frameHeight+t.spacing)),n=Math.floor(t.width/t.frameWidth),a=s+n*o;return console.log(a,"frame"),a},update:function(){var t=this.tv.getData();this.active&&this.setPreviewAssets(this.active.data),this.emit(MT.ASSETS_UPDATED,t)},a_receiveFileList:function(t){this.buildAssetsTree(t),this.buildList(t),this.update(),this.updateNotifications(t)},buildList:function(t){for(var e=0;e<t.length;e++)t[e].contents?this.buildList(t[e].contents):this.list[t[e].id]=t[e]},handleDrop:function(t){var e=t.dataTransfer.files;this.handleFiles(e,t.dataTransfer)},handleFiles:function(t,e){for(var i=null,s=0;s<t.length;s++)e?(i=e.items[s].getAsEntry?e.items[s].getAsEntry():e.items[s].webkitGetAsEntry(),this.handleEntry(i)):this.handleFile(t.item(s))},handleFile:function(t){var e=t.webkitRelativePath||t.path||t.name;0==t.size?this.send("newFolder",e):this.uploadImage(t,e)},upload:function(){var t=this,e=document.createElement("input");e.type="file",e.onchange=function(){t.handleFiles(this.files)},e.click(),this.panel.options.list.hide()},uploadFolder:function(){var t=this,e=document.createElement("input");e.type="file",e.setAttribute("webkitdirectory",""),e.setAttribute("directory",""),e.value="",e.onchange=function(){t.handleFiles(this.files)},e.click(),this.panel.options.list.hide()},handleEntry:function(t){var e=this;if(t.isFile)t.file(function(i){e.uploadImage(i,t.fullPath)});else if(t.isDirectory){this.send("newFolder",t.fullPath);var i=t.createReader();i.readEntries(function(t){for(var i=0;i<t.length;i++)e.handleEntry(t[i])})}},initSocket:function(t){MT.core.BasicPlugin.initSocket.call(this,t)},updateData:function(){this.send("updateData",this.tv.getData())},buildAssetsTree:function(t){t.sort(function(t,e){var i=t.contents?1e3:0,s=e.contents?1e3:0,o=t.name>e.name?1:-1;return o+s-i}),this.tv.rootPath=this.project.path,this.tv.merge(t)},moveFile:function(t,e){this.send("moveFile",{a:t,b:e})},newFolder:function(){for(var t=this.tv.getData(),e="new folder",i=e,s=0;s<t.length;s++)t[s].name==i&&(i=e+" "+s);t.unshift({name:i,contents:[]}),this.send("newFolder",i),this.tv.merge(t)},deleteSelected:function(){this.selector.forEach(function(t,e){this.deleteAsset(t.data.id,!e)},this)},deleteAsset:function(t,e){this.project.plugins.mapeditor.cleanImage(t),this.send("delete",t),this.emit(MT.ASSET_DELETED,t),e||this.ui.events.simulateKey(MT.keys.ESC)},getById:function(t){for(var e=this.tv.items,i=0;i<e.length;i++)if(e[i].data.id==t)return e[i].data;return null},readFile:function(t,e){var i=new FileReader;i.onload=function(){e(i)},i.readAsBinaryString(t)},uploadImage:function(t,e){"/"!=e.substring(0,1)&&(e="/"+e);var i=this;this.readFile(t,function(t){i.createImage({src:t.result,path:e})})},notifications:[],createImage:function(t){var e=t.path,i=t.src,s=e.split("/").pop(),o=new Image,n=this;o.onload=function(){var t={data:i,name:s,path:e,fullPath:e,key:e,width:o.width,height:o.height,frameWidth:o.width,frameHeight:o.height,frameMax:-1,margin:0,spacing:0,anchorX:0,anchorY:0,fps:10,updated:Date.now(),atlas:""};n.guessFrameWidth(t),n.send("newImage",t),n.emit(MT.ASSET_ADDED,e);var a=n.project.plugins.notification.show(e,"Upload in progress...",999999);n.notifications[e]=a},o.src=n.toPng(i)},updateNotifications:function(t){for(var e=0;e<t.length;e++){if(this.notifications[t[e].key])return void this.notifications[t[e].key].hide();t[e].contents&&this.updateNotifications(t[e].contents)}},toPng:function(t){return"data:image/png;base64,"+btoa(t)},guessFrameWidth:function(t){var e=t.name.split(".");e.pop();var i=e.join(".").split("_").pop(),s=null;if(i){s=i.split("x");var o=parseInt(s[0],10),n=parseInt(s[1],10);o&&!isNaN(o)&&n&&!isNaN(n)&&(t.frameWidth=o,t.frameHeight=n)}}}),MT.namespace("ui"),MT.require("ui.Button"),MT.require("ui.PanelHead"),MT.extend("core.Emitter").extend("ui.DomElement")(MT.ui.Panel=function(t,e){MT.ui.DomElement.call(this),this.setAbsolute(),this.header=new MT.ui.PanelHead(this),this.mainTab=this.header.addTab(t),this.content=new MT.ui.DomElement,this.appendChild(this.content),this.content.show(this.el),this.content.addClass("ui-panel-content"),this._input=document.createElement("input"),this._input.setAttribute("readonly","readonly"),this._input.style.cssText="position: fixed; top: -99999px;",this.content.el.appendChild(this._input),t&&this.addHeader(),this.title=t,this.buttons=[],this.savedBox={x:0,y:0,width:0,height:0},this.isVisible=!1,this.joints=[this],this.addClass("ui-panel"),this.top=null,this.right=null,this.bottom=null,this.left=null,this.ui=e},{isResizeable:!1,isMovable:!1,isDockable:!1,isJoinable:!1,acceptsPanels:!1,isPickable:!0,isCloaseable:!1,setFree:function(){this.isMovable=!0,this.isDockable=!0,this.isJoinable=!0,this.isDockable=!0,this.isResizeable=!0,this.acceptsPanels=!0},focus:function(){this._input.focus()},addOptions:function(t){this.options={};var e=this.options.list=new MT.ui.List(t,this.ui,!0);e.addClass("settings-list");var i=this,s=this.options.button=new MT.ui.Button(null,"ui-options",null,function(t){t.stopPropagation(),e.isVisible?(e.hide(),s.removeClass("selected")):(e.show(i.header.el),s.addClass("selected"))});return s.show(this.header.el),e.on("hide",function(){s.removeClass("selected")}),this.header.addChild(this.options),e.style.left=0,e.style.right=0,this.options},removeBorder:function(){this.addClass("borderless")},activate:function(){this.show()},reset:function(t){this.dockPosition=t.dockPosition,this.isDocked=t.isDocked,this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.top=null,this.bottom=null,this.joints.length>1&&(this.isVisible=!0,MT.ui.DomElement.show.call(this,this._parent)),this.joints=[this],this.header.tabs=[this.mainTab],this.header.setTabs(this.header.tabs),this.setClearX(t.x),this.setClearY(t.y),this.setClearWidth(t.width),this.setClearHeight(t.height)},setX:function(t){this.setClearX(t),this.top&&this.top.x!=t&&this.top.setX(t),this.bottom&&this.bottom.x!=t&&this.bottom.setX(t)},setClearX:function(t){for(var e=0;e<this.joints.length;e++)MT.ui.DomElement.setX.call(this.joints[e],t)},setWidth:function(t){this.setClearWidth(t),this.top&&this.top.width!=t&&this.top.setWidth(t),this.bottom&&this.bottom.width!=t&&this.bottom.setWidth(t)},setClearWidth:function(t){for(var e=0;e<this.joints.length;e++)MT.ui.DomElement.setWidth.call(this.joints[e],t),this.joints[e].emit("resize",this.width,this.height)},setY:function(t){this.top&&(this.top.height+=t-this.y),this.setClearY(t)},setClearY:function(t){for(var e=0;e<this.joints.length;e++)MT.ui.DomElement.setY.call(this.joints[e],t)},alingCenter:function(){this.x=.5*(window.innerWidth-this.width),this.y=.5*(window.innerHeight-this.height)},setHeight:function(t){this.dockPosition==MT.TOP&&this.bottom&&this.bottom.setClearY(this.bottom.y+(t-this.height)),this.setClearHeight(t),this.left&&this.left.height!=t&&this.left.setWidth(t),this.right&&this.right.width!=t&&this.right.setWidth(t)},setClearHeight:function(t){for(var e=0;e<this.joints.length;e++)MT.ui.DomElement.setHeight.call(this.joints[e],t),this.joints[e].emit("resize",this.width,this.height)},show:function(t,e){if(this.header.showTabs(),this.isVisible)return this;for(var i=0;i<this.joints.length;i++)this.joints[i].hide(!1);return MT.ui.DomElement.show.call(this,t),this.setAll("_parent",this._parent),e!==!1&&this.emit("show"),this.content.fitIn(),this.content.y=this.header.el.offsetHeight,this},addClass:function(t){for(var e=0;e<this.joints.length;e++)MT.ui.DomElement.addClass.call(this.joints[e],t)},removeClass:function(t){for(var e=0;e<this.joints.length;e++)MT.ui.DomElement.removeClass.call(this.joints[e],t)},setJoints:function(t,e){for(var i=0;i<this.joints.length;i++)this.joints[i][t]=e},setAll:function(t,e){this.setJoints(t,e)},setTop:function(t,e){this.setAll(t,e),this.top&&this.top.setTop(t,e)},setBottom:function(t,e){this.setAll(t,e),this.bottom&&this.bottom.setBottom(t,e)},setTopBottom:function(t,e){this.setTop(t,e),this.setBottom(t,e)},setLeftRight:function(){},unjoin:function(){if(1==this.joints.length)return void this.breakSideJoints();this.removeSideJoints();var t=this.joints;this.joints=[this];for(var e=0;e<t.length;e++)if(t[e]==this){t.splice(e,1);break}this.header.removeTab(this.mainTab),this.header.setTabs([this.mainTab]);for(var e=0;e<t.length;e++)if(t[e]!=this){t[e].show(),t[e].header.showTabs();break}},addJoint:function(t){if(!t||this==t)return void console.log("joining with self?");if(t._parent=this._parent,t.removeClass("animated"),this.removeClass("animated"),t.joints!=this.joints){for(var e=0;e<t.joints.length;e++)this.joints.push(t.joints[e]);if(t.setAll("joints",this.joints),this.header.tabs!=t.header.tabs)for(var i=t.header.tabs,s=!0,e=i.length-1;e>-1;e--){for(var o=0;o<this.header.tabs.length;o++)if(this.header.tabs[o]==i[e]){s=!1;break}s&&this.header.tabs.push(i[e])}for(var e=0;e<this.joints.length;e++)this.joints[e].header.tabs=this.header.tabs;this.setAll("top",this.top),this.setAll("bottom",this.bottom)}},_dockPosition:MT.NONE,set dockPosition(t){var e=this.getTopMost();e.setDockPosition(t)},setDockPosition:function(t){this.removeClassAll("docked-left"),this.removeClassAll("docked-right"),this.removeClassAll("docked-top"),this.removeClassAll("docked-bottom"),this.removeClassAll("docked-left-bottom"),this.removeClassAll("docked-left-top"),this.removeClassAll("docked-center"),this.setAll("_dockPosition",t),(t==MT.LEFT||t==MT.RIGHT)&&(this.top||this.addClassAll("docked-left-top"),this.bottom||this.addClassAll("docked-left-bottom"),t==MT.LEFT&&this.addClassAll("docked-left"),t==MT.RIGHT&&this.addClassAll("docked-right")),t==MT.TOP&&this.addClassAll("docked-top"),t==MT.BOTTOM&&this.addClassAll("docked-bottom"),t==MT.CENTER&&this.addClassAll("docked-center"),this.bottom&&this.bottom.setDockPosition(t)},getTopMost:function(){for(var t=this;t.top;)t=t.top;return t},getBottomMost:function(){for(var t=this;t.bottom;)t=t.bottom;return t},get dockPosition(){return this._dockPosition},addClassAll:function(t){for(var e=0;e<this.joints.length;e++)this.joints[e].addClass(t)},removeClassAll:function(t){for(var e=0;e<this.joints.length;e++)this.joints[e].removeClass(t)},joinBottom:function(t,e){t!=this.bottom&&(e||(this.setClearHeight(this.height-t.height),t.setClearWidth(this.width),t.setClearX(this.x),t.setClearY(this.y+this.height)),this.bottom&&(this.bottom.setAll("top",t),t.setAll("bottom",this.bottom)),this.setAll("bottom",t),t.setAll("top",this),t.setAll("top",t.top),t.setAll("bottom",t.bottom))},joinTop:function(t,e){if(t!=this.top){if(!e){this.setClearHeight(this.height-t.height),t.setClearWidth(this.width),t.setClearX(this.x);var i=this.y+this.height;t.setClearY(this.y),this.setClearY(i)}this.top&&(this.top.setAll("bottom",t),t.setAll("top",this.top)),this.setAll("top",t),t.setAll("bottom",this)}},removeSideJoints:function(){if(this.joints.length>1){for(var t=null,e=0;e<this.joints.length&&(t=this.joints[e],t==this);e++);return this.setAll("top",this.top),this.setAll("bottom",this.bottom),this.top&&this.top.setAll("bottom",t),this.bottom&&this.bottom.setAll("top",t),this.top=null,void(this.bottom=null)}this.top&&this.top.setAll("bottom",this.bottom),this.bottom&&this.bottom.setAll("top",this.top),this.top=null,this.bottom=null},_bottom:null,set bottom(t){if("object"!=typeof t)throw new Error("setting top nt non object",t);for(var e=this._bottom,i=0;e;){if(i++,i>10){console.log("recursivity warning");break}e=e._bottom}this._bottom=t},get bottom(){return this._bottom},_top:null,set top(t){if("object"!=typeof t)throw new Error("setting top nt non object",t);for(var e=this._top,i=0;e;){if(i++,i>10){console.log("recursivity warning");break}if(e==this||e==t&&e!=this._top)return console.log("recursivity warning"),void(this._top=t);
e=e._top}this._top=t},get top(){return this._top},breakSideJoints:function(){var t=this.dockPosition;this.bottom?(this.top&&this.top.setAll("bottom",this.bottom),this.bottom.setAll("top",this.top),this.bottom.setClearHeight(this.bottom.height+this.height),this.bottom.setClearY(this.y),this.bottom.setDockPosition(t)):this.top&&(this.top.setAll("bottom",this.bottom),this.top.setClearHeight(this.top.height+this.height)),this.setAll("top",null),this.setAll("bottom",null),this.setAll("left",null),this.setAll("right",null)},_isDocked:!1,set isDocked(t){if(void 0==t)throw new Error("docek");this.setAll("_isDocked",t)},get isDocked(){return this._isDocked},removeJoint:function(t){for(var e=null,i=0;i<this.joints.length;i++)if(e=this.joints[i],e==t)return void this.joints.splice(i,1)},vsBox:function(t){return!(this.x+this.width<t.x||this.y+this.height<t.y||this.x>t.x+t.width||this.y>t.y+t.height)},vsPoint:function(t){return!(this.x+this.width<t.x||this.y+this.height<t.y||this.x>t.x||this.y>t.y)},mouseDown:!1,saveBox:function(t){if(this.isDocked)return void console.warn("saving docked panel");if(this.savedBox.width=this.width,this.savedBox.height=this.height,!t)for(var e=0;e<this.joints.length;e++)this.joints[e].saveBox(!0)},loadBox:function(){this.savedBox.width&&(this.width=this.savedBox.width),this.savedBox.height&&(this.height=this.savedBox.height)},getVisibleJoint:function(){for(var t=0;t<this.joints.length;t++)if(this.joints[t].isVisible)return this.joints[t];return console.log("smth is broken"),this.show(this._parent,!1),this},hide:function(t,e){return this.isVisible?(this.isVisible=!1,MT.ui.DomElement.hide.call(this),void 0!=e?this:(this.emit(t!==!1?"hide":"unselect"),this)):this},close:function(){this.unjoin(),this.hide(),this.emit("close")},addHeader:function(){this.appendChild(this.header),this.header.show(this.el)},removeHeader:function(){this.header.hide(),this.content.y=0},addButton:function(t,e,i,s){var o=null;return o=t&&"object"==typeof t?t:new MT.ui.Button(t,e,this.events,i,s),this.content.addChild(o),this.buttons.push(o),o.show(),o},alignButtons:function(){for(var t=0,e=null,i=0;i<this.buttons.length;i++)e=this.buttons[i],e.x=t,t+=e.width},addButtonV:function(t,e,i){for(var s=new MT.ui.Button(t,e,this.events,i),o=0,n=0;n<this.content.children.length;n++)o+=this.content.children[n].el.offsetHeight;return s.y+=o,this.content.addChild(s),s},getJointNames:function(){for(var t=[],e=0;e<this.joints.length;e++)t.push(this.joints[e].name);return t}}),MT.namespace("ui"),MT(MT.ui.Events=function(){return window.MT.events?(console.warn("events already initialized"),window.MT.events):(window.MT.events=this,this.events={mousemove:[],mouseup:[],mousedown:[],drop:[],dragend:[],drag:[],dragover:[],click:[],resize:[],wheel:[]},this._cbs=[],this.enable(),void(this.mouse={x:0,y:0,mx:0,my:0,down:!1,lastEvent:null,lastClick:null}))},{MOUSEMOVE:"mousemove",MOUSEUP:"mouseup",MOUSEDOWN:"mousedown",RESIZE:"resize",KEYDOWN:"keydown",KEYUP:"keyup",DROP:"drop",WHEEL:"wheel",enable:function(){for(var t in this.events)this.addEvent(t)},disable:function(){for(var t in this.events)document.body.removeEventListener(this._cbs[t].type,this._cbs[t])},on:function(t,e){this.events[t]||(console.warn("new Event:",t),this.events[t]=[],this.addEvent(t));var i=this;return window.setTimeout(function(){i.events[t].push(e)},0),e},addEvent:function(t){var e=this._mk_cb(t);this._cbs.push(e),window.addEventListener(t,e,!1)},off:function(t,e){var i=null;if(void 0===e)for(var s in this.events){i=this.events[s];for(var o=0;o<i.length;o++)i[o]==e&&(i[o]=i[i.length-1],i.length=i.length-1)}else{i=this.events[t];for(var o=0;o<i.length;o++)i[o]==e&&(i[o]=i[i.length-1],i.length=i.length-1)}},simulateKey:function(t){this.emit(this.KEYDOWN,{which:t,target:document.body})},emit:function(t,e){this.events[t]||console.warn("unknown event",t);for(var i=this.events[t],s=0;s<i.length;s++)i[s](e)},_mk_mousemove:function(){var t=this,e=function(e){e.x=e.x||e.pageX,e.y=e.y||e.pageY,t.mouse.mx=e.pageX-t.mouse.x,t.mouse.my=e.pageY-t.mouse.y,(0!=t.mouse.mx||0!=t.mouse.my)&&(t.mouse.x=e.pageX,t.mouse.y=e.pageY,t.mouse.lastEvent=e,t.emit(t.MOUSEMOVE,e))};return e.type=t.MOUSEMOVE,e},_mk_mousedown:function(){var t=this,e=function(e){e.x=e.x||e.pageX,e.y=e.y||e.pageY,t.mouse.down=!0,t.mouse.lastClick=e,t.emit(t.MOUSEDOWN,e)};return e.type=t.MOUSEDOWN,e},_mk_mouseup:function(){var t=this,e=function(e){e.x=e.x||e.pageX,e.y=e.y||e.pageY,t.mouse.down=!1,t.mouse.lastClick=e,t.emit(t.MOUSEUP,e)};return e.type=t.MOUSEUP,e},_mk_cb:function(t){if(t==this.MOUSEMOVE)return this._mk_mousemove();if(t==this.MOUSEUP)return this._mk_mouseup();if(t==this.MOUSEDOWN)return this._mk_mousedown();var e=this,i=function(i){i=i||event,(t.indexOf("drop")>-1||t.indexOf("drag")>-1)&&i.preventDefault(),i.ctrlKey&&i.altKey&&console.log(i,t),e.emit(t,i)};return i.type=t,i},_mk_drop:function(t){t.preventDefault()}}),MT.namespace("plugins"),MT.require("misc.tooltips"),MT(MT.plugins.Notification=function(t){this.project=t;var e=this;this.Notification=function(){this.el=new MT.ui.DomElement,this.el.addClass("ui-notification"),this.el.el.innerHTML="Testing...."},this.Notification.prototype.hide=function(){e.hide(this)},this.Notification.prototype.show=function(t){this.el.show(t)},this.notifications=[]},{initUI:function(t){this.ui=t,this.parent=this.ui.centerBottomRightBox;var e=this.project.plugins,i=this;e.assetmanager.on(MT.ASSETS_UPDATED,function(t){i.enabled=!0,t.length<=1&&i.showIntro()})},installUI:function(){},show:function(t,e,i){var s=new this.Notification;s.el.el.onclick=function(){s.hide()},s.el.el.innerHTML='<p class="label">'+t+"</p><p>"+e+"</p>",s.show(this.parent),window.setTimeout(function(){s.el.style.opacity=1},100);var o=this.notifications.push(s);return this.align(s,o-1),isFinite(i)&&window.setTimeout(function(){s.hide()},i),s},showToolTips:function(t,e,i){this.project.plugins;if(this.enabled){var s=MT.misc.tooltips[t.tooltip];if(s){var o;o=i?s.errors[e]:s.tips[e],this.show(s.title,o,3e3)}}},showIntro:function(){},hide:function(t){var e=this;t.el.style.opacity=0,window.setTimeout(function(){e.hideNow(t)},300)},hideNow:function(t){var e=this.notifications.indexOf(t),t=this.notifications.splice(e,1)[0];t&&t.el.hide();for(var i=0;i<this.notifications.length;i++)this.align(this.notifications[i],i)},align:function(t,e){var i=e;e>3&&(i=Math.floor(3+3/e)),t.el.style.bottom=20*i+"px",t.el.style.width=320-10*i+"px",t.el.style.zIndex=999-e}}),MT.namespace("plugins"),MT.require("misc.tooltips"),MT(MT.plugins.TooltipManager=function(){},{initUI:function(t){this.ui=t,this.el=new MT.ui.DomElement("div"),this.el.setAbsolute(),this.el.style.zIndex=1001,this.el.addClass("ui-tooltip")},installUI:function(){var t,e,i,s=this,o=this.ui.events,n=null;o.on(o.MOUSEMOVE,function(o){if(o.target!==n){if(n=o.target,t=o.target.getAttribute("data-tooltip"),!t)return void s.el.hide();e=MT.misc.tooltips[t],i=o.target.getBoundingClientRect(),s.el.show(document.body),s.el.el.innerHTML='<div class="ui-tooltip-label">'+e.title+'</div><div class="ui-tooltip-description">'+e.desc,s.el.x=i.left+i.width,s.el.y=i.top+.5*(i.height-s.el.height)}})}}),MT.namespace("plugins"),MT.require("ui.TableView"),MT(MT.plugins.UserData=function(t){this.project=t,this.table=new MT.ui.TableView(null,["key","value"])},{initUI:function(t){this.ui=t,this.panel=t.createPanel("userData"),this.panel.setFree()},installUI:function(){var t=this.project.plugins,e=t.tools,i=this;this.activeObject=null;var s=function(t){t&&(t.userData||(t.userData={}),i.table.setData(t.userData),i.table.show(i.panel.content.el),i.activeObject=t)};e.on(MT.ASSET_FRAME_CHANGED,function(t){s(t),i.type="asset",console.log("asset GO")}),e.on(MT.OBJECT_SELECTED,function(t){s(t.data),i.type="object"}),t.assetmanager.on(MT.ASSETS_UPDATED,function(){"asset"==i.type&&s(t.assetmanager.getById(i.activeObject.id))});var o=function(){i.table.hide()};e.on(MT.OBJECT_UNSELECTED,o),this.ui.joinPanels(this.project.plugins.settings.panel,this.panel),this.project.plugins.settings.panel.show()}}),MT.namespace("plugins"),MT.extend("core.BasicPlugin")(MT.plugins.Physics=function(t){this.project=t,this.activeObject=null},{initUI:function(t){this.ui=t,this.panel=t.createPanel("physics"),this.panel.setFree(),this.empty=new MT.ui.Input(t,{type:"bool",key:"enable"},{enable:0});var e=this;this.empty.on("change",function(t){t?e.buildPropTree():e.addEmptyInput()});var i=function(t){e.change(t),e.buildPropTree()},s={};this.inputs={immovable:new MT.ui.Input(t,{key:"immovable",type:"bool"},s),allowGravity:new MT.ui.Input(t,{key:"allow",type:"bool"},s),gravityX:new MT.ui.Input(t,{key:"x",type:"number"},s),gravityY:new MT.ui.Input(t,{key:"y",type:"number"},s),bounceX:new MT.ui.Input(t,{key:"x",type:"number",min:0,step:.1},s),bounceY:new MT.ui.Input(t,{key:"y",type:"number",min:0,step:.1},s),allowRotation:new MT.ui.Input(t,{key:"allowRotation",type:"bool"},s),maxAngular:new MT.ui.Input(t,{key:"maxAngular",type:"number"},s),width:new MT.ui.Input(t,{key:"width",type:"number"},s),height:new MT.ui.Input(t,{key:"height",type:"number"},s),offsetX:new MT.ui.Input(t,{key:"offsetX",type:"number"},s),offsetY:new MT.ui.Input(t,{key:"offsetY",type:"number"},s),mass:new MT.ui.Input(t,{key:"mass",type:"number"},s),collideWorldBounds:new MT.ui.Input(t,{key:"collideWorldBounds",type:"number"},s),maxVelocity:new MT.ui.Input(t,{key:"maxVelocity",type:"number"},s)};for(var o in this.inputs)this.inputs[o].on("change",i);this.createFieldset("gravity"),this.createFieldset("size"),this.createFieldset("rotation")},getTemplate:function(t){return void 0==t?{enable:0}:{enable:1,immovable:1,bounce:{x:1,y:1},gravity:{allow:1,x:0,y:0},size:{width:-1,height:-1,offsetX:0,offsetY:0},rotation:{allowRotation:0,maxAngular:0},maxVelocity:0,mass:1,collideWorldBounds:0}},addEmptyInput:function(){this.clear(),this.empty.show(this.panel.content.el)},change:function(){},_gravityBreak:null,get gravityBreak(){return this._gravityBreak||(this._gravityBreak=document.createElement("br")),this._gravityBreak},buildPropTree:function(){if(this.clear(),this.activeObject.physics.enable){void 0==this.activeObject.physics.immovable&&(this.activeObject.physics=this.getTemplate(!0));var t,e=this.activeObject,i=e.physics;this.empty.setObject(i),this.empty.show(this.panel.content.el),this.inputs.immovable.setObject(i),this.inputs.immovable.show(this.panel.content.el),t=this.addFieldset("size"),this.inputs.width.setObject(i.size),this.inputs.width.show(t),this.inputs.height.setObject(i.size),this.inputs.height.show(t),this.inputs.offsetX.setObject(i.size),this.inputs.offsetX.show(t),this.inputs.offsetY.setObject(i.size),this.inputs.offsetY.show(t),i.immovable||(t=this.addFieldset("bounce"),"object"!=typeof i.bounce&&(i.bounce={x:1,y:1}),this.inputs.bounceX.setObject(i.bounce),this.inputs.bounceX.show(t),this.inputs.bounceY.setObject(i.bounce),this.inputs.bounceY.show(t),t=this.addFieldset("gravity"),void 0==i.gravity.allow&&(i.gravity.allow=1),this.inputs.allowGravity.setObject(i.gravity),this.inputs.allowGravity.show(t),i.gravity.allow?(t.appendChild(this.gravityBreak),this.inputs.gravityX.setObject(i.gravity),this.inputs.gravityX.show(t),this.inputs.gravityY.setObject(i.gravity),this.inputs.gravityY.show(t)):this.gravityBreak.parentNode&&this.gravityBreak.parentNode.removeChild(this.gravityBreak),t=this.addFieldset("rotation"),this.inputs.allowRotation.setObject(i.rotation),this.inputs.allowRotation.show(t),this.inputs.maxAngular.setObject(i.rotation),this.inputs.maxAngular.show(t),this.inputs.maxVelocity.setObject(i),this.inputs.maxVelocity.show(this.panel.content.el),this.inputs.mass.setObject(i),this.inputs.mass.show(this.panel.content.el),void 0==i.collideWorldBounds&&(i.collideWorldBounds=0),this.inputs.collideWorldBounds.setObject(i),this.inputs.collideWorldBounds.show(this.panel.content.el))}},sets:{},addFieldset:function(t){if(this.sets[t])return this.panel.content.el.appendChild(this.sets[t]),this.sets[t];var e=this.createFieldset(t);return this.panel.content.el.appendChild(e),e},createFieldset:function(t){if(!this.sets[t]){var e=document.createElement("fieldset"),i=document.createElement("legend");return e.appendChild(i),i.innerHTML=t,this.sets[t]=e,e}},clear:function(){this.empty.hide();for(var t in this.inputs)this.inputs[t].hide();for(var t in this.sets)this.sets[t].parentNode&&this.sets[t].parentNode.removeChild(this.sets[t])},installUI:function(){var t=this.project.plugins,e=t.tools,i=this,s=this.project.plugins.mapeditor,o=function(t){return s.updateScene(s.settings),t?(i.activeObject=t,void(t.physics?t.physics.enable?i.buildPropTree(t.physics):(t.physics.enable=0,i.empty.setObject(t.physics),i.addEmptyInput()):(t.physics=i.getTemplate(),i.empty.setObject(t.physics),i.addEmptyInput()))):void(i.activeObject=null)};this.ui.events.on("keyup",function(t){t.which==MT.keys.ESC&&i.clear()}),s.on("select",function(){o(s.settings)}),e.on(MT.ASSET_FRAME_CHANGED,o),e.on(MT.OBJECT_SELECTED,function(t){o(t.data)}),e.on(MT.OBJECT_UNSELECTED,function(){i.clear()}),this.ui.joinPanels(this.project.plugins.settings.panel,this.panel),this.project.plugins.settings.panel.show()}}),MT.namespace("plugins"),MT.extend("core.BasicPlugin")(MT.plugins.GamePreview=function(t){this.project=t},{initUI:function(t){},installUI:function(){return},addButtons:function(){},removeButtons:function(){}}),MT.namespace("plugins"),function(){var t="js/cm",e=function(t){var e=document.createElement("link");e.setAttribute("rel","stylesheet"),e.setAttribute("type","text/css"),e.setAttribute("href",t),document.head.appendChild(e)};return window.release?void MT.requireFile(t+"/lib/codemirror-full.js",function(){t+="/addon",MT.requireFile(t+"/scroll/scrollpastend.min.js"),MT.requireFile("js/jshint.min.js"),e("css/codemirror.css"),e(t+"/hint/show-hint.css"),e(t+"/fold/foldgutter.css"),e(t+"/dialog/dialog.css"),e("css/cm-tweaks.css")}):void MT.requireFile(t+"/lib/codemirror.js",function(){t+="/addon",MT.requireFile(t+"/comment/comment.js"),MT.requireFile(t+"/dialog/dialog.js"),MT.requireFile(t+"/edit/matchbrackets.js"),MT.requireFile(t+"/fold/brace-fold.js"),MT.requireFile(t+"/fold/foldgutter.js"),MT.requireFile(t+"/fold/foldcode.js"),MT.requireFile(t+"/fold/xml-fold.js"),MT.requireFile(t+"/hint/show-hint.js"),MT.requireFile(t+"/hint/anyword-hint.js"),MT.requireFile(t+"/hint/show-hint.js"),MT.requireFile(t+"/hint/javascript-hint.js"),MT.requireFile(t+"/scroll/scrollpastend.js"),MT.requireFile(t+"/search/search.js"),MT.requireFile(t+"/search/searchcursor.js"),MT.requireFile(t+"/search/match-highlighter.js"),MT.requireFile(t+"/selection/active-line.js"),MT.requireFile("js/jshint.js"),e("css/codemirror.css"),e(t+"/hint/show-hint.css"),e(t+"/fold/foldgutter.css"),e(t+"/dialog/dialog.css"),e("css/cm-tweaks.css")})}(),MT.extend("core.BasicPlugin")(MT.plugins.SourceEditor=function(t){MT.core.BasicPlugin.call(this,"source"),this.project=t,this.documents={}},{initUI:function(t){this.ui=t,this.panel=this.ui.createPanel("SourceEditor"),this.el=this.panel.content},installUI:function(){this.ui.joinPanels(this.project.plugins.mapeditor.panel,this.panel),this.project.plugins.mapeditor.panel.show(),this.addPanels(),this.addTreeView(),this.addEditor();var t=this,e=t.project.plugins.assetmanager.preview,i=t.project.plugins.tools,s=this.project.plugins.mapmanager.panel,o=this.project.plugins.undoredo;this.buttonPanel=new MT.ui.DomElement,this.buttonPanel.addClass("ui-panel-content"),this.buttons={newFile:new MT.ui.Button("","ui-button.tool.ui-new-file",null,function(){t.newFile()}),newFolder:new MT.ui.Button("","ui-button.tool.ui-new-folder",null,function(){t.newFolder()}),save:new MT.ui.Button("","ui-button.tool.ui-save-file",null,function(){t.save()}),deleteFile:new MT.ui.Button("","ui-button.tool.ui-delete-file",null,function(){t.deleteFile()})};for(var n in this.buttons)this.buttons[n].show(this.buttonPanel.el);this.panel.on("show",function(){t.ui.loadLayout(null,1),t.panel.show(t.panel._parent,!1),i.panel.content.hide(),s.hide(),e.hide(),o.disable(),MT.events.simulateKey(MT.keys.ESC),t.addButtons(i.panel),t.leftPanel.width=parseInt(t.leftPanel.style.width)}),this.panel.on("unselect",function(){i.panel.content.show(),s.show(),e.show(),o.enable(),window.getSelection().removeAllRanges(),t.removeButtons(),t.ui.loadLayout(null,0)}),this.project.on(MT.DROP,function(e,i){if(MT.core.Helper.isSource(i.path)){console.dir(e.target);var s=t.tv.getOwnItem(e.target);s&&s.data.contents&&(i.path=s.data.fullPath+i.path),t.uploadFile(i)}}),this.project.on("updateData",function(e){t.panel.el.style.fontSize=e.sourceEditor.fontSize+"px"})},initSocket:function(t){MT.core.BasicPlugin.initSocket.call(this,t),this.getFiles()},getFiles:function(){this.send("getFiles")},a_receiveFiles:function(t){this.tv.merge(t);this.tv.getData()},uploadFile:function(t){this.send("uploadFile",t)},save:function(t){if(t=t||this.activePanel){var e=t.data;e.src!=e.doc.getValue()&&(e.src=e.doc.getValue(),this.checkChanges(),this.send("save",{path:t.data.data.fullPath,src:this.editor.getValue()}))}},restore:function(t){if(t=t||this.activePanel){var e=t.data;e.src!=e.doc.getValue()&&e.doc.setValue(e.src)}},deleteFile:function(){var t=new MT.ui.Popup("Delete file?","Are you sure you want to delete file?"),e=this;t.addButton("no",function(){t.hide()}),t.addButton("yes",function(){e._deleteFile(),t.hide()}),t.showClose()},_deleteFile:function(){return this.activeTreeItem?(this.send("delete",this.activeTreeItem.data),void(!this.activeTreeItem.data.contents&&this.activePanel&&this.activePanel.close())):void(this.activePanel&&(this.send("delete",this.activePanel.data.data),this.activePanel.close()))},newFile:function(){this.send("newFile")},a_newFile:function(t){var e=this.tv.getById(t),i=this.loadDocument(e.data,!1);i.data.needFocus=!1,this.tv.enableRename(e)},newFolder:function(){this.send("newFolder")},a_newFolder:function(t){var e=this.tv.getById(t);this.tv.enableRename(e)},rename:function(t,e){this.send("rename",{o:t,n:e})},loadDocument:function(t,e){var i=this,s=this.documents[t.fullPath];return void 0==s&&(s=new MT.ui.Panel(t.name),s.data={data:t,needFocus:!0},s.mainTab.el.setAttribute("title",t.fullPath),this.documents[t.fullPath]=s,s.on("show",function(){var t;i.activePanel&&(t=i.tv.getById(i.activePanel.data.data.id),t&&t.removeClass("selected")),i.activePanel=s,t=i.tv.getById(s.data.data.id),t&&t.addClass("selected"),s.data.doc&&i.loadDoc(s,e)}),s.on("close",function(){i.checkChangesAndAskSave(s),i.activePanel==s&&(el=i.tv.getById(i.activePanel.data.data.id),el&&el.removeClass("selected"))}),s.isCloseable=!0),s.fitIn(),s.addClass("borderless"),this.activePanel?this.activePanel.addJoint(s):(s.show(this.rightPanel.content.el),this.activePanel=s),s.show(),this.send("getContent",t),s},a_fileContent:function(t){var e=t.name.split(".").pop(),i=this.guessMode(e),s=this;this.loadMode(i,function(){var e=s.documents[t.fullPath].data.doc;s.documents[t.fullPath].data.src=t.src,e||(e=CodeMirror.Doc(t.src,i,0),s.documents[t.fullPath].data.doc=e),s.editor.swapDoc(e),s.documents[t.fullPath].show(),s.loadDoc(s.documents[t.fullPath])})},loadDoc:function(t){this.editorElement.parentNode&&this.editorElement.parentNode.removeChild(this.editorElement),t.content.el.appendChild(this.editorElement),this.editor.swapDoc(t.data.doc);var e=this,i=this.editor.getScrollInfo();this.editor.scrollTo(i.left+1,i.top),this.editor.scrollTo(i.left,i.top),window.setTimeout(function(){t.data.needFocus!==!1&&e.editor.focus()},300),this.updateHints()},addButtons:function(t){this.buttonPanel.show(t.el)},removeButtons:function(){this.buttonPanel.hide()},addPanels:function(){this.leftPanel=this.ui.createPanel("file-list-holder"),this.rightPanel=this.ui.createPanel("source-editor"),this.leftPanel.addClass("borderless"),this.leftPanel.hide().show(this.el.el),this.leftPanel.fitIn(),this.leftPanel.width=200,this.leftPanel.style.setProperty("border-right","solid 1px #000"),this.leftPanel.isResizeable=!0,this.leftPanel.removeHeader();var t=this;this.leftPanel.on("resize",function(e){t.rightPanel.style.left=e+"px"}),this.rightPanel.addClass("borderless"),this.rightPanel.hide().show(this.el.el),this.rightPanel.fitIn(),this.rightPanel.style.left="200px",this.rightPanel.style.width="auto",this.rightPanel.removeHeader(),this.rightPanel.content.style.overflow="hidden"},activeTreeItem:null,addTreeView:function(){this.tv=new MT.ui.TreeView([],{root:this.project.path}),this.tv.tree.show(this.leftPanel.content.el);var t=this,e=function(e,i){t.activeTreeItem&&t.activeTreeItem.removeClass("selected"),t.activeTreeItem=i,i.addClass("selected"),e.contents||t.loadDocument(e)};this.tv.on("click",e),this.tv.on("renameStart",function(){t.activePanel&&(t.activePanel.data.needFocus=!1)}),this.tv.on("change",function(i,s){if(!i||!s)return void t.saveData();var o=t.documents[i]||t.documents[s];if(!o)return void t.rename(i,s);o.data.needFocus=!0;var n=s.split("/").pop();t.documents[s]=o,delete t.documents[i],o.mainTab.el.setAttribute("title",s),o.mainTab.title.innerHTML=n;var a=t.guessMode(n.split(".").pop());t.loadMode(a,function(){var i=t.tv.getById(o.data.data.id);o.data.needFocus=!0,e(o.data.data,i),o.data.doc&&o.data.doc.getEditor().setOption("mode",a)}),t.rename(i,s)});var i=function(e){t.send("updateFolder",{id:e.data.id,isClosed:e.data.isClosed})};this.tv.on("open",function(t){i(t)}),this.tv.on("close",function(t){i(t)}),this.tv.sortable(this.ui.events)},saveData:function(){this.send("update",this.tv.getData())},moveLine:function(t,e){var i=t.state.activeLines[0];if(void 0!=i){var s=t.getCursor(),o=t.getLine(s.line),n=t.getLine(s.line+e);t.replaceRange(n,{ch:0,line:s.line},{ch:o.length,line:s.line}),s.line=s.line+e,t.replaceRange(o,{ch:0,line:s.line},{ch:n.length,line:s.line}),t.setSelection(s),t.indentLine(s.line)}},copyLine:function(t,e){var i=t.state.activeLines[0];if(void 0!=i){var s=t.getCursor(),o=s.ch;s.ch=i.text.length,t.setCursor(s),t.replaceSelection("\r\n"+i.text),s.line=s.line+e,s.ch=o,t.setSelection(s)}},addEditor:function(){var t=this,e={indentUnit:4,extraKeys:{"Ctrl-S":function(){t.save()},"Ctrl-/":"toggleComment","Ctrl-Space":"autocomplete","Alt-Up":function(e){t.moveLine(e,-1)},"Alt-Down":function(e){t.moveLine(e,1)},"Ctrl-Alt-Up":function(e){t.copyLine(e,0)},"Ctrl-Alt-Down":function(e){t.copyLine(e,1)},"Ctrl-+":function(){alert()}},gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter","CodeMirror-jslint"],highlightSelectionMatches:{showToken:/\w/},onCursorActivity:function(){editor.matchHighlight("CodeMirror-matchhighlight")},tabMode:"shift",indentWithTabs:!0,lineNumbers:!0,foldGutter:!0,styleActiveLine:!0,matchBrackets:!0,autofocus:!0,dragDrop:!0,showTabs:!0,undoDepth:500,scrollPastEnd:!0,historyEventDelay:200,tabSize:4,cursorBlinkRate:530};this.editorElement=null;var t=this;this.editor=CodeMirror(function(e){t.editorElement=e},e),this.editor.on("change",function(){t.checkChanges()}),this.editor.on("keyup",function(t,e){if(e.altKey&&(e.which==MT.keys.UP||e.which==MT.keys.DOWN)){{t.state.activeLines[0],t.getCursor()}return e.ctrlKey,e.preventDefault(),!1}})},updateHints:function(){var t=this;this.editor.operation(function(){if(t.editor.clearGutter("CodeMirror-jslint"),"javascript"==t.editor.options.mode.name){var e={browser:!0,globalstrict:!0,loopfunc:!0,predef:{Phaser:Phaser,mt:!1,console:!1},laxcomma:!1};JSHINT(t.editor.getValue(),e);for(var i=0;i<JSHINT.errors.length;++i){var s=JSHINT.errors[i];if(s){var o=document.createElement("a");o.errorTxt=s.reason;var n=o.appendChild(document.createElement("span"));n.innerHTML="!",n.className="lint-error-icon";var a=o.appendChild(document.createElement("span"));a.className="lint-error-text",a.appendChild(document.createTextNode(s.reason)),o.className="lint-error",t.editor.setGutterMarker(s.line-1,"CodeMirror-jslint",o)}}}})},checkChanges:function(){if(this.activePanel){this.updateHints();var t=this.activePanel.data;this.activePanel.mainTab.title.innerHTML=t.src!=t.doc.getValue()?t.data.name+"*":t.data.name}},checkChangesAndAskSave:function(t){var e=t.data;if(e.src!==e.doc.getValue()){var i=this,s=new MT.ui.Popup("File changed","File has been changed, do you want to save changes?");s.addButton("no",function(){i.restore(t),s.hide()}),s.addButton("yes",function(){i.save(t),s.hide()}),s.showClose()}},guessMode:function(t){var e={};return"js"==t&&(e.name="javascript",e.hint="javascript"),"html"==t&&(e.name="htmlmixed",e.hint="html",e.scriptTypes=[{matches:/\/x-handlebars-template|\/x-mustache/i,mode:null},{matches:/(text|application)\/(x-)?vb(a|script)/i,mode:"vbscript"}]),"css"==t&&(e.name="css",e.hint="css"),"json"==t&&(e.name="javascript"),e},_loadedModes:{},loadMode:function(t,e){if(!t||!t.name)return void e();if(this._loadedModes[t.name])e();else{var i=function(){"htmlmixed"==t.name?MT.requireFile("js/cm/mode/xml/xml.js",function(){MT.requireFile("js/cm/mode/"+t.name+"/"+t.name+".js",e)}):MT.requireFile("js/cm/mode/"+t.name+"/"+t.name+".js",e)};t.hint?MT.requireFile("js/cm/addon/hint/"+t.hint+"-hint.js",i):i()}}}),MT.namespace("plugins"),MT.extend("core.BasicPlugin")(MT.plugins.MapManager=function(t){MT.core.BasicPlugin.call(this,"MapManager"),this.project=t},{installUI:function(t){var e=this;this.panel=this.ui.createPanel("Map Manager"),this.panel.isDockable=!0,this.panel.isJoinable=!1,this.panel.isResizeable=!1,this.panel.removeHeader(),this.panel.height=25,t.dockToBottom(this.panel),this.locateObject=this.panel.addButton("","map-locate",function(){e.locate()}),this.map=this.project.plugins.mapeditor,this.locateObject.width="auto",this.zoom=new MT.ui.Dropdown({list:[200,150,100,90,80,70,60,50],button:{"class":"text-size",width:"auto"},listStyle:{width:70},value:100},t),this.zoom.button.el.setAttribute("data-text","%"),this.zoom.on("change",function(t){e.setZoom(t)}),this.zoom.on("show",function(){e.zoom.button.el.setAttribute("data-text","")}),this.zoom.on("hide",function(){e.zoom.button.el.setAttribute("data-text","%")}),this.panel.addButton(this.zoom.button),this.panel.addClass("map-manager-panel"),this.panel.alignButtons(),this.panel.style.marginLeft=0,this.ui.events.on("wheel",function(t){t.target==e.map.game.canvas&&(t.wheelDelta>0?e.incZoom(t.offsetX,t.offsetY):e.decZoom(t.offsetX,t.offsetY))})},setZoom:function(t){this._setZoom(.01*t)},_setZoom:function(t,e,i){var s=this.map.game.camera;this.map.resize();var o=s.x/s.scale.x+s.view.halfWidth,n=s.y/s.scale.y+s.view.halfHeight;if(void 0!==e)var a=e/s.scale.x+s.x/s.scale.x,h=i/s.scale.y+s.y/s.scale.y,l=e/t+s.x/t,r=i/t+s.y/t,c=(l-a)*t,d=(r-h)*t;s.scale.setTo(t,t),this.map.resize(),void 0!==e?(s.x-=c,s.y-=d):this.locateXY(o,n),this.zoom.list.isVisible||(this.zoom.button.text=(100*t).toFixed(0)),this.map.settings.cameraX=s.x,this.map.settings.cameraY=s.y,this.project.plugins.settings.updateScene(this.map.settings);var u=this;window.setTimeout(function(){u.map.update()},10)},locate:function(){this.map.game.camera;if(!this.map.activeObject||this.map.activeObject.object)return this.map.game.camera.x=0,void(this.map.game.camera.y=0);var t=this.map.activeObject.object;this.locateXY(t.x+t.width*(.5-t.anchor.x),t.y+t.height*(.5-t.anchor.y))},locateXY:function(t,e){var i=this.map.game.camera;i.x=(t-i.view.halfWidth)*i.scale.x,i.y=(e-i.view.halfHeight)*i.scale.y},incZoom:function(t,e){var i=this.map.scale.x;i>3||this._setZoom(i+.1,t,e)},decZoom:function(t,e){var i=this.map.scale.x;.3>i||this._setZoom(i-.1,t,e)}}),MT.namespace("plugins"),MT.extend("core.BasicPlugin")(MT.plugins.FontManager=function(t){MT.core.BasicPlugin.call(this,"Analytics"),this.project=t},{loadFont:function(t,e){var i=t.replace(/ /gi,"+"),s=document.createElement("link");s.setAttribute("rel","stylesheet"),s.setAttribute("type","text/css"),s.onload=function(){var i=document.createElement("span");i.style.fontFamily=t,i.innerHTML="ignore",i.style.visibility="hidden",document.body.appendChild(i),window.setTimeout(function(){document.body.removeChild(i)},5e3),e(t)},s.href="//fonts.googleapis.com/css?family="+i,document.head.appendChild(s)}}),MT.namespace("plugins"),MT.extend("core.BasicPlugin")(MT.plugins.HelpAndSupport=function(t){MT.core.BasicPlugin.call(this,"HelpAndSupport"),this.project=t},{initUI:function(t){var e=this;this.list=new MT.ui.List([{label:"About",className:"",cb:function(){e.openHomePage()}},{label:"Video",className:"",cb:function(){e.openVideo()}},{label:"on HTML5 Game Devs Forum",className:"",cb:function(){e.openForum()}},{label:"google fonts",className:"",cb:function(){e.openFonts()}},{label:"Found a bug? Report on github",className:"",cb:function(){e.openLink("https://github.com/TheMightyFingers/mightyeditor/issues/new")}}],t,!0);var i=this.project.panel.addButton("Help and Support",null,function(t){t.stopPropagation(),e.list.show(document.body),e.list.y=i.el.offsetHeight,e.list.x=i.el.offsetLeft-5,e.list.el.style.bottom="initial"});e.list.width=300},openForum:function(){var t=window.open("about:blank","_newTab");t.opener=null,t.location.href="http://www.html5gamedevs.com/topic/6303-game-editor-on-phaser/"},openHomePage:function(){var t=window.open("about:blank","_newTab");t.opener=null,t.location.href="http://mightyfingers.com/editor-features/"},openVideo:function(){var t=window.open("about:blank","_newTab");t.opener=null,t.location.href="https://www.youtube.com/watch?v=7dk2naCCePc"},openFonts:function(){var t=window.open("about:blank","_newTab");t.opener=null,t.location.href="https://www.google.com/fonts"},openLink:function(t){var e=window.open("about:blank","_newTab");e.opener=null,e.location.href=t}}),MT.namespace("ui"),MT.extend("ui.DomElement")(MT.ui.Fieldset=function(t){MT.ui.DomElement.call(this,"fieldset"),this.title=t},{get title(){return this.title.innerHTML},legend:null,set title(t){this.legend||(this.legend=document.createElement("legend"),this.el.appendChild(this.legend)),(void 0!==t||""!=t)&&(this.legend.innerHTML=t)}}),MT.namespace("ui"),MT.extend("core.Emitter").extend("ui.DomElement")(MT.ui.Popup=function(t,e){MT.ui.DomElement.call(this),this.addClass("ui-popup"),this.head=document.createElement("div"),this.head.className="ui-popup-head",this.content=document.createElement("div"),this.content.className="ui-popup-content",this.el.appendChild(this.head),this.el.appendChild(this.content),this.head.innerHTML=t,this.content.innerHTML=e,this.bg=document.createElement("div"),this.bg.className="ui-wrapper",this.bg.style.zIndex=9999,this.bg.onmousedown=this.bg.onmouseup=this.bg.onmousemove=function(t){return t.preventDefault(),t.stopPropagation(),!1},this.style.zIndex=1e4,this.y=.3*window.innerHeight,this.style.bottom="auto",this.addClass("ui-popup-with-head"),this.show()},{showClose:function(){if(!this.close){this.close=document.createElement("div"),this.close.className="ui-popup-close",this.head.appendChild(this.close);var t=this;this.close.onclick=function(){t.hide(!0)}}},addButton:function(t,e){this.buttonBar||(this.buttonBar=document.createElement("div"),this.el.appendChild(this.buttonBar),this.buttonBar.className="ui-button-bar"),this.buttons=this.buttons||{};var i=this.buttons[t]=document.createElement("div");i.className="ui-popup-button",i.innerHTML=t,i.onclick=e,this.buttonBar.appendChild(i),this.addClass("ui-has-buttons")},removeHeader:function(){this.head.parentNode&&(this.head.parentNode.removeChild(this.head),this.removeClass("ui-popup-with-head"))},hide:function(t){this.bg.parentNode&&this.bg.parentNode.removeChild(this.bg),this.el.parentNode&&this.el.parentNode.removeChild(this.el),this.emit("close",t)},show:function(){this.emit("show"),document.body.appendChild(this.bg),document.body.appendChild(this.el)}}),MT.namespace("core"),MT.keys=MT.core.keys={ESC:27,ENTER:13,UP:38,LEFT:37,RIGHT:39,DOWN:40,DELETE:46,A:65,B:66,C:67,D:68,V:86,TAB:9,SPACE:32},MT.const={IMAGES:"image/*",DATA:"application/json|application/xml"},MT.namespace("plugins"),MT.plugins.list=1,MT.require("plugins.AssetManager"),MT.require("plugins.ObjectManager"),MT.require("plugins.MapEditor"),MT.require("plugins.Settings"),MT.require("plugins.Export"),MT.require("plugins.Tools"),MT.require("plugins.UndoRedo"),MT.require("plugins.DataLink"),MT.require("plugins.Analytics"),MT.namespace(""),MT.extend("core.Emitter")(MT.Socket=function(t,e){this.url=t?t:"ws://"+window.location.host,e!==!1&&this.connect(),this.callbacks={},this._toSend=[],this.sendObject={channel:"",action:"",data:null}
},{delay:0,connect:function(t){t&&(this.url=t);var e=this;return this.ws=new WebSocket(this.url),this.ws.onopen=function(){e.emit("core","open")},this.ws.onmessage=function(t){var i=JSON.parse(t.data);e.emit(i.channel,i.action,i.data)},this.ws.onerror=function(t){console.error(t)},this.ws.onclose=function(){console.log("WS close"),e.emit("core","close"),window.setTimeout(function(){e.connect()},1e3)},this.connection},send:function(t,e,i){if(this.ws.readyState==this.ws.OPEN)return this.sendObject.channel=t,this.sendObject.action=e,this.sendObject.data=i,void this.ws.send(JSON.stringify(this.sendObject));if(this._toSend.push([t,e,i]),0===this.delay){var s=this;this.delay=window.setTimeout(function(){s.sendDelayed()},100)}},sendDelayed:function(){if(this.ws.readyState!==this.ws.OPEN){var t=this;return void(this.delay=window.setTimeout(function(){t.sendDelayed()},100))}for(var e=0;e<this._toSend.length;e++)this.send.apply(this,this._toSend[e])},emit:function(t,e,i){if(!this.callbacks[t])return void console.warn("received unhandled data",t,i);for(var s=this.callbacks[t],o=0;o<s.length;o++)s[o](e,i)}}),MT.Socket.TYPE={open:"open",close:"close",message:"message",error:"error"},MT.namespace("ui"),MT.require("ui.Events"),MT.require("ui.Panel"),MT.LEFT=1,MT.RIGHT=2,MT.TOP=3,MT.BOTTOM=4,MT.CENTER=5,MT.NONE=0,MT.ui.addClass=function(t,e){if("object"!=typeof e){for(var i=t.className.split(" "),s=0;s<i.length;s++)if(i[s]==e)return;i.push(e),t.className=i.join(" ")}else for(var s=0;s<e.length;s++)this.addClass(t,e[s])},MT.ui.removeClass=function(t,e){if("object"!=typeof e){for(var i=t.className.split(" "),s=0;s<i.length;s++)i[s]==e&&i.splice(s,1);t.className=i.join(" ")}else for(var s=0;s<e.length;s++)this.removeClass(t,e[s])},MT.extend("core.Emitter")(MT.ui.Controller=function(){this.events=new MT.ui.Events,this.panels=[],this._centerPanels=[],this.additionalBorder=4,this.helper=new MT.ui.DomElement,this.helper.addClass("ui-main-helper"),this.helper.setAbsolute(),this.helper.style.zIndex=99999,this.box={x:0,y:0,width:window.innerWidth,height:window.innerHeight},this.centerBottomRightBox=document.createElement("div"),document.body.appendChild(this.centerBottomRightBox),this.centerBottomRightBox.style.position="absolute",this.snapPx=20;var t=this,e=!1,i=null,s=!1,o=null;this.oldScreenSize.width=window.innerWidth,this.oldScreenSize.height=window.innerHeight;var n="transitionend";window.navigator.userAgent.indexOf("Chrome")>1&&(n="webkitTransitionEnd");var a=function(e){t.update();var i=e.propertyName;("width"==i||"height"==i)&&t.refresh(),this.removeEventListener(n,a),window.setTimeout(function(){document.addEventListener(n,a,!1)},1)};document.addEventListener(n,a,!1),this.events.on(this.events.RESIZE,function(e){t.reloadSize(e)}),this.events.on(this.events.MOUSEMOVE,function(n){if(!e){var a=n.target.panel||t.pickPanel(n);return a?(o=a,s=t.checkResize(a,n),n.target.panel||s||n.altKey?void(i=a):void(i=null)):(t.resetResizeCursor(),void(i=null))}if(i)return n.preventDefault(),n.stopPropagation(),s?void t.resizePanel(i,n):void(t.tryUnjoin(i,n)&&t.movePanel(i,n))}),this.events.on(this.events.MOUSEDOWN,function(s){return 0!=s.button?void(1==s.button&&s.target.data&&s.target.data.panel&&s.target.data.panel.isCloseable&&s.target.data.panel.close()):(e=!0,i?(s.target.data&&s.target.data.panel?(i=s.target.data.panel,i.isNeedUnjoin=!0,i.show(null)):i.isNeedUnjoin=!1,i.removeClass("animated"),t.updateZ(i),window.x=i,void window.setTimeout(function(){i.focus()},0)):void(o&&!o.isDocked&&(t.updateZ(o),window.setTimeout(function(){o.focus()},0))))}),this.events.on(this.events.MOUSEUP,function(){e=!1,i&&(i.addClass("animated"),i.isNeedUnjoin=!0,i.mdown=!1,i.toJoinWith&&(t.joinPanels(i.toJoinWith,i),i.setAll("toJoinWith",null),i.isDockNeeded=!1),t.hideDockHelper(i),i.ox=0,i.oy=0,t.sortPanels(),t.update(),t.saveLayout())});var h=window.setInterval(function(){t.emit(t.events.RESIZE)},200);window.setTimeout(function(){window.clearInterval(h)},2e3),this.colorPicker=new MT.ui.ColorPicker(this),this.colorPicker.hide()},{saveSlot:0,toResize:{TOP:!1,RIGHT:!1,BOTTOM:!1,LEFT:!1},zIndex:1,refresh:function(){this.emit(this.events.RESIZE)},setCenter:function(t){this._centerPanels.length>0&&this._centerPanels.join(t),this._centerPanels.push(t),t.isDocked=!0,t.isPickable=!1,t.dockPosition=MT.CENTER,this.sortPanels(),this.updateCenter()},p:{},createPanel:function(t,e,i){t||console.error("bad name");var s=new MT.ui.Panel(t,this);Object.defineProperty(this.p,t,{get:function(){return s},enumerable:!0}),this.panels.push(s),s.width=e||250,s.height=i||400,s.x=this.box.x,s.y=this.box.y,s.show(),s.name=t,s.style.zIndex=1;var o=this;return s.on("hide",function(){o.beforeHide(s)}),s.on("show",function(){o.beforeShow(s)}),s.addClass("animated"),s},beforeHide:function(t){return t.cache={dockPosition:t.dockPosition,isDocked:t.isDocked,width:t.width,height:t.height},t.isDocked?(this.undock(t),void this.update()):void t.saveBox()},beforeShow:function(t){t.cache&&t.cache.isDocked&&(t.width=t.cache.width,t.height=t.cache.height,this.helper.dockPosition=t.cache.dockPosition,this.helper.isDocked=!0,this.helper.dockPosition==MT.TOP&&this.showDockHelperTop(t),this.helper.dockPosition==MT.LEFT&&this.showDockHelperLeft(t),this.helper.dockPosition==MT.RIGHT&&this.showDockHelperRight(t),this.helper.dockPosition==MT.BOTTOM&&this.showDockHelperBottom(t),this.dockToHelper(t),this.helper.hide())},sortPanels:function(){this.panels.sort(function(t,e){return t.style.zIndex-e.style.zIndex})},updateZ:function(t){this.sortPanels();for(var e=null,i=this.panels.length-1;i>0;i--)e=this.panels[i],e.isDocked?e.style.zIndex!=i&&(e.style.zIndex=i):e.style.zIndex!=i+10&&e.style.zIndex<1e3&&(e.style.zIndex=i+10);this.zIndex=this.panels.length,t&&(t.isDocked?t.style.zIndex=this.zIndex+1:t.style.zIndex<1e3&&(t.style.zIndex=this.zIndex+10))},removePanel:function(t){this.disableMoveable(t);for(var e=0;e<this.panels.length;e++)if(this.panels[e]==t)return this.panels.splice(e,1);return null},checkResize:function(t,e){if(!t.isResizeable)return this.setResizeCursor(!0),!1;var i=0,s=0,o=t.getStyle(),n=e.x-t.x,a=e.y-t.y,h=!1;return n/t.width<.5?(s=parseInt(o.borderLeftWidth),s&&n<s+this.additionalBorder&&(this.toResize.LEFT=!0,h=!0)):(s=parseInt(o.borderRightWidth),s&&t.width-n<s+this.additionalBorder&&(this.toResize.RIGHT=!0,h=!0)),a/t.height<.5?(i=parseInt(o.borderTopWidth),i&&a<i+this.additionalBorder&&(this.toResize.TOP=!0,h=!0)):(i=parseInt(o.borderBottomWidth),i&&t.height-a<i+this.additionalBorder&&(this.toResize.BOTTOM=!0,h=!0)),this.setResizeCursor(!h),h},setResizeCursor:function(t){if(t)return void this.resetResizeCursor();var e="";this.toResize.TOP&&(e+="n"),this.toResize.BOTTOM&&(e+="s"),this.toResize.RIGHT&&(e+="e"),this.toResize.LEFT&&(e+="w"),document.body.style.setProperty("cursor",e+"-resize","important")},resetResizeCursor:function(){this.toResize.TOP=!1,this.toResize.RIGHT=!1,this.toResize.BOTTOM=!1,this.toResize.LEFT=!1,document.body.style.removeProperty("cursor","auto","important")},resizePanel:function(t){var e=this.events.mouse.mx,i=this.events.mouse.my;this.toResize.RIGHT&&(t.width+=e,t.dockPosition==MT.LEFT&&this.resizeSidePanelsFromLeft(t,e)),this.toResize.BOTTOM&&(t.height+=i,t.dockPosition==MT.TOP&&this.resizeSidePanelsFromTop(t,i)),this.toResize.LEFT&&(t.x+=e,t.width=t.width-e,t.dockPosition==MT.RIGHT&&this.resizeSidePanelsFromRight(t,e)),this.toResize.TOP&&(t.y+=i,t.height-=i,t.dockPosition==MT.BOTTOM&&this.resizeSidePanelsFromBottom(t,i)),t.isDocked&&this.moveDocks()},resizeSidePanelsFromLeft:function(t,e){for(var i=null,s=0;s<this.panels.length;s++)i=this.panels[s],i.setTopBottom("justUpdated",!1);for(var s=0;s<this.panels.length;s++)if(i=this.panels[s],!i.justUpdated&&(i.dockPosition==MT.TOP||i.dockPosition==MT.BOTTOM)){if(t.x>=i.x)continue;i.x=i.x+e,i.width=i.width-e,i.setTopBottom("justUpdated",!0)}},resizeSidePanelsFromRight:function(t,e){for(var i=null,s=0;s<this.panels.length;s++)i=this.panels[s],i.setTopBottom("justUpdated",!1);for(var s=0;s<this.panels.length;s++)if(i=this.panels[s],!i.justUpdated&&(i.dockPosition==MT.TOP||i.dockPosition==MT.BOTTOM)){if(t.x+t.width<=i.x+i.width)continue;i.width=i.width+e,i.setTopBottom("justUpdated",!0)}},resizeSidePanelsFromTop:function(t,e){for(var i=null,s=0;s<this.panels.length;s++)i=this.panels[s],i.setAll("justUpdated",!1);for(var s=0;s<this.panels.length;s++)i=this.panels[s],i.justUpdated||(i.dockPosition==MT.LEFT||i.dockPosition==MT.RIGHT)&&(i.top||t.y>=i.y||(i.y=i.y+e,i.height=i.height-e,i.setAll("justUpdated",!0)))},resizeSidePanelsFromBottom:function(t,e){for(var i=null,s=0;s<this.panels.length;s++)i=this.panels[s],i.setAll("justUpdated",!1);for(var s=0;s<this.panels.length;s++)i=this.panels[s],i.justUpdated||(i.dockPosition==MT.LEFT||i.dockPosition==MT.RIGHT)&&(i.bottom||i.y+i.height>=t.y+t.height||i.bottom||(i.setClearHeight(i.height+e),i.setAll("justUpdated",!0)))},dockToLeft:function(t){return t.isDockable?(t.isDocked?this.undock(t):t.saveBox(),t.x=this.box.x,t.y=this.box.y,t.setAll("height",this.box.height),t.dockPosition=MT.LEFT,t.isDocked=!0,void this.moveDocksLeft()):void console.error("trying to dock undockable panel")},dockToRight:function(t){return t.isDockable?(t.isDocked?this.undock(t):t.saveBox(),t.x=this.box.width-t.width,t.y=this.box.y,t.setAll("height",this.box.height),t.dockPosition=MT.RIGHT,t.isDocked=!0,void this.moveDocksRight()):void console.error("trying to dock undockable panel")},dockToTop:function(t){return t.isDockable?(t.isDocked?this.undock(t):t.saveBox(),t.y=this.box.y,t.x=this.box.x,t.width=this.box.width,this.box.y+=t.height,this.box.height-=t.height,t.dockPosition=MT.TOP,t.isDocked=!0,void this.moveDocksTop()):void console.error("trying to dock undockable panel")},dockToBottom:function(t){return t.isDockable?(t.isDocked?this.undock(t):t.saveBox(),t.x=this.box.x,t.y=this.box.height-t.height,t.width=this.box.width,this.box.height-=t.height,t.dockPosition=MT.BOTTOM,t.isDocked=!0,void this.moveDocksBottom()):void console.error("trying to dock undockable panel")},update:function(){this.updateZ()},moveDocks:function(){this.moveDocksLeft(),this.moveDocksRight(),this.moveDocksTop(),this.moveDocksBottom(),this.updateCenter()},moveDocksLeft:function(){var t=this.panels.slice(0);t.sort(function(t,e){return t.x-e.x});var e=null;this.box.x=0;for(var i=0;i<t.length;i++)e=t[i],e.setTopBottom("justUpdated",!1);for(var i=0;i<t.length;i++)e=t[i],e.dockPosition==MT.LEFT&&e.isVisible&&(e.justUpdated||(e.x=this.box.x,this.box.x+=e.width,this.box.width-=e.width,e.setTopBottom("justUpdated",!0)))},moveDocksRight:function(){var t=this.panels.slice(0);t.sort(function(t,e){return-(t.x+t.width)+(e.x+e.width)});for(var e=0;e<t.length;e++)i=t[e],i.setTopBottom("justUpdated",!1);var i=null;this.box.width=window.innerWidth;for(var e=0;e<t.length;e++)i=t[e],i.isDocked&&i.dockPosition==MT.RIGHT&&i.isVisible&&(i.justUpdated||(i.x=this.box.width-i.width,this.box.width-=i.width,i.setTopBottom("justUpdated",!0)))},moveDocksTop:function(){var t=this.panels.slice(0);t.sort(function(t,e){return t.y-e.y});var e=null;this.box.y=0;for(var i=0;i<t.length;i++)e=t[i],e.setLeftRight("justUpdated",!1);for(var i=0;i<t.length;i++)e=t[i],e.isDocked&&e.dockPosition==MT.TOP&&e.isVisible&&(e.justUpdated||(e.y=this.box.y,this.box.y+=e.height,e.setLeftRight("justUpdated",!0)))},moveDocksBottom:function(){var t=this.panels.slice(0);t.sort(function(t,e){return e.y+e.height-(t.y+t.height)});for(var e=0;e<t.length;e++)i=t[e],i.setTopBottom("justUpdated",!1);var i=null;this.box.height=window.innerHeight;for(var e=0;e<t.length;e++)i=t[e],i.dockPosition==MT.BOTTOM&&i.isDocked&&i.isVisible&&(i.justUpdated||(i.y=this.box.height-i.height,this.box.height-=i.height,i.setLeftRight("justUpdated",!0)))},updateCenter:function(t){if(0!=this._centerPanels.length){var e=this._centerPanels[0];(e.x!=this.box.x||e.y!=this.box.y||e.width!=this.box.width-this.box.x||e.height!=this.box.height-this.box.y)&&(e.x=this.box.x,e.y=this.box.y,e.width=this.box.width-this.box.x,e.height=this.box.height-this.box.y,t||this.emit(this.events.RESIZE)),this.centerBottomRightBox.style.left=e.x+e.width,this.centerBottomRightBox.style.top=e.y+e.height,this.centerBottomRightBox.style.zIndex=1001,this.centerBottomRightBox.style.backgroundColor="inherit"}},tryUnjoin:function(t){if(1===t.joints.length)return!0;if(!t.isJoinable)return!0;if(!t.isNeedUnjoin)return!0;var e=this.events.mouse.mx,i=this.events.mouse.my;return t.ox+=e,t.oy+=i,Math.abs(t.ox)<this.snapPx&&Math.abs(t.oy)<this.snapPx?!1:(t.unjoin(),t.isNeedUnjoin=!1,t.isDocked||(t.x+=t.ox,t.y+=t.oy,t.ox=0,t.oy=0),t.isDocked=!1,t.dockPosition=MT.NONE,t.loadBox(),!0)},movePanel:function(t,e){if(t.isMovable){var i=!0,s=this.vsPanels(e,t);if(s&&s.acceptsPanels){var o=(e.x-s.x)/s.width,n=(e.y-s.y)/s.height;this.showHelperOverPanel(s,o,n),i=!1}var a=this.events.mouse.mx,h=this.events.mouse.my;if(t.isDocked){if(t.ox+=a,t.oy+=h,Math.abs(t.ox)<this.snapPx&&Math.abs(t.oy)<this.snapPx)return;this.undock(t),t.x+=t.ox,t.y+=t.oy,t.ox=0,t.oy=0}t.x+=a,t.y+=h,i&&(Math.abs(e.x-this.box.x)<this.snapPx&&!s?(this.showDockHelperLeft(t),i=!1):Math.abs(e.x-this.box.width)<this.snapPx&&!s?(this.showDockHelperRight(t),i=!1):Math.abs(e.y-this.box.y)<this.snapPx&&!s?(this.showDockHelperTop(t),i=!1):Math.abs(e.y-this.box.height)<this.snapPx&&!s?(this.showDockHelperBottom(t),i=!1):t.isDockNeeded=!1),i&&this.helper.hide()}},showDockHelperLeft:function(t){this.helper.show(),this.helper.width=t.width,this.helper.height=this.box.height-this.box.y,this.helper.x=this.box.x,this.helper.y=this.box.y,this.helper.dockPosition=MT.LEFT,t.isDockNeeded=!0,this.helper.toJoinWith=null},showDockHelperRight:function(t){this.helper.show(),this.helper.width=t.width,this.helper.height=this.box.height-this.box.y,this.helper.x=this.box.width-t.width,this.helper.y=this.box.y,this.helper.dockPosition=MT.RIGHT,t.isDockNeeded=!0,this.helper.toJoinWith=null},showDockHelperTop:function(t){this.helper.show(),this.helper.width=this.box.width-this.box.x,this.helper.height=t.height,this.helper.x=this.box.x,this.helper.y=this.box.y,this.helper.dockPosition=MT.TOP,t.isDockNeeded=!0,this.helper.toJoinWith=null},showDockHelperBottom:function(t){this.helper.show(),this.helper.width=this.box.width-this.box.x,this.helper.height=t.height,this.helper.x=this.box.x,this.helper.y=this.box.height-t.height,this.helper.dockPosition=MT.BOTTOM,t.isDockNeeded=!0,this.helper.toJoinWith=null},showHelperOverPanel:function(t,e,i){t.acceptsPanels&&(this.helper.width=t.width,this.helper.x=t.x,this.helper.toJoinWith=t,t.isDocked?.3>i?(this.helper.y=t.y,this.helper.height=.5*t.height,this.helper.joinPosition=MT.TOP):i>.7?(this.helper.height=.5*t.height,this.helper.y=t.y+t.height-this.helper.height,this.helper.joinPosition=MT.BOTTOM):(this.helper.y=t.y,this.helper.height=t.height,this.helper.joinPosition=MT.CENTER):(this.helper.y=t.y,this.helper.height=t.height,this.helper.joinPosition=MT.CENTER),this.helper.show())},hideDockHelper:function(t){if(this.helper.isVisible){if(this.helper.toJoinWith){t.saveBox(),t.height=this.helper.height;var e=this.helper.toJoinWith;return this.helper.joinPosition==MT.CENTER&&this.joinPanels(e,t),this.helper.joinPosition==MT.BOTTOM&&(e.joinBottom(t),e.isDocked&&(t.dockPosition=e.dockPosition,t.isDocked=!0)),this.helper.joinPosition==MT.TOP&&(e.joinTop(t),e.isDocked&&(t.dockPosition=e.dockPosition,t.isDocked=!0)),this.helper.toJoinWith=null,void this.helper.hide()}t&&t.isDockNeeded&&!t.isDocked&&this.dockToHelper(t),this.helper.hide()}},joinPanels:function(t,e){e.inheritSize(t),t.addJoint(e),t.removeClass("active"),e.removeClass("active"),t.hide(!1),t.isDocked&&this.dockToHelper(e,t),e.header.setActiveIndex(0),e.header.showTabs(),e.isDockNeeded=!1,e.isVisible=!1,e.show()},vsPanels:function(t,e){for(var i=null,s=this.panels.length-1;s>-1;s--)if(i=this.panels[s],i!=e&&i.isVisible&&i.isPickable&&i.vsPoint(t))return i;return null},pickPanel:function(t){for(var e=null,i=this.panels.length-1;i>-1;i--)if(e=this.panels[i],e.isVisible&&e.isPickable&&e.vsPoint(t))return e;return null},dockToHelper:function(t,e){t.isDocked||(e=e||this.helper,e.isDocked||t.saveBox(),t.inheritSize(e),t.setAll("isDocked",!0),t.setAll("isDockNeeded",!1),t.style.zIndex=0,t.dockPosition=e.dockPosition,this.moveDocks())},undock:function(t){if(t.isDocked){var e=null;t.isDocked=!1;var i=!0;(t.top||t.bottom)&&(i=!1);var s=t.getTopMost();if(s==t&&(s=t.bottom),t.breakSideJoints(),i){if(t.dockPosition==MT.LEFT)for(var o=0;o<this.panels.length;o++)e=this.panels[o],(e.dockPosition==MT.BOTTOM||e.dockPosition==MT.TOP)&&t.x+t.width==e.x&&(e.x-=t.width,e.width+=t.width);if(t.dockPosition==MT.RIGHT)for(var o=0;o<this.panels.length;o++)e=this.panels[o],(e.dockPosition==MT.BOTTOM||e.dockPosition==MT.TOP)&&t.x==e.x+e.width&&(e.width+=t.width);if(t.dockPosition==MT.TOP)for(var o=0;o<this.panels.length;o++)e=this.panels[o],(e.dockPosition==MT.LEFT||e.dockPosition==MT.RIGHT)&&t.y+t.height==e.y&&(e.y-=t.height,e.height+=t.height);if(t.dockPosition==MT.BOTTOM)for(var o=0;o<this.panels.length;o++)e=this.panels[o],(e.dockPosition==MT.LEFT||e.dockPosition==MT.RIGHT)&&t.y==e.y+e.height&&(e.height+=t.height)}t.loadBox(),t.dockPosition=MT.NONE,(t.x>this.events.mouse.x||t.x+t.width<this.events.mouse.x)&&(t.x=this.events.mouse.x-.3*t.width),this.moveDocks()}},loadLayout:function(t,e){return void 0!=e&&(this.saveSlot=e),console.log("loading from slot",this.saveSlot),(t=t||JSON.parse(localStorage.getItem("ui-"+this.saveSlot)))?(this._loadLayout(t,!0),this._loadLayout(t,!0),this._loadLayout(t,!0),this.updateZ(),void this.reloadSize()):void this.resetLayout(this.saveSlot)},_loadLayout:function(t,e){this._centerPanels.length=0;var i=null,s=null;this.box=t.__box,this.oldScreenSize.width=t.__oldScreenSize.width,this.oldScreenSize.height=t.__oldScreenSize.height;var o=[];if(e)for(var n=0;n<this.panels.length;n++)this.panels[n].hasClass("animated")&&(o.push(this.panels[n]),this.panels[n].removeClass("animated"));var a=[];for(var n in t)i=t[n],i.name=n,s=this.getByName(n),s&&(s.reset(i),a.push({p:s,o:i}));for(var h=!1,l=null,n=0;n<a.length;n++)if(s=a[n].p,i=a[n].o,s.savedBox=i.savedBox,i.isVisible){h=!1;for(var r=0;r<i.joints.length;r++)l=this.getByName(i.joints[r]),l!=s?h?s.addJoint(l):l.addJoint(s):h=!0}else s.hide(!1,!0);for(var n=0;n<a.length;n++){s=a[n].p,i=a[n].o;var c=this.getByName(i.bottom);c&&(c.isVisible||(c=c.getVisibleJoint())),c&&s.joinBottom(c,!0),c=this.getByName(i.top),c&&(c.isVisible||(c=c.getVisibleJoint())),c&&s.joinTop(c,!0),s.isVisible&&s.header.showTabs(),s.dockPosition=i.dockPosition,i.dockPosition==MT.CENTER&&this.setCenter(s)}for(var n=0;n<o.length;n++)o[n].addClass("animated")},resetLayout:function(t){var e={__box:{x:40,y:29,width:719,height:612},__oldScreenSize:{width:990,height:938},SourceEditor:{x:40,y:29,width:679,height:583,dockPosition:5,isVisible:!1,isDocked:!0,savedBox:{x:0,y:0,width:0,height:0}},Settings:{x:719,y:580.125,width:271,height:357.875,dockPosition:2,isVisible:!0,isDocked:!0,savedBox:{x:0,y:0,width:250,height:400},joints:["Settings","physics","userData"],top:"Objects",bottom:null},Assets:{x:719,y:29,width:271,height:193.25,dockPosition:2,isVisible:!0,isDocked:!0,savedBox:{x:0,y:0,width:250,height:400},joints:[],top:null,bottom:"Objects"},assetPreview:{x:40,y:612,width:679,height:300,dockPosition:4,isVisible:!0,isDocked:!0,savedBox:{x:0,y:0,width:250,height:400},joints:[],top:null,bottom:null},Objects:{x:719,y:222.25,width:271,height:357.875,dockPosition:2,isVisible:!0,isDocked:!0,savedBox:{x:0,y:0,width:250,height:400},joints:[],top:"Assets",bottom:"Settings"},"Map editor":{x:40,y:29,width:679,height:583,dockPosition:5,isVisible:!0,isDocked:!0,savedBox:{x:0,y:0,width:0,height:0},joints:["Map editor","SourceEditor"],top:null,bottom:null},toolbox:{x:0,y:29,width:40,height:909,dockPosition:1,isVisible:!0,isDocked:!0,savedBox:{x:0,y:0,width:40,height:400},joints:[],top:null,bottom:null},Project:{x:0,y:0,width:990,height:29,dockPosition:3,isVisible:!0,isDocked:!0,savedBox:{x:0,y:0,width:250,height:29},joints:[],top:null,bottom:null},physics:{x:719,y:580.125,width:271,height:357.875,dockPosition:2,isVisible:!1,isDocked:!0,savedBox:{x:0,y:0,width:0,height:0},joints:["Settings","physics","userData"],top:"Objects",bottom:null},userData:{x:719,y:580.125,width:271,height:357.875,dockPosition:2,isVisible:!1,isDocked:!0,savedBox:{x:0,y:0,width:0,height:0},joints:["Settings","physics","userData"],top:"Objects",bottom:null},"Map Manager":{x:40,y:912,width:679,height:26,dockPosition:4,isVisible:!0,isDocked:!0,savedBox:{x:0,y:0,width:250,height:26},joints:[],top:null,bottom:null},color:{x:656,y:411,width:305,height:200,dockPosition:0,isVisible:!1,isDocked:!1,savedBox:{x:0,y:0,width:305,height:200},joints:[],top:null,bottom:null},Text:{x:40,y:29,width:679,height:30,dockPosition:0,isVisible:!1,isDocked:!1,savedBox:{x:0,y:0,width:944,height:30},joints:[],top:null,bottom:null},"file-list-holder":{x:0,y:0,width:0,height:0,dockPosition:0,isVisible:!0,isDocked:!0,savedBox:{x:0,y:0,width:250,height:400},joints:[],top:null,bottom:null},"source-editor":{x:0,y:0,width:0,height:0,dockPosition:0,isVisible:!0,isDocked:!0,savedBox:{x:0,y:0,width:250,height:400},joints:[],top:null,bottom:null}},i=JSON.stringify(e);if(void 0!=t)localStorage.setItem("ui-"+t,i);else for(var s,o=0;o<localStorage.length;o++)s=localStorage.key(o),"ui-"==s.substring(0,3)&&localStorage.setItem(s,i);this.loadLayout()},saveLayout:function(t){if(this.refresh(),void 0!=t&&(this.saveSlot=t),console.log("saving in slot",this.saveSlot),this.isSaveAllowed){for(var e={__box:this.box,__oldScreenSize:this.oldScreenSize},i=null,s=0;s<this.panels.length;s++)i=this.panels[s],i._parent==document.body&&(e[i.name]={x:i.x,y:i.y,width:i.width,height:i.height,dockPosition:i.dockPosition,isVisible:i.isVisible,savedBox:i.savedBox,isDocked:i.isDocked},i.isVisible&&(e[i.name].joints=i.getJointNames(),e[i.name].top=i.top?i.top.name:null,e[i.name].bottom=i.bottom?i.bottom.name:null));var o=JSON.stringify(e);localStorage.setItem("ui-"+this.saveSlot,o)}},getSavedLayout:function(){console.log("toLoad = ",localStorage.getItem("ui-"+this.saveSlot))},oldScreenSize:{width:0,height:0},reloadSize:function(){var t=window.innerWidth-this.oldScreenSize.width,e=window.innerHeight-this.oldScreenSize.height;this.oldScreenSize.width=window.innerWidth,this.oldScreenSize.height=window.innerHeight,this.box.width+=t,this.box.height+=e;for(var i=null,s=0;s<this.panels.length;s++)i=this.panels[s],i.setTopBottom("justUpdated",!1);for(var s=0;s<this.panels.length;s++)if(i=this.panels[s],!i.justUpdated){if(i.dockPosition==MT.LEFT||i.dockPosition==MT.RIGHT){if(i.bottom)continue;i.height+=e}i.dockPosition==MT.BOTTOM&&(i.y+=e),(i.dockPosition==MT.TOP||i.dockPosition==MT.BOTTOM)&&(i.width+=t),i.dockPosition==MT.RIGHT&&(i.x+=t),i.setAll("justUpdated",!0),i.setTopBottom("justUpdated",!0)}this.moveDocks()},getByName:function(t){for(var e=0;e<this.panels.length;e++)if(this.panels[e].name==t)return this.panels[e];return null}}),MT.namespace("core"),MT.require("plugins.list"),MT.require("core.keys"),MT.require("ui.Popup"),MT.require("ui.Fieldset"),MT.require("plugins.HelpAndSupport"),MT.require("plugins.FontManager"),MT.require("plugins.MapManager"),MT.require("plugins.SourceEditor"),MT.require("plugins.GamePreview"),MT.require("plugins.Physics"),MT.require("plugins.UserData"),MT.require("plugins.TooltipManager"),MT.require("plugins.Notification"),MT.DROP="drop",MT.extend("core.BasicPlugin").extend("core.Emitter")(MT.core.Project=function(t,e){MT.core.BasicPlugin.call(this,"Project"),this.data={backgroundColor:"#666666",sourceEditor:{fontSize:12}},window.pp=this,this.plugins={},this.pluginsEnabled=["AssetManager","ObjectManager","MapEditor","Tools","Settings","Export","UndoRedo","DataLink","Analytics","HelpAndSupport","FontManager","MapManager","SourceEditor","GamePreview","Physics","UserData","TooltipManager","Notification"];for(var i=0,s="";i<this.pluginsEnabled.length;i++)s=this.pluginsEnabled[i],this.plugins[s.toLowerCase()]=new MT.plugins[s](this);this.am=this.plugins.assetmanager,this.om=this.plugins.objectmanager,this.map=this.plugins.mapeditor,this.ui=t,this.sub="","us."==window.location.hostname.substring(0,3)&&(this.sub="us"),this.initSocket(e)},{a_maintenance:function(t){var e=t.seconds,i="System will go down for maintenance in ",s="<p>All your current work in progress has been saved.</p><p>Please wait. Editor will reload automatically.</p>";"new"==t.type&&(i="System is being maintained. Will be back in ",s="<p>Please wait. Editor will reload automatically.</p>");var o=new MT.ui.Popup("Maintenance",i+'<span style="color: red">'+e+"</span> seconds."+s),n=window.setInterval(function(){return e--,0>e?void window.clearInterval(n):void(o.content.innerHTML=i+'<span style="color: red">'+e+"</span> seconds."+s)},1e3)},a_selectProject:function(t){this.id=t.id,window.location.hash=t.id,this.path="data/projects/"+t.id,this.a_getProjectInfo(t),this.initUI(this.ui),this.initPlugins(),this.setUpData(),localStorage.setItem(t.id,JSON.stringify(t)),this.copyPopup&&(this.copyPopup.hide(),this.copyPopup=null)},setUpData:function(){document.body.style.backgroundColor=this.data.backgroundColor,this.emit("updateData",this.data)},a_newProject:function(){this.newProject()},a_needUpdate:function(){var t=this,e=new MT.ui.Popup("Update Project","");e.removeHeader(),e.el.style.width="50%",e.el.style.height="40%",e.el.style["min-height"]="200px",e.el.style.top="20%";var i=new MT.ui.Panel("Update Project");i.hide().show(e.content).fitIn(),i.removeBorder();var s=document.createElement("div");s.innerHTML="Enter project title",s.style.margin="20px 10px",i.content.el.appendChild(s);var o={title:"New Game",namespace:"NewGame"},n=new MT.ui.Input(this.ui,{key:"title",type:"text"},o),a=new MT.ui.Input(this.ui,{key:"namespace",type:"text"},o);n.show(i.content.el),a.show(i.content.el),n.enableInput(),n.on("change",function(t){a.setValue(t.replace(/\W/g,""))}),e.addButton("Update",function(){t.send("updateProject",o),e.hide()})},a_getProjectInfo:function(t){for(var e in t)this.data[e]=t[e]},copyPopup:null,a_copyInProgress:function(){var t="<p>Please wait. Editor will load a project automatically.</p>",e=new MT.ui.Popup("Copy in progress",t);e.showClose(),this.copyPopup=e},newProject:function(){var t=this,e=new MT.ui.Popup("Welcome to MightyEditor","");e.y=.45*(window.innerHeight-510),e.showClose(),e.bg.style.backgroundColor="rgba(10,10,10,0.3)",e.addClass("starting-popup");var i=document.createElement("div");e.content.appendChild(i),i.className="logo";var t=this,s=new MT.ui.Button("Create New Project","new-project",null,function(){t.newProjectNext(),e.off(),e.hide()}),o=new MT.ui.Button("About MightyEditor","docs",null,function(){var t=window.open("about:blank","_newTab");t.opener=null,t.location.href="http://mightyfingers.com/editor-features/"});s.show(e.content),o.show(e.content);var n=document.createElement("div");e.content.appendChild(n),n.innerHTML='<span class="label">Recent Projects</span>',n.className="project-list";var a=document.createElement("div");a.className="list-content";for(var h=[],l=null,r=0;r<localStorage.length;r++)key=localStorage.key(r),"ui"!==key.substring(0,2)&&"UndoRedo"!=key&&(l=JSON.parse(localStorage.getItem(key)),h.push(l.id?l:{id:key,title:key}));for(var c,r=0;r<h.length;r++)c=document.createElement("div"),c.className="projectItem",c.innerHTML=h[r].title+" ("+h[r].id+') <span class="remove"></span>',c.project=h[r].id,a.appendChild(c);a.onclick=function(t){return"remove"==t.target.className?(localStorage.removeItem(t.target.parentNode.project),void t.target.parentNode.parentNode.removeChild(t.target.parentNode)):void(t.target.project&&(t.preventDefault(),window.location.hash=t.target.project,window.location.reload()))},0==h.length&&""!=this.sub&&(a.innerHTML='<p>If you can\'t see you recent projects - try to click <a href="http://mightyeditor.mightyfingers.com/#no-redirect">here</a></p>'),n.appendChild(a),e.on("close",function(){t.newProjectNext()})},newProjectNext:function(){var t=this,e=new MT.ui.Popup("New Project","");e.removeHeader(),e.el.style.width="50%",e.el.style.height="40%",e.el.style["min-height"]="200px",e.el.style.top="20%";var i=new MT.ui.Panel("New Project");i.hide().show(e.content).fitIn(),i.removeBorder();var s=document.createElement("div");s.innerHTML="Enter project title",s.style.margin="20px 10px",i.content.el.appendChild(s);var o={title:"New Game",namespace:"NewGame"},n=new MT.ui.Input(this.ui,{key:"title",type:"text"},o),a=new MT.ui.Input(this.ui,{key:"namespace",type:"text"},o);n.show(i.content.el),a.show(i.content.el),n.enableInput(),n.on("change",function(t){a.setValue(t.replace(/\W/g,""))}),e.addButton("Create",function(){t.send("newProject",o),e.hide()})},loadProject:function(t){this.send("loadProject",t)},initUI:function(t){var e=this;this.ui=t,this.panel=t.createPanel("Project"),this.panel.height=29,this.panel.removeHeader(),this.panel.isDockable=!0,this.panel.addClass("top"),t.dockToTop(this.panel),this.createSettings(),this.panel.addButton(null,"logo",function(){e.setPop.show()}),this.list=new MT.ui.List([{label:"Home",className:"",cb:function(){window.location=window.location.toString().split("#")[0]}},{label:"Clone (eu)",className:"",cb:function(){e.clone(e.sub)}},{label:"Clone (us)",className:"",cb:function(){e.clone(e.sub,!0)}}],t,!0);this.button=this.panel.addButton("Project",null,function(t){t.stopPropagation(),e.showList()});this.ui.events.on("hashchange",function(){console.log("hash changed","reload?"),window.location.reload()})},clone:function(t,e){if(""==t&&!e)return window.location=window.location.toString()+"-copy",void window.location.reload();if("us"==t&&e)return window.location=window.location.toString()+"-copy",void window.location.reload();if(""==t&&e){var i=window.location.toString()+"-copy";return i=i.replace("://","://us."),void(window.location=i)}if("us"==t&&!e){var i=window.location.toString()+"-copy";return i=i.replace("://us.","://"),void(window.location=i)}},createSettings:function(){var t,e=this;this.setPop=new MT.ui.Popup("",""),this.setPop.removeHeader(),this.setPop.style.height="50%",this.setPop.style.width="70%",this.setPop.y=200,this.setInputs={bgColor:new MT.ui.Input(this.ui,{key:"backgroundColor",type:"color"},this.data),srcEdFontSize:new MT.ui.Input(this.ui,{key:"fontSize",type:"number"},this.data.sourceEditor)},this.setInputs.bgColor.on("change",function(t){document.body.style.backgroundColor=t}),this.setInputs.srcEdFontSize.on("change",function(){e.setUpData()}),this.setFields={ui:new MT.ui.Fieldset("UI"),sourceEditor:new MT.ui.Fieldset("SourceEditor")},this.setPop.on("show",function(){console.log("pop show"),t=JSON.stringify(e.data)}),this.setPanel=new MT.ui.Panel("Editor Properties"),this.setPanel.removeBorder(),this.setPanel.hide().show(this.setPop.content).fitIn(),this.setPop.hide(),this.setPop.addButton("Save",function(){e.setPop.hide(),e.send("saveProjectInfo",e.data),e.emit("updateData",e.data)}),this.setPop.addButton("Cancel",function(){e.setPop.hide(),e.data=JSON.parse(t),e.setInputs.bgColor.setValue(e.data.backgroundColor),e.setInputs.srcEdFontSize.setValue(e.data.sourceEditor.fontSize),e.setUpData()}),this.setButtons={resetLayout:new MT.ui.Button("Reset Layout","",null,function(){e.ui.resetLayout()})},this.setInputs.bgColor.show(this.setFields.ui.el),this.setButtons.resetLayout.show(this.setFields.ui.el),this.setInputs.srcEdFontSize.show(this.setFields.sourceEditor.el);for(var i in this.setFields)this.setPanel.content.el.appendChild(this.setFields[i].el),this.setFields[i].addClass("full")},showList:function(){this.list.width=150,this.list.y=this.button.el.offsetHeight,this.list.x=this.button.el.offsetLeft-5,this.list.el.style.bottom="initial",this.list.show(document.body)},initPlugins:function(){for(var t in this.plugins)this.plugins[t].initSocket&&this.plugins[t].initSocket(this.socket);for(var t in this.plugins)this.plugins[t].initUI(this.ui);
for(var t in this.plugins)this.plugins[t].installUI&&this.plugins[t].installUI(this.ui);var e=this,i=null,s="ui-dragover";this.ui.events.on("dragover",function(t){i&&MT.ui.removeClass(i,s),MT.ui.addClass(t.target,s),i=t.target});var o=function(){i&&(MT.ui.removeClass(i,s),i=null)};this.ui.events.on("dragend",o),this.ui.events.on("dragleave",o),this.ui.events.on(this.ui.events.DROP,function(t){e.handleDrop(t),o()}),this.ui.loadLayout(),this.ui.isSaveAllowed=!0},handleDrop:function(t){var e=t.dataTransfer.files;this.handleFiles(e,t.dataTransfer,t)},handleFiles:function(t,e,i){for(var s=0;s<t.length;s++)e?(entry=e.items[s].getAsEntry?e.items[s].getAsEntry():e.items[s].webkitGetAsEntry(),this.handleEntry(entry,i)):this.handleFile(t.item(s),i)},handleEntry:function(t,e){var i=this;if(t.isFile)t.file(function(s){i.readFile(s,t.fullPath,e)});else if(t.isDirectory){this.send("newFolder",t.fullPath);var s=t.createReader();s.readEntries(function(t){for(var s=0;s<t.length;s++)i.handleEntry(t[s],e)})}},handleFile:function(){},readFile:function(t,e,i){var s=this,o=new FileReader;o.onload=function(){s.emit(MT.DROP,i,{src:o.result,path:e})},o.readAsBinaryString(t)},initSocket:function(t){MT.core.BasicPlugin.initSocket.call(this,t);var e=window.location.hash.substring(1);""!=e&&"no-redirect"!=e?this.loadProject(e):this.newProject()}}),function(t){"use strict";function e(){var e=new MT.Socket,i=!1;e.on("core",function(s){if("open"==s){if(i)return void t.location.reload();n.parentNode&&n.parentNode.removeChild(n),new MT.core.Project(new MT.ui.Controller,e)}"close"==s&&(document.body.innerHTML="",i=!0)})}function i(){MT.require("core.Project"),MT.require("ui.Controller"),MT.require("Socket"),MT.onReady(e);var t=!1;"undefined"!=typeof document&&(n=new Image,n.onload=function(){t||document.body.appendChild(n)},n.src="img/icons/loadingbar.gif",n.className="loadingImage")}t.MT=createClass("MT");var s="tools.mightyfingers.com:8080";if(t.release&&(s="mightyeditor.mightyfingers.com"),t&&t.location){if(t.location.hash.indexOf("-")>0)return void i();if(t.location.host==s)if(""==t.location.hash||"u"==t.location.hash.substring(1,2)){var o=function(e,s){if(202!=s.status)return void i();var o=JSON.parse(e);"NA"==o.continent_code||"212.93.114.227"==o.ip?t.location.host="us."+t.location.host:i()};MT.loader.get("/geoip",o)}else i();else"p"==t.location.hash.substring(1,2)&&"us."==t.location.host.substring(0,3)?t.location.host=t.location.host.substring(3):i()}else i();var n}(window);
//# sourceMappingURL=MT.min.js.map